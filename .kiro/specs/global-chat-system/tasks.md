# План реализации: Система глобального чата

## Обзор

Данный план описывает пошаговую реализацию системы глобального чата для браузерной RPG игры на React. Реализация будет выполняться инкрементально с регулярными проверками работоспособности.

## Задачи

- [x] 1. Настройка инфраструктуры и базовых компонентов
  - Установить библиотеку fast-check для property-based тестирования
  - Создать файл constants/chatConstants.js с константами каналов, эмодзи, стикеров
  - Создать файл utils/chatUtils.js с утилитами (localStorage, форматирование)
  - Создать базовую структуру компонентов в папке components/Chat/
  - _Requirements: 2.1, 4.3, 4.5, 4.7, 5.2, 9.1-9.6_

- [ ] 2. Реализация базового ChatPanel и состояния
  - [x] 2.1 Создать компонент ChatPanel с управлением состоянием
    - Реализовать useState для всех состояний (channels, blockedPlayers, settings, etc.)
    - Добавить useEffect для загрузки данных из localStorage
    - Добавить useEffect для сохранения данных в localStorage
    - Реализовать функцию addMessage для добавления сообщений в каналы
    - _Requirements: 1.1, 1.5, 2.4, 5.7, 6.3, 10.8_
  
  - [ ]* 2.2 Написать property-тест для сохранения состояния
    - **Property 2: Сохранение состояния в localStorage**
    - **Validates: Requirements 1.5, 2.4, 5.7, 6.3, 10.8**

- [ ] 3. Реализация ChatToggleButton
  - [x] 3.1 Создать компонент ChatToggleButton
    - Реализовать кнопку с иконкой MessageSquare/X
    - Добавить индикатор непрочитанных сообщений (badge)
    - Добавить анимацию пульсации при новых упоминаниях
    - Реализовать обработчик onClick для переключения состояния
    - _Requirements: 1.2, 1.6, 8.1, 8.2_
  
  - [ ]* 3.2 Написать property-тест для индикатора непрочитанных
    - **Property 3: Индикатор непрочитанных сообщений**
    - **Validates: Requirements 1.6, 8.1**
  
  - [ ]* 3.3 Написать unit-тесты для ChatToggleButton
    - Тест: кнопка отображается с правильной иконкой
    - Тест: badge показывает правильное количество непрочитанных
    - Тест: анимация активируется при hasNewMentions=true
    - _Requirements: 1.2, 1.6, 8.2_

- [ ] 4. Реализация ChannelTabs
  - [x] 4.1 Создать компонент ChannelTabs
    - Отобразить вкладки для всех каналов
    - Применить цветовое кодирование для каждого канала
    - Показать счетчик непрочитанных на неактивных вкладках
    - Реализовать переключение активного канала
    - _Requirements: 2.2, 2.3, 2.5, 2.6_
  
  - [ ]* 4.2 Написать property-тест для переключения каналов
    - **Property 4: Переключение каналов**
    - **Validates: Requirements 2.3, 2.5**
  
  - [ ]* 4.3 Написать unit-тесты для ChannelTabs
    - Тест: отображаются все 3 канала (Общий, Торговля, Помощь)
    - Тест: активный канал имеет правильный стиль
    - Тест: счетчик непрочитанных отображается на неактивных каналах
    - _Requirements: 2.1, 2.2, 2.5, 2.6_

- [x] 5. Checkpoint - Базовая структура чата
  - Убедиться, что чат открывается/закрывается
  - Проверить переключение между каналами
  - Проверить сохранение состояния в localStorage
  - Спросить пользователя, если возникли вопросы


- [ ] 6. Реализация MessageList и MessageItem
  - [x] 6.1 Создать компонент MessageList
    - Реализовать фильтрацию заблокированных игроков
    - Добавить автоскролл к последнему сообщению
    - Использовать React.memo для оптимизации
    - Реализовать управление состоянием hoveredMessageId
    - _Requirements: 6.2, 12.4_
  
  - [x] 6.2 Создать компонент MessageItem
    - Отобразить аватар, имя, уровень отправителя
    - Добавить временную метку (если включено в настройках)
    - Реализовать отображение текстовых сообщений
    - Реализовать отображение стикеров
    - Реализовать отображение системных сообщений
    - Добавить выделение для сообщений с упоминаниями
    - Показать контекстное меню при наведении
    - _Requirements: 3.3, 3.4, 4.6, 7.1, 8.4, 10.3, 10.4_
  
  - [ ]* 6.3 Написать property-тест для метаданных сообщения
    - **Property 6: Добавление сообщения в канал**
    - **Validates: Requirements 3.2, 3.3, 3.4**
  
  - [ ]* 6.4 Написать property-тест для скрытия заблокированных
    - **Property 14: Скрытие заблокированных игроков**
    - **Validates: Requirements 6.2**
  
  - [ ]* 6.5 Написать property-тест для выделения упоминаний
    - **Property 20: Выделение упоминаний**
    - **Validates: Requirements 8.4**
  
  - [ ]* 6.6 Написать unit-тесты для MessageItem
    - Тест: сообщение отображает имя, уровень, аватар
    - Тест: стикер отображается как эмодзи
    - Тест: системное сообщение имеет желтый цвет
    - Тест: упоминание игрока выделяется синим фоном
    - _Requirements: 3.3, 3.4, 4.6, 8.4_

- [ ] 7. Реализация MessageInput
  - [x] 7.1 Создать компонент MessageInput
    - Реализовать поле ввода с ограничением 500 символов
    - Добавить счетчик символов
    - Реализовать кнопки эмодзи и стикеров
    - Реализовать кнопку отправки с индикатором кулдауна
    - Добавить обработку Enter для отправки
    - Реализовать debounce для ввода текста
    - _Requirements: 3.1, 3.5, 3.7, 3.8, 4.1, 12.5_
  
  - [x] 7.2 Реализовать валидацию сообщений
    - Проверка на пустые сообщения (только пробелы)
    - Проверка длины (макс. 500 символов)
    - Проверка кулдауна (3 секунды)
    - Проверка блокировки за спам
    - _Requirements: 3.5, 3.6, 3.7, 5.4, 5.5_
  
  - [ ]* 7.3 Написать property-тест для валидации длины
    - **Property 7: Валидация длины сообщения**
    - **Validates: Requirements 3.5**
  
  - [ ]* 7.4 Написать property-тест для отклонения пустых сообщений
    - **Property 8: Отклонение пустых сообщений**
    - **Validates: Requirements 3.6**
  
  - [ ]* 7.5 Написать property-тест для кулдауна
    - **Property 9: Кулдаун между сообщениями**
    - **Validates: Requirements 3.7, 3.8**
  
  - [ ]* 7.6 Написать unit-тесты для MessageInput
    - Тест: сообщение ровно 500 символов принимается
    - Тест: сообщение 501 символ отклоняется
    - Тест: пустая строка отклоняется
    - Тест: строка из пробелов отклоняется
    - Тест: кнопка отправки disabled во время кулдауна
    - _Requirements: 3.5, 3.6, 3.7, 3.8_

- [ ] 8. Реализация системы команд
  - [ ] 8.1 Реализовать обработку команд в MessageInput
    - Детекция команд (начинаются с /)
    - Парсинг команды и аргументов
    - Реализовать команду /help
    - Реализовать команду /clear
    - Реализовать команду /whisper
    - Реализовать команду /block
    - Реализовать команду /unblock
    - Обработка неверных команд
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.8_
  
  - [ ] 8.2 Реализовать автодополнение команд
    - Показать список команд при вводе /
    - Фильтровать команды по введенному префиксу
    - Реализовать выбор команды из списка
    - _Requirements: 9.7_
  
  - [ ]* 8.3 Написать property-тест для обработки команд
    - **Property 22: Обработка команд**
    - **Validates: Requirements 9.1**
  
  - [ ]* 8.4 Написать property-тест для автодополнения
    - **Property 23: Автодополнение команд**
    - **Validates: Requirements 9.7**
  
  - [ ]* 8.5 Написать property-тест для ошибки неверной команды
    - **Property 24: Ошибка неверной команды**
    - **Validates: Requirements 9.8**
  
  - [ ]* 8.6 Написать unit-тесты для команд
    - Тест: /help показывает список команд
    - Тест: /clear очищает историю чата
    - Тест: /whisper создает личное сообщение
    - Тест: /block добавляет игрока в список блокировки
    - Тест: /unblock удаляет игрока из списка блокировки
    - Тест: /invalid показывает ошибку
    - _Requirements: 9.2, 9.3, 9.4, 9.5, 9.6, 9.8_

- [ ] 9. Checkpoint - Базовая функциональность сообщений
  - Убедиться, что сообщения отправляются и отображаются
  - Проверить валидацию (длина, пустые сообщения)
  - Проверить кулдаун между сообщениями
  - Проверить работу команд
  - Спросить пользователя, если возникли вопросы

- [ ] 10. Реализация EmojiPicker и StickerPicker
  - [x] 10.1 Создать компонент EmojiPicker
    - Отобразить категории эмодзи
    - Отобразить эмодзи в сетке
    - Реализовать выбор эмодзи
    - Реализовать закрытие панели
    - _Requirements: 4.1, 4.2, 4.3, 4.7_
  
  - [ ] 10.2 Создать компонент StickerPicker
    - Отобразить категории стикеров
    - Отобразить стикеры в сетке
    - Реализовать выбор стикера
    - Реализовать закрытие панели
    - _Requirements: 4.5, 12.7_
  
  - [ ]* 10.3 Написать property-тест для вставки эмодзи
    - **Property 10: Вставка эмодзи**
    - **Validates: Requirements 4.4**
  
  - [ ]* 10.4 Написать property-тест для отображения стикеров
    - **Property 11: Отображение стикеров**
    - **Validates: Requirements 4.6**
  
  - [ ]* 10.5 Написать unit-тесты для пикеров
    - Тест: EmojiPicker отображает минимум 20 эмодзи
    - Тест: StickerPicker отображает минимум 10 стикеров
    - Тест: эмодзи группируются по категориям
    - Тест: выбор эмодзи вставляет его в поле ввода
    - Тест: выбор стикера создает сообщение типа 'sticker'
    - _Requirements: 4.3, 4.4, 4.5, 4.6, 4.7_

- [ ] 11. Реализация фильтрации и модерации
  - [ ] 11.1 Реализовать фильтр нецензурной лексики
    - Создать функцию filterProfanity
    - Заменять запрещенные слова на ***
    - Учитывать настройку profanityFilter
    - _Requirements: 5.1, 5.2, 5.3_
  
  - [ ] 11.2 Реализовать детекцию спама
    - Создать функцию detectSpam
    - Отслеживать последние 3 сообщения
    - Блокировать на 30 секунд при 3 одинаковых сообщениях
    - Показывать предупреждение о блокировке
    - _Requirements: 5.4, 5.5, 5.6_
  
  - [ ]* 11.3 Написать property-тест для фильтрации
    - **Property 12: Фильтрация нецензурной лексики**
    - **Validates: Requirements 5.1**
  
  - [ ]* 11.4 Написать property-тест для детекции спама
    - **Property 13: Детекция спама**
    - **Validates: Requirements 5.4, 5.5, 5.6**
  
  - [ ]* 11.5 Написать unit-тесты для фильтрации
    - Тест: запрещенное слово заменяется на ***
    - Тест: фильтр можно отключить в настройках
    - Тест: 3 одинаковых сообщения блокируют отправку
    - Тест: блокировка длится 30 секунд
    - Тест: показывается предупреждение о спаме
    - _Requirements: 5.1, 5.3, 5.4, 5.5, 5.6_

- [ ] 12. Реализация блокировки игроков
  - [ ] 12.1 Реализовать функции блокировки
    - Создать функцию blockPlayer
    - Создать функцию unblockPlayer
    - Добавить проверку лимита (50 игроков)
    - Показывать уведомление при блокировке
    - _Requirements: 6.1, 6.5, 6.6, 6.7_
  
  - [ ] 12.2 Интегрировать блокировку в MessageItem
    - Добавить кнопку блокировки в контекстное меню
    - Обработать клик на кнопку блокировки
    - _Requirements: 6.1, 7.5_
  
  - [ ]* 12.3 Написать property-тест для разблокировки
    - **Property 15: Разблокировка игрока**
    - **Validates: Requirements 6.5**
  
  - [ ]* 12.4 Написать property-тест для лимита блокировки
    - **Property 16: Ограничение заблокированных игроков**
    - **Validates: Requirements 6.6**
  
  - [ ]* 12.5 Написать unit-тесты для блокировки
    - Тест: блокировка добавляет игрока в список
    - Тест: разблокировка удаляет игрока из списка
    - Тест: нельзя заблокировать более 50 игроков
    - Тест: показывается уведомление при блокировке
    - Тест: заблокированные сообщения не отображаются
    - _Requirements: 6.1, 6.2, 6.5, 6.6, 6.7_

- [ ] 13. Реализация контекстного меню и ответов
  - [ ] 13.1 Реализовать контекстное меню в MessageItem
    - Показывать кнопки при наведении
    - Кнопка "Ответить"
    - Кнопка "Копировать"
    - Кнопка "Пожаловаться"
    - Кнопка "Блокировать"
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [ ] 13.2 Реализовать систему ответов
    - Добавить состояние replyTo в MessageInput
    - Показывать цитату в поле ввода
    - Добавлять ссылку на оригинальное сообщение
    - Отображать связь в MessageItem
    - _Requirements: 7.6, 7.7_
  
  - [ ]* 13.3 Написать property-тест для контекстного меню
    - **Property 17: Контекстное меню сообщений**
    - **Validates: Requirements 7.1, 7.2, 7.3, 7.4, 7.5**
  
  - [ ]* 13.4 Написать property-тест для ответов
    - **Property 18: Ответ на сообщение**
    - **Validates: Requirements 7.6, 7.7**
  
  - [ ]* 13.5 Написать unit-тесты для контекстного меню
    - Тест: кнопки появляются при наведении
    - Тест: кнопка "Копировать" копирует текст
    - Тест: кнопка "Ответить" устанавливает replyTo
    - Тест: ответ содержит ссылку на оригинал
    - _Requirements: 7.1, 7.2, 7.3, 7.6, 7.7_

- [ ] 14. Checkpoint - Интерактивность сообщений
  - Убедиться, что эмодзи и стикеры работают
  - Проверить фильтрацию и детекцию спама
  - Проверить блокировку игроков
  - Проверить контекстное меню и ответы
  - Спросить пользователя, если возникли вопросы


- [ ] 15. Реализация ChatSettings
  - [ ] 15.1 Создать компонент ChatSettings
    - Реализовать модальное окно настроек
    - Добавить выбор размера шрифта (маленький, средний, большой)
    - Добавить слайдер прозрачности (0-100%)
    - Добавить переключатели для всех настроек
    - Отобразить список заблокированных игроков
    - Реализовать кнопки сохранения и отмены
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7, 6.4_
  
  - [ ] 15.2 Реализовать применение настроек
    - Обновлять настройки немедленно
    - Сохранять в localStorage
    - Применять к UI без перезагрузки
    - _Requirements: 10.8, 10.9_
  
  - [ ]* 15.3 Написать property-тест для обновления настроек
    - **Property 25: Обновление настроек**
    - **Validates: Requirements 10.2, 10.3, 10.4, 10.5, 10.6, 10.7, 10.9**
  
  - [ ]* 15.4 Написать unit-тесты для ChatSettings
    - Тест: все настройки отображаются
    - Тест: изменение fontSize обновляет состояние
    - Тест: изменение opacity обновляет состояние
    - Тест: переключатели работают корректно
    - Тест: список заблокированных отображается
    - Тест: кнопка "Разблокировать" работает
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7, 6.4, 6.5_

- [ ] 16. Реализация системы уведомлений
  - [ ] 16.1 Реализовать счетчик непрочитанных
    - Увеличивать при новом сообщении в неактивном канале
    - Сбрасывать при открытии чата и переключении канала
    - Обновлять badge на кнопке чата
    - _Requirements: 8.1, 8.6_
  
  - [ ] 16.2 Реализовать детекцию упоминаний
    - Создать функцию detectMentions
    - Искать @имя_игрока в тексте
    - Помечать сообщения с упоминаниями
    - _Requirements: 8.3, 8.4_
  
  - [ ] 16.3 Реализовать звуковые уведомления
    - Создать функцию playNotificationSound
    - Воспроизводить при упоминании игрока
    - Учитывать настройку soundEnabled
    - _Requirements: 8.3, 8.5_
  
  - [ ] 16.4 Реализовать браузерные уведомления
    - Создать функцию showBrowserNotification
    - Запрашивать разрешение у пользователя
    - Показывать при новых сообщениях (чат закрыт)
    - _Requirements: 8.7_
  
  - [ ] 16.5 Реализовать обновление заголовка страницы
    - Создать функцию updatePageTitle
    - Показывать (N) при непрочитанных сообщениях
    - _Requirements: 8.7_
  
  - [ ]* 16.6 Написать property-тест для сброса непрочитанных
    - **Property 19: Сброс непрочитанных при открытии**
    - **Validates: Requirements 8.6**
  
  - [ ]* 16.7 Написать property-тест для заголовка страницы
    - **Property 21: Обновление заголовка страницы**
    - **Validates: Requirements 8.7**
  
  - [ ]* 16.8 Написать unit-тесты для уведомлений
    - Тест: непрочитанные увеличиваются при новом сообщении
    - Тест: непрочитанные сбрасываются при открытии чата
    - Тест: detectMentions находит @имя в тексте
    - Тест: звук воспроизводится при упоминании
    - Тест: звук не воспроизводится если soundEnabled=false
    - Тест: заголовок страницы обновляется с количеством
    - _Requirements: 8.1, 8.3, 8.4, 8.5, 8.6, 8.7_

- [ ] 17. Реализация генератора NPC-сообщений
  - [ ] 17.1 Создать функцию generateNPCMessage
    - Генерировать случайное имя из NPC_NAMES
    - Генерировать случайный уровень (1-50)
    - Генерировать случайный avatarId (1-15)
    - Выбирать шаблон сообщения для канала
    - Заменять плейсхолдеры на случайные значения
    - Помечать isNPC=true
    - _Requirements: 11.1, 11.3, 11.4, 11.6_
  
  - [ ] 17.2 Интегрировать генератор в ChatPanel
    - Добавить useEffect с интервалом 10-30 секунд
    - Генерировать сообщения для случайных каналов
    - Ограничивать NPC-сообщения до 50% от общего количества
    - _Requirements: 11.2, 11.5, 11.7_
  
  - [ ]* 17.3 Написать property-тест для генерации NPC
    - **Property 26: Генерация NPC-сообщений**
    - **Validates: Requirements 11.1, 11.3, 11.4, 11.6**
  
  - [ ]* 17.4 Написать property-тест для распределения по каналам
    - **Property 27: Распределение NPC по каналам**
    - **Validates: Requirements 11.5**
  
  - [ ]* 17.5 Написать property-тест для ограничения NPC
    - **Property 28: Ограничение NPC-сообщений**
    - **Validates: Requirements 11.7**
  
  - [ ]* 17.6 Написать unit-тесты для NPC-генератора
    - Тест: NPC-сообщение имеет имя из NPC_NAMES
    - Тест: NPC-сообщение имеет уровень 1-50
    - Тест: NPC-сообщение помечено isNPC=true
    - Тест: сообщение использует шаблон для своего канала
    - Тест: плейсхолдеры заменяются на значения
    - _Requirements: 11.1, 11.3, 11.4, 11.6_

- [ ] 18. Реализация ограничения истории сообщений
  - [ ] 18.1 Реализовать логику ограничения в addMessage
    - Проверять длину массива сообщений
    - Удалять самое старое при достижении 100
    - Сохранять порядок сообщений
    - _Requirements: 2.7, 12.1, 12.3_
  
  - [ ]* 18.2 Написать property-тест для ограничения истории
    - **Property 5: Ограничение истории сообщений**
    - **Validates: Requirements 2.7, 12.1, 12.3**
  
  - [ ]* 18.3 Написать unit-тесты для ограничения
    - Тест: канал с 99 сообщениями принимает новое (итого 100)
    - Тест: канал со 100 сообщениями удаляет старейшее при добавлении
    - Тест: порядок сообщений сохраняется
    - _Requirements: 2.7, 12.1, 12.3_

- [ ] 19. Checkpoint - Полная функциональность
  - Убедиться, что все компоненты работают вместе
  - Проверить настройки чата
  - Проверить уведомления
  - Проверить генерацию NPC-сообщений
  - Проверить ограничение истории
  - Спросить пользователя, если возникли вопросы

- [x] 20. Интеграция с App.jsx
  - [x] 20.1 Добавить состояние чата в App.jsx
    - Добавить useState для chatOpen
    - Загрузить начальное состояние из localStorage
    - _Requirements: 1.5_
  
  - [x] 20.2 Добавить компоненты чата в JSX
    - Импортировать ChatPanel и ChatToggleButton
    - Добавить ChatPanel в конец JSX
    - Добавить ChatToggleButton в конец JSX
    - Передать необходимые props (player, isOpen, onToggle)
    - _Requirements: 1.1, 1.2_
  
  - [x] 20.3 Реализовать функции подсчета непрочитанных
    - Создать getTotalUnreadCount
    - Создать hasNewMentions
    - Передать в ChatToggleButton
    - _Requirements: 1.6, 8.1_
  
  - [ ]* 20.4 Написать integration-тесты
    - Тест: чат открывается при клике на кнопку
    - Тест: чат закрывается при повторном клике
    - Тест: состояние сохраняется в localStorage
    - Тест: непрочитанные отображаются на кнопке
    - _Requirements: 1.2, 1.3, 1.4, 1.5, 1.6_

- [ ] 21. Оптимизация производительности
  - [ ] 21.1 Применить React.memo к компонентам
    - Обернуть MessageList в React.memo
    - Обернуть MessageItem в React.memo
    - Обернуть ChannelTabs в React.memo
    - _Requirements: 12.4_
  
  - [ ] 21.2 Оптимизировать обработчики
    - Использовать useCallback для функций
    - Использовать useMemo для вычисляемых значений
    - Добавить debounce для ввода текста
    - _Requirements: 12.5, 12.6_
  
  - [ ]* 21.3 Написать performance-тесты
    - Тест: MessageList не перерисовывается при неизменных props
    - Тест: MessageItem не перерисовывается при неизменных props
    - Тест: debounce задерживает обработку ввода
    - _Requirements: 12.4, 12.5, 12.6_

- [ ] 22. Финальное тестирование и полировка
  - [ ] 22.1 Запустить все unit-тесты
    - Убедиться, что все тесты проходят
    - Исправить failing тесты
  
  - [ ] 22.2 Запустить все property-тесты
    - Убедиться, что все property-тесты проходят (100 итераций)
    - Исправить failing property-тесты
  
  - [ ] 22.3 Ручное тестирование
    - Протестировать все функции чата вручную
    - Проверить адаптивность на мобильных устройствах
    - Проверить работу в разных браузерах
    - _Requirements: 1.7_
  
  - [ ] 22.4 Полировка UI
    - Проверить все анимации и переходы
    - Убедиться в консистентности стилей
    - Проверить доступность (accessibility)

- [ ] 23. Финальный checkpoint
  - Убедиться, что все тесты проходят
  - Проверить, что все требования выполнены
  - Провести финальное ручное тестирование
  - Спросить пользователя о готовности к деплою

## Примечания

- Задачи, помеченные `*`, являются опциональными и могут быть пропущены для более быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property-тесты валидируют универсальные свойства корректности
- Unit-тесты валидируют конкретные примеры и граничные случаи
- Все property-тесты должны выполняться минимум 100 итераций
- Каждый property-тест должен иметь комментарий с тегом: **Feature: global-chat-system, Property N: [текст]**

