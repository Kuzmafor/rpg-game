# План реализации: Система репутации с фракциями

## Обзор

Данный документ описывает пошаговый план реализации системы репутации с фракциями для браузерной RPG игры на React. План разбит на логические этапы с инкрементальной валидацией функциональности.

## Задачи

- [x] 1. Настройка базовой структуры данных и констант
  - Создать файл с константами фракций (FACTIONS)
  - Создать константы уровней репутации (REPUTATION_LEVELS)
  - Расширить модель данных игрока для поддержки репутации
  - _Requirements: 1.3, 1.4, 1.5, 1.6, 2.1, 2.4_

- [ ] 2. Реализация основных функций управления репутацией
  - [x] 2.1 Создать функцию getReputationLevel()
    - Реализовать логику определения уровня по значению репутации
    - Обработать граничные случаи (минимум/максимум)
    - _Requirements: 2.2, 2.5_
  
  - [ ]* 2.2 Написать property-тест для getReputationLevel()
    - **Property 1: Определение уровня репутации**
    - **Validates: Requirements 2.2, 2.5**
  
  - [x] 2.3 Создать функцию updateFactionReputation()
    - Реализовать обновление репутации с учетом ограничений
    - Реализовать логику конфликтов фракций
    - Добавить уведомления о повышении уровня
    - _Requirements: 2.6, 3.3, 6.2_
  
  - [ ]* 2.4 Написать property-тесты для updateFactionReputation()
    - **Property 2: Независимость репутации фракций**
    - **Property 3: Конфликт фракций**
    - **Validates: Requirements 2.6, 6.2**
  
  - [ ]* 2.5 Написать unit-тесты для граничных случаев репутации
    - Тест минимального значения (-12000)
    - Тест максимального значения (999999)
    - Тест переходов между уровнями
    - _Requirements: 2.2, 2.5_

- [ ] 3. Checkpoint - Проверка базовой системы репутации
  - Убедиться, что все тесты проходят
  - Проверить корректность расчета уровней
  - Спросить пользователя, если возникли вопросы

- [ ] 4. Реализация системы заданий фракций
  - [x] 4.1 Создать константы заданий (FACTION_QUESTS)
    - Добавить задания для всех 5 фракций
    - Включить различные типы заданий
    - Добавить ежедневные задания
    - _Requirements: 3.1, 3.6, 7.1_
  
  - [x] 4.2 Создать функцию canAcceptQuest()
    - Реализовать проверку уровня репутации
    - Проверить статус выполнения задания
    - Проверить ежедневные задания
    - _Requirements: 3.4, 6.4_
  
  - [ ]* 4.3 Написать property-тест для canAcceptQuest()
    - **Property 6: Проверка уровня репутации для заданий**
    - **Validates: Requirements 3.4, 6.4**
  
  - [x] 4.4 Создать функцию completeFactionQuest()
    - Реализовать выдачу наград (золото, опыт, предметы)
    - Обновить репутацию с учетом бонусов
    - Отметить задание как выполненное
    - Добавить обработку ошибок
    - _Requirements: 3.3, 3.5, 3.7, 7.3_
  
  - [ ]* 4.5 Написать property-тесты для completeFactionQuest()
    - **Property 4: Выполнение задания увеличивает репутацию**
    - **Property 5: Выдача наград при выполнении задания**
    - **Property 7: Отметка выполненных заданий**
    - **Validates: Requirements 3.3, 3.5, 3.7, 7.3**

- [ ] 5. Реализация системы ежедневных заданий
  - [ ] 5.1 Создать функцию checkDailyReset()
    - Реализовать проверку времени с lastDailyReset
    - Сбросить статус ежедневных заданий
    - Обновить lastDailyReset
    - _Requirements: 7.2, 7.6_
  
  - [ ]* 5.2 Написать property-тест для checkDailyReset()
    - **Property 11: Сброс ежедневных заданий**
    - **Validates: Requirements 7.2, 7.6**
  
  - [ ] 5.3 Создать функцию getTimeUntilReset()
    - Рассчитать оставшееся время до сброса
    - Вернуть часы и минуты
    - _Requirements: 7.4_
  
  - [ ]* 5.4 Написать property-тест для getTimeUntilReset()
    - **Property 12: Расчет времени до сброса**
    - **Validates: Requirements 7.4**

- [ ] 6. Checkpoint - Проверка системы заданий
  - Убедиться, что все тесты проходят
  - Проверить корректность выполнения заданий
  - Спросить пользователя, если возникли вопросы


- [ ] 7. Реализация системы наград и торговца
  - [x] 7.1 Создать константы наград (FACTION_REWARDS)
    - Добавить минимум 5 наград для каждой фракции
    - Включить различные типы наград
    - _Requirements: 4.1, 4.5, 4.6_
  
  - [x] 7.2 Создать функцию getFactionMerchantItems()
    - Фильтровать награды по уровню репутации
    - Вернуть доступные товары
    - _Requirements: 4.2, 5.1, 5.6_
  
  - [ ]* 7.3 Написать property-тест для getFactionMerchantItems()
    - **Property 8: Доступность наград по уровню репутации**
    - **Validates: Requirements 4.2, 5.6**
  
  - [x] 7.4 Создать функцию getReputationDiscount()
    - Рассчитать скидку на основе уровня репутации
    - Вернуть значение от 0 до 0.20
    - _Requirements: 5.5_
  
  - [ ]* 7.5 Написать property-тест для getReputationDiscount()
    - **Property 9: Расчет скидки по репутации**
    - **Validates: Requirements 5.5**
  
  - [x] 7.6 Создать функцию purchaseFactionReward()
    - Проверить наличие золота и репутации
    - Применить скидку
    - Списать золото и добавить предмет
    - Добавить обработку ошибок
    - _Requirements: 4.4, 5.4_
  
  - [ ]* 7.7 Написать property-тест для purchaseFactionReward()
    - **Property 10: Покупка награды у торговца**
    - **Validates: Requirements 5.4**
  
  - [ ]* 7.8 Написать unit-тесты для обработки ошибок покупки
    - Тест недостаточного золота
    - Тест недостаточной репутации
    - Тест успешной покупки со скидкой
    - _Requirements: 4.4, 5.4, 5.5_

- [ ] 8. Реализация UI компонентов
  - [x] 8.1 Создать компонент ReputationBar
    - Отобразить прогресс-бар репутации
    - Показать текущий уровень и значение
    - Применить цветовое кодирование
    - _Requirements: 2.3, 2.4, 10.3_
  
  - [ ]* 8.2 Написать property-тест для ReputationBar
    - **Property 17: Прогресс-бар репутации**
    - **Validates: Requirements 10.3**
  
  - [x] 8.3 Создать компонент FactionCard
    - Отобразить информацию о фракции
    - Показать иконку и цветовую схему
    - Отобразить текущую репутацию
    - Показать краткие преимущества
    - _Requirements: 1.1, 1.2, 1.5, 1.6, 10.5_
  
  - [x] 8.4 Создать компонент FactionScreen
    - Отобразить список всех фракций
    - Использовать FactionCard для каждой фракции
    - Добавить обработчик клика для открытия деталей
    - _Requirements: 1.1, 10.1_
  
  - [ ]* 8.5 Написать unit-тесты для UI компонентов
    - Тест рендеринга FactionScreen
    - Тест рендеринга FactionCard
    - Тест рендеринга ReputationBar
    - _Requirements: 1.1, 1.2, 10.1, 10.3_

- [ ] 9. Реализация детального экрана фракции
  - [x] 9.1 Создать компонент FactionDetailScreen
    - Добавить заголовок с информацией о фракции
    - Отобразить текущую репутацию
    - Создать систему вкладок (Обзор, Задания, Награды, Торговец)
    - _Requirements: 10.2_
  
  - [x] 9.2 Создать компонент FactionOverview
    - Отобразить полное описание фракции
    - Показать все преимущества
    - Отобразить информацию о конфликтах
    - _Requirements: 1.6, 6.6, 10.6_
  
  - [x] 9.3 Создать компонент FactionQuests
    - Отобразить список доступных заданий
    - Показать описание и награды
    - Добавить индикаторы ежедневных заданий
    - Отобразить таймер до сброса
    - Добавить предупреждения о конфликтах
    - _Requirements: 3.2, 6.3, 7.4, 7.5, 10.7_
  
  - [x] 9.4 Создать компонент FactionQuestCard
    - Отобразить информацию о задании
    - Показать прогресс выполнения
    - Добавить кнопку выполнения
    - Обработать клик на выполнение
    - _Requirements: 3.2_
  
  - [x] 9.5 Создать компонент FactionRewards
    - Отобразить список наград
    - Показать требования к репутации
    - Отметить заблокированные награды
    - _Requirements: 4.3, 5.3_
  
  - [x] 9.6 Создать компонент FactionMerchant
    - Отобразить ассортимент торговца
    - Показать цены со скидками
    - Добавить кнопки покупки
    - Обработать покупку предметов
    - _Requirements: 5.2, 5.3, 5.4_

- [ ] 10. Checkpoint - Проверка UI компонентов
  - Убедиться, что все компоненты рендерятся корректно
  - Проверить навигацию между экранами
  - Спросить пользователя, если возникли вопросы

- [ ] 11. Интеграция с существующими системами
  - [ ] 11.1 Интегрировать с системой боя
    - Модифицировать handleEnemyDefeated()
    - Добавить проверку врагов, связанных с фракциями
    - Обновить репутацию при победе
    - Проверить прогресс заданий на убийство
    - _Requirements: 9.1_
  
  - [ ]* 11.2 Написать property-тест для интеграции с боем
    - **Property 15: Интеграция с системой боя**
    - **Validates: Requirements 9.1**
  
  - [ ] 11.3 Интегрировать с системой крафта
    - Модифицировать handleItemCrafted()
    - Добавить репутацию за крафт
    - Проверить прогресс заданий на крафт
    - _Requirements: 9.2, 9.3_
  
  - [ ]* 11.4 Написать property-тест для интеграции с крафтом
    - **Property 16: Интеграция с системой крафта**
    - **Validates: Requirements 9.2**
  
  - [ ] 11.5 Интегрировать с системой сбора ресурсов
    - Модифицировать handleResourceCollected()
    - Проверить прогресс заданий на сбор
    - _Requirements: 9.3_
  
  - [ ] 11.6 Добавить информацию о репутации в профиль игрока
    - Отобразить репутацию со всеми фракциями
    - Показать количество выполненных заданий
    - _Requirements: 9.6_
  
  - [ ]* 11.7 Написать интеграционные тесты
    - Тест интеграции с боем
    - Тест интеграции с крафтом
    - Тест интеграции с ресурсами
    - _Requirements: 9.1, 9.2, 9.3_

- [ ] 12. Реализация системы достижений фракций
  - [ ] 12.1 Создать константы достижений (FACTION_ACHIEVEMENTS)
    - Добавить достижения для различных категорий
    - Включить достижения за уровни репутации
    - Включить достижения за количество заданий
    - _Requirements: 8.1, 8.2, 8.3, 8.4_
  
  - [ ] 12.2 Создать функцию checkFactionAchievements()
    - Проверить достижения по уровню репутации
    - Проверить достижения по количеству заданий
    - Разблокировать достижения
    - _Requirements: 8.2, 8.4_
  
  - [ ]* 12.3 Написать property-тесты для checkFactionAchievements()
    - **Property 13: Разблокировка достижений по уровню репутации**
    - **Property 14: Разблокировка достижений по количеству заданий**
    - **Validates: Requirements 8.2, 8.4**
  
  - [ ] 12.4 Интегрировать проверку достижений
    - Вызывать checkFactionAchievements() после выполнения задания
    - Вызывать после обновления репутации
    - Выдавать награды за достижения
    - _Requirements: 8.5_
  
  - [ ] 12.5 Добавить отображение достижений фракций
    - Интегрировать в существующий экран достижений
    - Показать прогресс достижений
    - _Requirements: 8.6_

- [ ] 13. Реализация системы сохранения и миграции
  - [x] 13.1 Создать функцию migrateFactionData()
    - Инициализировать репутацию для новых сохранений
    - Добавить поля для заданий и ежедневных заданий
    - Обеспечить обратную совместимость
    - _Requirements: 1.4_
  
  - [x] 13.2 Интегрировать миграцию в loadGame()
    - Вызывать migrateFactionData() при загрузке
    - Обработать ошибки миграции
  
  - [ ] 13.3 Обновить функцию saveGame()
    - Сохранять данные репутации
    - Сохранять выполненные задания
    - Сохранять ежедневные задания
  
  - [ ]* 13.4 Написать unit-тесты для сохранения
    - Тест сохранения данных фракций
    - Тест загрузки данных фракций
    - Тест миграции старых сохранений
    - _Requirements: 1.4_

- [ ] 14. Checkpoint - Проверка интеграции
  - Убедиться, что все интеграции работают корректно
  - Проверить сохранение и загрузку данных
  - Спросить пользователя, если возникли вопросы

- [ ] 15. Добавление навигации и финальная интеграция
  - [x] 15.1 Добавить пункт "Фракции" в главное меню
    - Добавить иконку и название
    - Настроить навигацию к FactionScreen
  
  - [ ] 15.2 Добавить уведомления о репутации
    - Уведомление при повышении уровня
    - Уведомление при выполнении задания
    - Уведомление о конфликтах фракций
    - _Requirements: 10.4_
  
  - [ ] 15.3 Настроить автоматическую проверку ежедневных заданий
    - Вызывать checkDailyReset() при загрузке игры
    - Вызывать периодически во время игры
    - _Requirements: 7.2_
  
  - [ ] 15.4 Добавить валидацию данных
    - Валидировать ID фракций
    - Валидировать значения репутации
    - Валидировать ID заданий
  
  - [ ]* 15.5 Написать unit-тесты для валидации
    - Тест validateFactionId()
    - Тест validateReputationValue()
    - Тест validateQuestId()

- [ ] 16. Написание property-тестов для структуры данных
  - [ ]* 16.1 Написать property-тесты для констант
    - **Property 18: Наличие минимального количества фракций**
    - **Property 19: Наличие минимального количества заданий**
    - **Property 20: Наличие минимального количества наград**
    - **Property 21: Инициализация репутации**
    - **Property 22: Структура данных фракции**
    - **Property 23: Структура уровней репутации**
    - **Property 24: Разнообразие типов заданий**
    - **Property 25: Разнообразие типов наград**
    - **Validates: Requirements 1.3, 1.4, 1.5, 1.6, 2.1, 2.4, 3.1, 3.6, 4.5, 4.6**

- [ ] 17. Финальное тестирование и полировка
  - [ ]* 17.1 Запустить все unit-тесты
    - Убедиться, что все тесты проходят
    - Исправить найденные ошибки
  
  - [ ]* 17.2 Запустить все property-тесты
    - Убедиться, что все property-тесты проходят (минимум 100 итераций)
    - Исправить найденные ошибки
  
  - [ ]* 17.3 Провести интеграционное тестирование
    - Протестировать полный цикл: выполнение заданий → повышение репутации → покупка наград
    - Протестировать конфликты фракций
    - Протестировать ежедневные задания
  
  - [ ] 17.4 Оптимизировать производительность
    - Добавить мемоизацию для getFactionMerchantItems()
    - Добавить мемоизацию для доступных заданий
    - Проверить производительность рендеринга
  
  - [ ] 17.5 Провести финальную проверку UI/UX
    - Проверить все экраны на корректность отображения
    - Проверить анимации и переходы
    - Проверить адаптивность на разных размерах экрана

- [ ] 18. Checkpoint - Финальная проверка
  - Убедиться, что все тесты проходят
  - Проверить, что все требования выполнены
  - Спросить пользователя о готовности к релизу

## Примечания

- Задачи, отмеченные `*`, являются опциональными и могут быть пропущены для более быстрого MVP
- Каждый property-тест должен выполняться минимум 100 итераций
- Все property-тесты должны быть помечены комментарием с номером свойства из документа дизайна
- Checkpoint задачи служат для проверки прогресса и получения обратной связи от пользователя
- Рекомендуется выполнять задачи последовательно для обеспечения инкрементальной валидации
