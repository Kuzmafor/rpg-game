import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { 
  Footprints, 
  Sword, 
  Shield, 
  Backpack, 
  User, 
  Home, 
  Menu, 
  X, 
  Heart, 
  Zap, 
  Coins, 
  Skull, 
  Trophy,
  MapPin,
  ChevronRight,
  Sparkles,
  Scroll,
  Dna,
  Briefcase,
  Hammer,
  CheckCircle,
  Users,
  Folder,
  Swords,
  LayoutDashboard,
  Map as MapIcon,
  Flame,        
  FlaskConical, 
  Wind,         
  PartyPopper,  
  Gift,
  Crown,
  Target,
  Ghost,
  Gamepad2,
  VenetianMask,
  Bot,
  Smile,
  Box,
  Lock,
  Unlock,
  Palette,
  Image as ImageIcon,
  Map as MapIcon2,
  Calendar,
  Settings,
  Download,
  Upload,
  Save,
  RotateCcw
} from 'lucide-react';

// --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò –î–ê–ù–ù–´–ï ---

const LOCATIONS = [
  { id: 1, name: '–ó–µ–ª–µ–Ω—ã–π –õ–µ—Å', minLvl: 1, enemyPower: 1, text: '–¢–∏—Ö–∏–π –ª–µ—Å, –ø–æ–ª–Ω—ã–π –º–µ–ª–∫–æ–π –∂–∏–≤–Ω–æ—Å—Ç–∏.', resources: ['wood', 'red_herb', 'water'] },
  { id: 2, name: '–ü–µ—Å—á–∞–Ω—ã–µ –î—é–Ω—ã', minLvl: 5, enemyPower: 1.5, text: '–ñ–∞—Ä–∫–∞—è –ø—É—Å—Ç—ã–Ω—è. –û—Å—Ç–æ—Ä–æ–∂–Ω–æ, –∑–º–µ–∏!', resources: ['iron_ore', 'blue_herb', 'water'] },
  { id: 3, name: '–ú—Ä–∞—á–Ω—ã–µ –ü–µ—â–µ—Ä—ã', minLvl: 10, enemyPower: 2.5, text: '–¢–µ–º–Ω–æ –∏ —Å—ã—Ä–æ. –ó–¥–µ—Å—å –∂–∏–≤—É—Ç –≥–æ–±–ª–∏–Ω—ã.', resources: ['iron_ore', 'gold_ore', 'crystal', 'water'] },
  { id: 4, name: '–í—É–ª–∫–∞–Ω–∏—á–µ—Å–∫–∏–π –ü–∏–∫', minLvl: 20, enemyPower: 4, text: '–ó–µ–º–ª—è –¥—Ä–æ–∂–∏—Ç –ø–æ–¥ –Ω–æ–≥–∞–º–∏.', resources: ['gold_ore', 'crystal', 'blue_herb'] },
  { id: 5, name: '–ó–∞–±—Ä–æ—à–µ–Ω–Ω—ã–π –•—Ä–∞–º', minLvl: 15, enemyPower: 3.5, text: '–î—Ä–µ–≤–Ω–∏–µ —Ä—É–∏–Ω—ã, –ø–æ–ª–Ω—ã–µ —Ç–∞–π–Ω –∏ –æ–ø–∞—Å–Ω–æ—Å—Ç–µ–π.', resources: ['crystal', 'gold_ore', 'ancient_stone'] },
  { id: 6, name: '–õ–µ–¥—è–Ω—ã–µ –ü–∏–∫–∏', minLvl: 25, enemyPower: 5, text: '–°—É—Ä–æ–≤—ã–µ –≥–æ—Ä—ã, –≥–¥–µ –ø—Ä–∞–≤–∏—Ç –≤–µ—á–Ω–∞—è –∑–∏–º–∞.', resources: ['ice_crystal', 'mithril_ore', 'frozen_herb'] },
  { id: 7, name: '–¢–µ–º–Ω—ã–π –õ–µ—Å', minLvl: 18, enemyPower: 4, text: '–ú—Ä–∞—á–Ω—ã–π –ª–µ—Å, –≥–¥–µ —Å–æ–ª–Ω–µ—á–Ω—ã–π —Å–≤–µ—Ç –Ω–µ –ø—Ä–æ–Ω–∏–∫–∞–µ—Ç —Å–∫–≤–æ–∑—å –∫—Ä–æ–Ω—ã.', resources: ['dark_wood', 'shadow_herb', 'spider_silk'] },
  { id: 8, name: '–î—Ä–∞–∫–æ–Ω—å–µ –õ–æ–≥–æ–≤–æ', minLvl: 35, enemyPower: 7, text: '–õ–æ–≥–æ–≤–æ –¥—Ä–µ–≤–Ω–∏—Ö –¥—Ä–∞–∫–æ–Ω–æ–≤. –¢–æ–ª—å–∫–æ –¥–ª—è —Å–∞–º—ã—Ö —Å–º–µ–ª—ã—Ö.', resources: ['dragon_scale', 'dragon_bone', 'fire_crystal'] }
];

// –ü—É–ª—ã –≤—Ä–∞–≥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –ª–æ–∫–∞—Ü–∏–∏ (–∏–Ω–¥–µ–∫—Å—ã –≤ ENEMIES_DB)
const LOCATION_ENEMY_POOLS = {
  1: ['–ó–ª–∞—è –ö—Ä—ã—Å–∞', '–õ–µ—Å–Ω–æ–π –í–æ–ª–∫', '–ì–æ–±–ª–∏–Ω'], // –ó–µ–ª–µ–Ω—ã–π –õ–µ—Å
  2: ['–ì–æ–±–ª–∏–Ω', '–ë–∞–Ω–¥–∏—Ç', '–õ–µ—Å–Ω–æ–π –í–æ–ª–∫'], // –ü–µ—Å—á–∞–Ω—ã–µ –î—é–Ω—ã
  3: ['–ì–æ–±–ª–∏–Ω', '–°–∫–µ–ª–µ—Ç-–í–æ–∏–Ω', '–ë–∞–Ω–¥–∏—Ç', '–¢–µ–º–Ω—ã–π –ú–∞–≥'], // –ú—Ä–∞—á–Ω—ã–µ –ü–µ—â–µ—Ä—ã
  4: ['–û—Ä–∫-–í–æ–∏–Ω', '–û–≥–Ω–µ–Ω–Ω—ã–π –≠–ª–µ–º–µ–Ω—Ç–∞–ª—å', '–¢—Ä–æ–ª–ª—å', '–î—Ä–∞–∫–æ–Ω'], // –í—É–ª–∫–∞–Ω–∏—á–µ—Å–∫–∏–π –ü–∏–∫
  5: ['–°–∫–µ–ª–µ—Ç-–í–æ–∏–Ω', '–¢–µ–º–Ω—ã–π –ú–∞–≥', '–í–∞–º–ø–∏—Ä'], // –ó–∞–±—Ä–æ—à–µ–Ω–Ω—ã–π –•—Ä–∞–º
  6: ['–õ–µ–¥—è–Ω–æ–π –ì–æ–ª–µ–º', '–¢—Ä–æ–ª–ª—å', '–û—Ä–∫-–í–æ–∏–Ω'], // –õ–µ–¥—è–Ω—ã–µ –ü–∏–∫–∏
  7: ['–õ–µ—Å–Ω–æ–π –í–æ–ª–∫', '–í–∞–º–ø–∏—Ä', '–¢–µ–º–Ω—ã–π –ú–∞–≥', '–¢—Ä–æ–ª–ª—å'], // –¢–µ–º–Ω—ã–π –õ–µ—Å
  8: ['–î—Ä–∞–∫–æ–Ω', '–î—Ä–µ–≤–Ω–∏–π –î—Ä–∞–∫–æ–Ω', '–û–≥–Ω–µ–Ω–Ω—ã–π –≠–ª–µ–º–µ–Ω—Ç–∞–ª—å', '–õ–µ–¥—è–Ω–æ–π –ì–æ–ª–µ–º'] // –î—Ä–∞–∫–æ–Ω—å–µ –õ–æ–≥–æ–≤–æ
};

const PLAYER_CLASSES = [
  { 
    id: 'warrior', 
    name: '–í–æ–∏–Ω', 
    desc: '–ú–∞—Å—Ç–µ—Ä –±–ª–∏–∂–Ω–µ–≥–æ –±–æ—è. –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏–ª–∞ –∏ –∑–∞—â–∏—Ç–∞.', 
    baseStats: { str: 6, def: 3, hp: 60, energy: 20 },
    growth: { str: 2.5, def: 1.5, hp: 12 }
  },
  { 
    id: 'rogue', 
    name: '–ë—Ä–æ–¥—è–≥–∞', 
    desc: '–ë—ã—Å—Ç—Ä—ã–π –∏ —Å–º–µ—Ä—Ç–æ–Ω–æ—Å–Ω—ã–π. –í—ã—Å–æ–∫–∏–π —É—Ä–æ–Ω, —Å–ª–∞–±–∞—è –∑–∞—â–∏—Ç–∞.', 
    baseStats: { str: 8, def: 1, hp: 45, energy: 25 },
    growth: { str: 3.5, def: 0.5, hp: 8 }
  },
  { 
    id: 'guardian', 
    name: '–°—Ç—Ä–∞–∂', 
    desc: '–ñ–∏–≤–∞—è –∫—Ä–µ–ø–æ—Å—Ç—å. –û–≥—Ä–æ–º–Ω–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ –∏ –∑–∞—â–∏—Ç–∞.', 
    baseStats: { str: 3, def: 6, hp: 80, energy: 15 },
    growth: { str: 1.5, def: 3.0, hp: 20 }
  }
];

// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –±–∞–∑–∞ –∞–≤–∞—Ç–∞—Ä–æ–≤
const AVATARS_DB = [
  { id: 1, name: '–ü—É—Ç–Ω–∏–∫', icon: User, rarity: 'common', color: 'bg-blue-500' },
  { id: 2, name: '–í–æ–∏–Ω', icon: Sword, rarity: 'common', color: 'bg-red-500' },
  { id: 3, name: '–°—Ç—Ä–∞–∂', icon: Shield, rarity: 'common', color: 'bg-green-500' },
  { id: 4, name: '–ú–∞–≥', icon: Zap, rarity: 'rare', color: 'bg-purple-500' },
  { id: 5, name: '–†–∞–∑–±–æ–π–Ω–∏–∫', icon: Skull, rarity: 'rare', color: 'bg-yellow-500' },
  { id: 6, name: '–ü—Ä–∏–∑—Ä–∞–∫', icon: Ghost, rarity: 'epic', color: 'bg-indigo-500' },
  { id: 7, name: '–ö–æ—Ä–æ–ª—å', icon: Crown, rarity: 'legendary', color: 'bg-yellow-400' },
  { id: 8, name: '–ì–µ–π–º–µ—Ä', icon: Gamepad2, rarity: 'uncommon', color: 'bg-pink-500' },
  { id: 9, name: '–ê–Ω–æ–Ω–∏–º', icon: VenetianMask, rarity: 'epic', color: 'bg-slate-700' },
  { id: 10, name: '–†–æ–±–æ—Ç', icon: Bot, rarity: 'rare', color: 'bg-cyan-500' },
  { id: 11, name: '–£–ª—ã–±–∞–∫–∞', icon: Smile, rarity: 'common', color: 'bg-orange-400' },
  { id: 12, name: '–î–µ–º–æ–Ω', icon: Flame, rarity: 'legendary', color: 'bg-red-700' },
  { id: 13, name: '–¢–µ–Ω—å', icon: User, rarity: 'epic', color: 'bg-black border border-white/20' },
  { id: 14, name: '–û—Ö–æ—Ç–Ω–∏–∫', icon: Target, rarity: 'uncommon', color: 'bg-emerald-600' },
  { id: 15, name: '–¢—É—Å–æ–≤—â–∏–∫', icon: PartyPopper, rarity: 'rare', color: 'bg-fuchsia-500' },
];

const ITEMS_DB = [
  // Existing items
  { id: 1, name: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á', type: 'weapon', val: 2, cost: 10, rarity: 'common' },
  { id: 2, name: '–†–∂–∞–≤—ã–π –∫–∏–Ω–∂–∞–ª', type: 'weapon', val: 3, cost: 25, rarity: 'common' },
  { id: 3, name: '–°—Ç–∞–ª—å–Ω–æ–π –º–µ—á', type: 'weapon', val: 8, cost: 150, rarity: 'rare' },
  { id: 4, name: '–û–≥–Ω–µ–Ω–Ω—ã–π –∫–ª–∏–Ω–æ–∫', type: 'weapon', val: 20, cost: 1000, rarity: 'legendary', effect: '–®–∞–Ω—Å –ø–æ–¥–∂–µ—á—å –≤—Ä–∞–≥–∞ (+10% —É—Ä–æ–Ω–∞)' },
  { id: 5, name: '–¢—Ä—è–ø–∏—á–Ω–∞—è —Ä—É–±–∞—Ö–∞', type: 'armor', val: 1, cost: 10, rarity: 'common' },
  { id: 6, name: '–ö–æ–∂–∞–Ω–∞—è –±—Ä–æ–Ω—è', type: 'armor', val: 4, cost: 100, rarity: 'common' },
  { id: 7, name: '–õ–∞—Ç—ã —Ä—ã—Ü–∞—Ä—è', type: 'armor', val: 12, cost: 500, rarity: 'rare' },
  { id: 8, name: '–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è', type: 'consumable', val: 50, cost: 20, rarity: 'common' },
  
  // NEW WEAPONS
  { id: 9, name: '–ë—Ä–æ–Ω–∑–æ–≤—ã–π —Ç–æ–ø–æ—Ä', type: 'weapon', val: 5, cost: 50, rarity: 'uncommon' },
  { id: 10, name: '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π –º–µ—á', type: 'weapon', val: 10, cost: 200, rarity: 'uncommon' },
  { id: 11, name: '–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á', type: 'weapon', val: 12, cost: 250, rarity: 'uncommon' },
  { id: 12, name: '–≠–ª—å—Ñ–∏–π—Å–∫–∏–π –ª—É–∫', type: 'weapon', val: 15, cost: 400, rarity: 'rare' },
  { id: 13, name: '–ë–æ–µ–≤–æ–π –º–æ–ª–æ—Ç', type: 'weapon', val: 16, cost: 450, rarity: 'rare' },
  { id: 14, name: '–ü–æ—Å–æ—Ö –º–∞–≥–∞', type: 'weapon', val: 25, cost: 1500, rarity: 'epic', effect: '+5 –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏' },
  { id: 15, name: '–ö–ª–∏–Ω–æ–∫ —Ç–µ–Ω–µ–π', type: 'weapon', val: 35, cost: 3000, rarity: 'legendary', effect: '–®–∞–Ω—Å –∫—Ä–∏—Ç–∞ +10%' },
  { id: 16, name: '–î—Ä–∞–∫–æ–Ω–∏–π –∫–ª—ã–∫', type: 'weapon', val: 40, cost: 5000, rarity: 'legendary', effect: '–í–∞–º–ø–∏—Ä–∏–∑–º: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 10% –Ω–∞–Ω–µ—Å–µ–Ω–Ω–æ–≥–æ —É—Ä–æ–Ω–∞' },
  
  // NEW ARMOR
  { id: 17, name: '–ö–æ–∂–∞–Ω–∞—è –∫—É—Ä—Ç–∫–∞', type: 'armor', val: 6, cost: 80, rarity: 'common' },
  { id: 18, name: '–ö–æ–ª—å—á—É–≥–∞', type: 'armor', val: 10, cost: 180, rarity: 'uncommon' },
  { id: 19, name: '–°—Ç–∞–ª—å–Ω–∞—è –±—Ä–æ–Ω—è', type: 'armor', val: 14, cost: 350, rarity: 'rare' },
  { id: 20, name: '–ú–∏—Ñ—Ä–∏–ª–æ–≤–∞—è –±—Ä–æ–Ω—è', type: 'armor', val: 18, cost: 800, rarity: 'rare' },
  { id: 21, name: '–ó–∞—á–∞—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∞–Ω—Ç–∏—è', type: 'armor', val: 20, cost: 1200, rarity: 'epic', effect: '+10 –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –∑–¥–æ—Ä–æ–≤—å—é' },
  { id: 22, name: '–î—Ä–∞–∫–æ–Ω—å—è —á–µ—à—É—è', type: 'armor', val: 25, cost: 4000, rarity: 'legendary', effect: '+50 –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –∑–¥–æ—Ä–æ–≤—å—é' },
  { id: 23, name: '–î–æ—Å–ø–µ—Ö–∏ –±–µ—Å—Å–º–µ—Ä—Ç–Ω–æ–≥–æ', type: 'armor', val: 30, cost: 6000, rarity: 'legendary', effect: '–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è: +1 HP –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥' },
  
  // NEW CONSUMABLES
  { id: 24, name: '–ú–∞–ª–æ–µ –∑–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è', type: 'consumable', val: 30, cost: 10, rarity: 'common' },
  { id: 25, name: '–ë–æ–ª—å—à–æ–µ –∑–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è', type: 'consumable', val: 100, cost: 50, rarity: 'uncommon' },
  { id: 26, name: '–ó–µ–ª—å–µ —ç–Ω–µ—Ä–≥–∏–∏', type: 'consumable', val: 10, cost: 30, rarity: 'uncommon', effect: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é' },
  { id: 27, name: '–≠–ª–∏–∫—Å–∏—Ä —Å–∏–ª—ã', type: 'consumable', val: 10, cost: 100, rarity: 'rare', effect: '–í—Ä–µ–º–µ–Ω–Ω–æ +10 –∫ —Å–∏–ª–µ –Ω–∞ 5 —à–∞–≥–æ–≤' },
  { id: 28, name: '–≠–ª–∏–∫—Å–∏—Ä –∑–∞—â–∏—Ç—ã', type: 'consumable', val: 5, cost: 100, rarity: 'rare', effect: '–í—Ä–µ–º–µ–Ω–Ω–æ +5 –∫ –∑–∞—â–∏—Ç–µ –Ω–∞ 5 —à–∞–≥–æ–≤' },
  { id: 29, name: '–ó–µ–ª—å–µ —É–¥–∞—á–∏', type: 'consumable', val: 0, cost: 200, rarity: 'epic', effect: '–£–¥–≤–∞–∏–≤–∞–µ—Ç –Ω–∞—Ö–æ–¥–∫–∏ –Ω–∞ 10 —à–∞–≥–æ–≤' },
  { id: 30, name: '–≠–ª–∏–∫—Å–∏—Ä –±–µ—Å—Å–º–µ—Ä—Ç–∏—è', type: 'consumable', val: 0, cost: 500, rarity: 'legendary', effect: '–í–æ—Å–∫—Ä–µ—à–∞–µ—Ç –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏ —Å 50% HP (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ)' },
  
  // RESOURCES (craftable materials)
  { id: 31, name: '–ú–∏—Ñ—Ä–∏–ª–æ–≤–∞—è —Ä—É–¥–∞', type: 'resource', val: 0, cost: 150, rarity: 'rare' },
  { id: 32, name: '–î—Ä–∞–∫–æ–Ω—å—è –∫–æ—Å—Ç—å', type: 'resource', val: 0, cost: 300, rarity: 'epic' },
  { id: 33, name: '–ö—Ä–∏—Å—Ç–∞–ª–ª –¥—É—à–∏', type: 'resource', val: 0, cost: 500, rarity: 'legendary' },
  
  // FISH-BASED CONSUMABLES
  { id: 34, name: '–†—ã–±–Ω—ã–π —Å—É–ø', type: 'consumable', val: 40, cost: 15, rarity: 'common', effect: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 40 HP' },
  { id: 35, name: '–≠–ª–∏–∫—Å–∏—Ä –º–æ—Ä—è', type: 'consumable', val: 0, cost: 120, rarity: 'rare', effect: '+5 –∫ –∑–∞—â–∏—Ç–µ –Ω–∞ 10 —à–∞–≥–æ–≤' },
  { id: 36, name: '–î—Ä–∞–∫–æ–Ω–∏–π —ç–ª–∏–∫—Å–∏—Ä', type: 'consumable', val: 0, cost: 800, rarity: 'legendary', effect: '+15 –∫ —Å–∏–ª–µ –∏ +10 –∫ –∑–∞—â–∏—Ç–µ –Ω–∞ 20 —à–∞–≥–æ–≤' },
];

const ENEMIES_DB = [
  { name: '–ó–ª–∞—è –ö—Ä—ã—Å–∞', baseHp: 15, baseDmg: 2, exp: 5, gold: 3 },
  { name: '–ì–æ–±–ª–∏–Ω', baseHp: 30, baseDmg: 5, exp: 12, gold: 10 },
  { name: '–ë–∞–Ω–¥–∏—Ç', baseHp: 60, baseDmg: 10, exp: 30, gold: 25 },
  { name: '–û—Ä–∫-–í–æ–∏–Ω', baseHp: 120, baseDmg: 18, exp: 80, gold: 60 },
  { name: '–î—Ä–∞–∫–æ–Ω', baseHp: 500, baseDmg: 40, exp: 500, gold: 1000 },
  { name: '–õ–µ—Å–Ω–æ–π –í–æ–ª–∫', baseHp: 45, baseDmg: 8, exp: 18, gold: 15 },
  { name: '–°–∫–µ–ª–µ—Ç-–í–æ–∏–Ω', baseHp: 80, baseDmg: 12, exp: 35, gold: 30 },
  { name: '–¢–µ–º–Ω—ã–π –ú–∞–≥', baseHp: 100, baseDmg: 20, exp: 60, gold: 50 },
  { name: '–õ–µ–¥—è–Ω–æ–π –ì–æ–ª–µ–º', baseHp: 200, baseDmg: 25, exp: 100, gold: 80 },
  { name: '–û–≥–Ω–µ–Ω–Ω—ã–π –≠–ª–µ–º–µ–Ω—Ç–∞–ª—å', baseHp: 180, baseDmg: 30, exp: 120, gold: 100 },
  { name: '–¢—Ä–æ–ª–ª—å', baseHp: 250, baseDmg: 22, exp: 90, gold: 70 },
  { name: '–í–∞–º–ø–∏—Ä', baseHp: 150, baseDmg: 28, exp: 110, gold: 90 },
  { name: '–î—Ä–µ–≤–Ω–∏–π –î—Ä–∞–∫–æ–Ω', baseHp: 800, baseDmg: 50, exp: 800, gold: 2000 }
];

// –ü–†–û–§–ï–°–°–ò–ò
const PROFESSIONS = [
  {
    id: 'blacksmith',
    name: '–ö—É–∑–Ω–µ—Ü',
    description: '–°–æ–∑–¥–∞–µ—Ç –æ—Ä—É–∂–∏–µ –∏ –±—Ä–æ–Ω—é –∏–∑ –º–µ—Ç–∞–ª–ª–æ–≤',
    icon: Hammer,
    color: 'bg-orange-600',
    baseExp: 100,
    expGrowth: 1.5,
    unlockLevel: 5
  },
  {
    id: 'alchemist',
    name: '–ê–ª—Ö–∏–º–∏–∫',
    description: '–í–∞—Ä–∏—Ç –∑–µ–ª—å—è –∏ —ç–ª–∏–∫—Å–∏—Ä—ã',
    icon: FlaskConical,
    color: 'bg-purple-600',
    baseExp: 100,
    expGrowth: 1.5,
    unlockLevel: 5
  },
  {
    id: 'herbalist',
    name: '–¢—Ä–∞–≤–Ω–∏–∫',
    description: '–°–æ–±–∏—Ä–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–≤—ã',
    icon: Wind,
    color: 'bg-green-600',
    baseExp: 80,
    expGrowth: 1.4,
    unlockLevel: 3
  },
  {
    id: 'miner',
    name: '–®–∞—Ö—Ç–µ—Ä',
    description: '–î–æ–±—ã–≤–∞–µ—Ç —Ä—É–¥—É –∏ –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–µ –∫–∞–º–Ω–∏',
    icon: Target,
    color: 'bg-slate-600',
    baseExp: 120,
    expGrowth: 1.6,
    unlockLevel: 7
  }
];

// –†–ï–°–£–†–°–´
const RESOURCES = [
  { id: 'iron_ore', name: '–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞', icon: Box, rarity: 'common', locations: [1, 2, 3] },
  { id: 'gold_ore', name: '–ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞', icon: Coins, rarity: 'rare', locations: [3, 4] },
  { id: 'wood', name: '–î—Ä–µ–≤–µ—Å–∏–Ω–∞', icon: Box, rarity: 'common', locations: [1] },
  { id: 'red_herb', name: '–ö—Ä–∞—Å–Ω–∞—è —Ç—Ä–∞–≤–∞', icon: Wind, rarity: 'common', locations: [1, 2] },
  { id: 'blue_herb', name: '–°–∏–Ω—è—è —Ç—Ä–∞–≤–∞', icon: Wind, rarity: 'uncommon', locations: [2, 3] },
  { id: 'crystal', name: '–ö—Ä–∏—Å—Ç–∞–ª–ª', icon: Sparkles, rarity: 'rare', locations: [4, 5] },
  { id: 'water', name: '–í–æ–¥–∞', icon: FlaskConical, rarity: 'common', locations: [1, 2, 3, 4] },
  { id: 'ancient_stone', name: '–î—Ä–µ–≤–Ω–∏–π –∫–∞–º–µ–Ω—å', icon: Box, rarity: 'uncommon', locations: [5] },
  { id: 'ice_crystal', name: '–õ–µ–¥—è–Ω–æ–π –∫—Ä–∏—Å—Ç–∞–ª–ª', icon: Sparkles, rarity: 'rare', locations: [6] },
  { id: 'mithril_ore', name: '–ú–∏—Ñ—Ä–∏–ª–æ–≤–∞—è —Ä—É–¥–∞', icon: Coins, rarity: 'epic', locations: [6] },
  { id: 'frozen_herb', name: '–ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–∞—è —Ç—Ä–∞–≤–∞', icon: Wind, rarity: 'uncommon', locations: [6] },
  { id: 'dark_wood', name: '–¢–µ–º–Ω–∞—è –¥—Ä–µ–≤–µ—Å–∏–Ω–∞', icon: Box, rarity: 'uncommon', locations: [7] },
  { id: 'shadow_herb', name: '–¢–µ–Ω–µ–≤–∞—è —Ç—Ä–∞–≤–∞', icon: Wind, rarity: 'rare', locations: [7] },
  { id: 'spider_silk', name: '–ü–∞—É—á–∏–π —à–µ–ª–∫', icon: Box, rarity: 'uncommon', locations: [7] },
  { id: 'dragon_scale', name: '–î—Ä–∞–∫–æ–Ω—å—è —á–µ—à—É—è', icon: Shield, rarity: 'legendary', locations: [8] },
  { id: 'dragon_bone', name: '–î—Ä–∞–∫–æ–Ω—å—è –∫–æ—Å—Ç—å', icon: Box, rarity: 'epic', locations: [8] },
  { id: 'fire_crystal', name: '–û–≥–Ω–µ–Ω–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª', icon: Flame, rarity: 'epic', locations: [8] }
];

// –†–ï–¶–ï–ü–¢–´ –ö–†–ê–§–¢–ê
const RECIPES = [
  {
    id: 1,
    name: '–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á',
    profession: 'blacksmith',
    requiredLevel: 1,
    ingredients: [
      { resourceId: 'iron_ore', amount: 3 },
      { resourceId: 'wood', amount: 1 }
    ],
    result: {
      itemId: 11,
      name: '–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á',
      type: 'weapon',
      val: 12,
      rarity: 'uncommon'
    },
    craftTime: 2000,
    expReward: 25
  },
  {
    id: 2,
    name: '–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è',
    profession: 'alchemist',
    requiredLevel: 1,
    ingredients: [
      { resourceId: 'red_herb', amount: 2 },
      { resourceId: 'water', amount: 1 }
    ],
    result: {
      itemId: 8,
      name: '–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è',
      type: 'consumable',
      val: 50,
      rarity: 'common'
    },
    craftTime: 1500,
    expReward: 15
  },
  {
    id: 3,
    name: '–¢—Ä–∞–≤—è–Ω–æ–π –æ—Ç–≤–∞—Ä',
    profession: 'herbalist',
    requiredLevel: 1,
    ingredients: [
      { resourceId: 'red_herb', amount: 1 },
      { resourceId: 'blue_herb', amount: 1 }
    ],
    result: {
      itemId: 12,
      name: '–¢—Ä–∞–≤—è–Ω–æ–π –æ—Ç–≤–∞—Ä',
      type: 'consumable',
      val: 30,
      rarity: 'common'
    },
    craftTime: 1000,
    expReward: 10
  },
  {
    id: 4,
    name: '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π –º–µ—á',
    profession: 'blacksmith',
    requiredLevel: 2,
    ingredients: [
      { resourceId: 'iron_ore', amount: 5 },
      { resourceId: 'gold_ore', amount: 2 }
    ],
    result: {
      itemId: 10,
      name: '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π –º–µ—á',
      type: 'weapon',
      val: 10,
      rarity: 'uncommon'
    },
    craftTime: 2500,
    expReward: 35
  },
  {
    id: 5,
    name: '–ë–æ–ª—å—à–æ–µ –∑–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è',
    profession: 'alchemist',
    requiredLevel: 2,
    ingredients: [
      { resourceId: 'red_herb', amount: 3 },
      { resourceId: 'blue_herb', amount: 2 },
      { resourceId: 'water', amount: 1 }
    ],
    result: {
      itemId: 25,
      name: '–ë–æ–ª—å—à–æ–µ –∑–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è',
      type: 'consumable',
      val: 100,
      rarity: 'uncommon'
    },
    craftTime: 2000,
    expReward: 30
  },
  {
    id: 6,
    name: '–ö–æ–ª—å—á—É–≥–∞',
    profession: 'blacksmith',
    requiredLevel: 3,
    ingredients: [
      { resourceId: 'iron_ore', amount: 8 },
      { resourceId: 'wood', amount: 2 }
    ],
    result: {
      itemId: 18,
      name: '–ö–æ–ª—å—á—É–≥–∞',
      type: 'armor',
      val: 10,
      rarity: 'uncommon'
    },
    craftTime: 3000,
    expReward: 50
  },
  {
    id: 7,
    name: '–ó–µ–ª—å–µ —ç–Ω–µ—Ä–≥–∏–∏',
    profession: 'alchemist',
    requiredLevel: 3,
    ingredients: [
      { resourceId: 'blue_herb', amount: 3 },
      { resourceId: 'crystal', amount: 1 }
    ],
    result: {
      itemId: 26,
      name: '–ó–µ–ª—å–µ —ç–Ω–µ—Ä–≥–∏–∏',
      type: 'consumable',
      val: 10,
      rarity: 'uncommon',
      effect: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é'
    },
    craftTime: 2000,
    expReward: 40
  },
  {
    id: 8,
    name: '–≠–ª–∏–∫—Å–∏—Ä —Å–∏–ª—ã',
    profession: 'alchemist',
    requiredLevel: 4,
    ingredients: [
      { resourceId: 'red_herb', amount: 5 },
      { resourceId: 'crystal', amount: 2 }
    ],
    result: {
      itemId: 27,
      name: '–≠–ª–∏–∫—Å–∏—Ä —Å–∏–ª—ã',
      type: 'consumable',
      val: 10,
      rarity: 'rare',
      effect: '–í—Ä–µ–º–µ–Ω–Ω–æ +10 –∫ —Å–∏–ª–µ –Ω–∞ 5 —à–∞–≥–æ–≤'
    },
    craftTime: 3000,
    expReward: 60
  },
  {
    id: 9,
    name: '–ú–∏—Ñ—Ä–∏–ª–æ–≤–∞—è –±—Ä–æ–Ω—è',
    profession: 'blacksmith',
    requiredLevel: 5,
    ingredients: [
      { resourceId: 'mithril_ore', amount: 5 },
      { resourceId: 'iron_ore', amount: 10 }
    ],
    result: {
      itemId: 20,
      name: '–ú–∏—Ñ—Ä–∏–ª–æ–≤–∞—è –±—Ä–æ–Ω—è',
      type: 'armor',
      val: 18,
      rarity: 'rare'
    },
    craftTime: 4000,
    expReward: 100
  },
  // FISH RECIPES
  {
    id: 10,
    name: '–†—ã–±–Ω—ã–π —Å—É–ø',
    profession: 'alchemist',
    requiredLevel: 1,
    ingredients: [
      { resourceId: 'small_fish', amount: 2 },
      { resourceId: 'water', amount: 1 }
    ],
    result: {
      itemId: 34,
      name: '–†—ã–±–Ω—ã–π —Å—É–ø',
      type: 'consumable',
      val: 40,
      rarity: 'common',
      effect: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 40 HP'
    },
    craftTime: 1500,
    expReward: 15
  },
  {
    id: 11,
    name: '–≠–ª–∏–∫—Å–∏—Ä –º–æ—Ä—è',
    profession: 'alchemist',
    requiredLevel: 3,
    ingredients: [
      { resourceId: 'golden_carp', amount: 1 },
      { resourceId: 'blue_herb', amount: 2 },
      { resourceId: 'water', amount: 1 }
    ],
    result: {
      itemId: 35,
      name: '–≠–ª–∏–∫—Å–∏—Ä –º–æ—Ä—è',
      type: 'consumable',
      val: 0,
      rarity: 'rare',
      effect: '+5 –∫ –∑–∞—â–∏—Ç–µ –Ω–∞ 10 —à–∞–≥–æ–≤'
    },
    craftTime: 3000,
    expReward: 50
  },
  {
    id: 12,
    name: '–î—Ä–∞–∫–æ–Ω–∏–π —ç–ª–∏–∫—Å–∏—Ä',
    profession: 'alchemist',
    requiredLevel: 5,
    ingredients: [
      { resourceId: 'dragon_fish', amount: 1 },
      { resourceId: 'fire_crystal', amount: 2 },
      { resourceId: 'crystal', amount: 3 }
    ],
    result: {
      itemId: 36,
      name: '–î—Ä–∞–∫–æ–Ω–∏–π —ç–ª–∏–∫—Å–∏—Ä',
      type: 'consumable',
      val: 0,
      rarity: 'legendary',
      effect: '+15 –∫ —Å–∏–ª–µ –∏ +10 –∫ –∑–∞—â–∏—Ç–µ –Ω–∞ 20 —à–∞–≥–æ–≤'
    },
    craftTime: 5000,
    expReward: 150
  }
];

const QUESTS_DB = [
  { id: 1, name: '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏', type: 'step', target: 20, desc: '–°–¥–µ–ª–∞–π—Ç–µ 20 —à–∞–≥–æ–≤ –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–∏.', gold: 50, exp: 20, minLvl: 1 },
  { id: 2, name: '–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ –∫—Ä—ã—Å', type: 'kill', target: 3, desc: '–ü–æ–±–µ–¥–∏—Ç–µ 3 –ª—é–±—ã—Ö –≤—Ä–∞–≥–æ–≤.', gold: 100, exp: 50, minLvl: 1, itemReward: { id: 24, name: '–ú–∞–ª–æ–µ –∑–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è' } },
  { id: 3, name: '–£–¥–∞—á–ª–∏–≤—ã–π –∏—Å–∫–∞—Ç–µ–ª—å', type: 'find', target: 1, desc: '–ù–∞–π–¥–∏—Ç–µ –ª—é–±–æ–π –ø—Ä–µ–¥–º–µ—Ç –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–∏.', gold: 150, exp: 30, minLvl: 2 },
  { id: 4, name: '–î–æ–ª–≥–∞—è –¥–æ—Ä–æ–≥–∞', type: 'step', target: 100, desc: '–ü—Ä–æ–π–¥–∏—Ç–µ 100 —à–∞–≥–æ–≤.', gold: 300, exp: 150, minLvl: 3, itemReward: { id: 9, name: '–ë—Ä–æ–Ω–∑–æ–≤—ã–π —Ç–æ–ø–æ—Ä' } },
  { id: 5, name: '–í–µ—Ç–µ—Ä–∞–Ω –±–æ–µ–≤', type: 'kill', target: 10, desc: '–ü–æ–±–µ–¥–∏—Ç–µ 10 –≤—Ä–∞–≥–æ–≤.', gold: 500, exp: 400, minLvl: 5, itemReward: { id: 17, name: '–ö–æ–∂–∞–Ω–∞—è –∫—É—Ä—Ç–∫–∞' } },
  { id: 6, name: '–ú–∞–≥–Ω–∞—Ç', type: 'earn_gold', target: 200, desc: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 200 –∑–æ–ª–æ—Ç–∞ (–ª—É—Ç/–ø—Ä–æ–¥–∞–∂–∞).', gold: 100, exp: 100, minLvl: 1 },
];

// –ì–ò–õ–¨–î–ò–ò (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ - –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –±—É–¥–µ—Ç –Ω–∞ backend)
const GUILDS = [
  {
    id: 1,
    name: '–°—Ç–∞–ª—å–Ω—ã–µ –í–æ–∏–Ω—ã',
    level: 5,
    memberCount: 12,
    bonuses: { expBonus: 10, goldBonus: 5 }
  },
  {
    id: 2,
    name: '–ú–∞–≥–∏—á–µ—Å–∫–∏–π –ö—Ä—É–≥',
    level: 3,
    memberCount: 8,
    bonuses: { expBonus: 5, goldBonus: 10 }
  },
  {
    id: 3,
    name: '–¢–æ—Ä–≥–æ–≤–∞—è –õ–∏–≥–∞',
    level: 7,
    memberCount: 20,
    bonuses: { expBonus: 15, goldBonus: 15 }
  },
  {
    id: 4,
    name: '–ù–æ—á–Ω—ã–µ –û—Ö–æ—Ç–Ω–∏–∫–∏',
    level: 4,
    memberCount: 10,
    bonuses: { expBonus: 8, goldBonus: 7 }
  }
];

// –î–û–°–¢–ò–ñ–ï–ù–ò–Ø
const ACHIEVEMENTS = [
  // EXPLORATION (–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è)
  {
    id: 'first_steps',
    name: '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏',
    description: '–°–¥–µ–ª–∞–π—Ç–µ 10 —à–∞–≥–æ–≤',
    category: 'exploration',
    requirement: { type: 'steps', value: 10 },
    reward: { gold: 50, exp: 20 },
    icon: Footprints
  },
  {
    id: 'seasoned_traveler',
    name: '–û–ø—ã—Ç–Ω—ã–π –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫',
    description: '–°–¥–µ–ª–∞–π—Ç–µ 100 —à–∞–≥–æ–≤',
    category: 'exploration',
    requirement: { type: 'steps', value: 100 },
    reward: { gold: 200, exp: 100 },
    icon: Footprints
  },
  {
    id: 'explorer',
    name: '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å',
    description: '–ü–æ—Å–µ—Ç–∏—Ç–µ 5 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–π',
    category: 'exploration',
    requirement: { type: 'locations_visited', value: 5 },
    reward: { gold: 300, exp: 150 },
    icon: MapPin
  },
  
  // COMBAT (–ë–æ–∏)
  {
    id: 'first_blood',
    name: '–ü–µ—Ä–≤–∞—è –∫—Ä–æ–≤—å',
    description: '–ü–æ–±–µ–¥–∏—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ä–∞–≥–∞',
    category: 'combat',
    requirement: { type: 'kills', value: 1 },
    reward: { gold: 30, exp: 15 },
    icon: Sword
  },
  {
    id: 'monster_slayer',
    name: '–£–±–∏–π—Ü–∞ –º–æ–Ω—Å—Ç—Ä–æ–≤',
    description: '–ü–æ–±–µ–¥–∏—Ç–µ 50 –≤—Ä–∞–≥–æ–≤',
    category: 'combat',
    requirement: { type: 'kills', value: 50 },
    reward: { gold: 200, exp: 100 },
    icon: Skull
  },
  {
    id: 'legendary_warrior',
    name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –≤–æ–∏–Ω',
    description: '–ü–æ–±–µ–¥–∏—Ç–µ 200 –≤—Ä–∞–≥–æ–≤',
    category: 'combat',
    requirement: { type: 'kills', value: 200 },
    reward: { gold: 1000, exp: 500 },
    icon: Swords
  },
  
  // CRAFTING (–ö—Ä–∞—Ñ—Ç)
  {
    id: 'first_craft',
    name: '–ü–µ—Ä–≤–æ–µ —Ç–≤–æ—Ä–µ–Ω–∏–µ',
    description: '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç',
    category: 'crafting',
    requirement: { type: 'crafts', value: 1 },
    reward: { gold: 50, exp: 25 },
    icon: Hammer
  },
  {
    id: 'apprentice_crafter',
    name: '–ü–æ–¥–º–∞—Å—Ç–µ—Ä—å–µ',
    description: '–°–æ–∑–¥–∞–π—Ç–µ 10 –ø—Ä–µ–¥–º–µ—Ç–æ–≤',
    category: 'crafting',
    requirement: { type: 'crafts', value: 10 },
    reward: { gold: 150, exp: 75 },
    icon: Hammer
  },
  {
    id: 'master_crafter',
    name: '–ú–∞—Å—Ç–µ—Ä –∫—Ä–∞—Ñ—Ç–∞',
    description: '–°–æ–∑–¥–∞–π—Ç–µ 25 –ø—Ä–µ–¥–º–µ—Ç–æ–≤',
    category: 'crafting',
    requirement: { type: 'crafts', value: 25 },
    reward: { gold: 300, exp: 150 },
    icon: Sparkles
  },
  
  // QUESTS (–ö–≤–µ—Å—Ç—ã)
  {
    id: 'quest_beginner',
    name: '–ù–∞—á–∏–Ω–∞—é—â–∏–π –≥–µ—Ä–æ–π',
    description: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∫–≤–µ—Å—Ç',
    category: 'quests',
    requirement: { type: 'quests_completed', value: 1 },
    reward: { gold: 50, exp: 30 },
    icon: CheckCircle
  },
  {
    id: 'quest_master',
    name: '–ú–∞—Å—Ç–µ—Ä –∫–≤–µ—Å—Ç–æ–≤',
    description: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ 5 –∫–≤–µ—Å—Ç–æ–≤',
    category: 'quests',
    requirement: { type: 'quests_completed', value: 5 },
    reward: { gold: 250, exp: 150 },
    icon: Scroll
  },
  
  // SOCIAL (–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ)
  {
    id: 'guild_member',
    name: '–ß–ª–µ–Ω –≥–∏–ª—å–¥–∏–∏',
    description: '–í—Å—Ç—É–ø–∏—Ç–µ –≤ –≥–∏–ª—å–¥–∏—é',
    category: 'social',
    requirement: { type: 'guild_joined', value: 1 },
    reward: { gold: 200, exp: 100 },
    icon: Users
  },
  {
    id: 'guild_founder',
    name: '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –≥–∏–ª—å–¥–∏–∏',
    description: '–°–æ–∑–¥–∞–π—Ç–µ –≥–∏–ª—å–¥–∏—é',
    category: 'social',
    requirement: { type: 'guild_created', value: 1 },
    reward: { gold: 500, exp: 200 },
    icon: Crown
  },
  
  // COLLECTION (–ö–æ–ª–ª–µ–∫—Ü–∏–∏)
  {
    id: 'collector',
    name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä',
    description: '–°–æ–±–µ—Ä–∏—Ç–µ 5 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤',
    category: 'collection',
    requirement: { type: 'avatars_collected', value: 5 },
    reward: { gold: 300, exp: 150 },
    icon: Dna
  },
  {
    id: 'legendary_collector',
    name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä –ª–µ–≥–µ–Ω–¥',
    description: '–ü–æ–ª—É—á–∏—Ç–µ 3 –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞',
    category: 'collection',
    requirement: { type: 'legendary_items', value: 3 },
    reward: { gold: 1000, exp: 500 },
    icon: Trophy
  },
  {
    id: 'wealthy',
    name: '–ë–æ–≥–∞—á',
    description: '–ù–∞–∫–æ–ø–∏—Ç–µ 5000 –∑–æ–ª–æ—Ç–∞',
    category: 'collection',
    requirement: { type: 'gold_accumulated', value: 5000 },
    reward: { gold: 500, exp: 250 },
    icon: Coins
  }
];

// –†–´–ë–´
const FISH_DB = [
  // –û–ë–´–ß–ù–´–ï –†–´–ë–´
  { 
    id: 'small_fish', 
    name: '–ú–µ–ª–∫–∞—è —Ä—ã–±–µ—à–∫–∞', 
    rarity: 'common', 
    sellPrice: 5, 
    locations: [1, 2, 3, 4, 5, 6, 7, 8],
    icon: 'üêü'
  },
  { 
    id: 'carp', 
    name: '–ö–∞—Ä–ø', 
    rarity: 'common', 
    sellPrice: 8, 
    locations: [1, 2, 3],
    icon: 'üêü'
  },
  { 
    id: 'perch', 
    name: '–û–∫—É–Ω—å', 
    rarity: 'common', 
    sellPrice: 10, 
    locations: [1, 2, 3, 4],
    icon: 'üêü'
  },
  
  // –ù–ï–û–ë–´–ß–ù–´–ï –†–´–ë–´
  { 
    id: 'pike', 
    name: '–©—É–∫–∞', 
    rarity: 'uncommon', 
    sellPrice: 20, 
    locations: [2, 3, 4],
    icon: 'üê†'
  },
  { 
    id: 'salmon', 
    name: '–õ–æ—Å–æ—Å—å', 
    rarity: 'uncommon', 
    sellPrice: 25, 
    locations: [3, 4, 6],
    icon: 'üê†'
  },
  { 
    id: 'catfish', 
    name: '–°–æ–º', 
    rarity: 'uncommon', 
    sellPrice: 30, 
    locations: [3, 4, 7],
    icon: 'üê†'
  },
  
  // –†–ï–î–ö–ò–ï –†–´–ë–´
  { 
    id: 'golden_carp', 
    name: '–ó–æ–ª–æ—Ç–æ–π –∫–∞—Ä–ø', 
    rarity: 'rare', 
    sellPrice: 60, 
    locations: [3, 4, 5],
    icon: 'üê°'
  },
  { 
    id: 'ice_fish', 
    name: '–õ–µ–¥—è–Ω–∞—è —Ä—ã–±–∞', 
    rarity: 'rare', 
    sellPrice: 70, 
    locations: [6],
    icon: 'üê°'
  },
  { 
    id: 'shadow_fish', 
    name: '–¢–µ–Ω–µ–≤–∞—è —Ä—ã–±–∞', 
    rarity: 'rare', 
    sellPrice: 80, 
    locations: [7],
    icon: 'üê°'
  },
  
  // –≠–ü–ò–ß–ï–°–ö–ò–ï –†–´–ë–´
  { 
    id: 'crystal_fish', 
    name: '–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è —Ä—ã–±–∞', 
    rarity: 'epic', 
    sellPrice: 150, 
    locations: [5, 6],
    icon: 'üê¨'
  },
  { 
    id: 'fire_fish', 
    name: '–û–≥–Ω–µ–Ω–Ω–∞—è —Ä—ã–±–∞', 
    rarity: 'epic', 
    sellPrice: 180, 
    locations: [4, 8],
    icon: 'üê¨'
  },
  
  // –õ–ï–ì–ï–ù–î–ê–†–ù–´–ï –†–´–ë–´
  { 
    id: 'dragon_fish', 
    name: '–î—Ä–∞–∫–æ–Ω—å—è —Ä—ã–±–∞', 
    rarity: 'legendary', 
    sellPrice: 400, 
    locations: [8],
    icon: 'üêâ'
  },
  { 
    id: 'ancient_leviathan', 
    name: '–î—Ä–µ–≤–Ω–∏–π –õ–µ–≤–∏–∞—Ñ–∞–Ω', 
    rarity: 'legendary', 
    sellPrice: 500, 
    locations: [8],
    icon: 'üêâ'
  }
];

// --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

// Calculate item stats based on type and rarity
const calculateItemStats = (type, rarity) => {
  const ranges = {
    weapon: {
      common: { min: 2, max: 5 },
      uncommon: { min: 5, max: 12 },
      rare: { min: 12, max: 20 },
      epic: { min: 20, max: 30 },
      legendary: { min: 30, max: 50 }
    },
    armor: {
      common: { min: 1, max: 6 },
      uncommon: { min: 6, max: 12 },
      rare: { min: 12, max: 20 },
      epic: { min: 18, max: 25 },
      legendary: { min: 25, max: 35 }
    },
    consumable: {
      common: { min: 20, max: 50 },
      uncommon: { min: 50, max: 100 },
      rare: { min: 100, max: 200 },
      epic: { min: 200, max: 500 },
      legendary: { min: 500, max: 1000 }
    }
  };

  const range = ranges[type]?.[rarity] || { min: 1, max: 10 };
  return getRandomInt(range.min, range.max);
};

// --- –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø ---

const SAVE_KEY = 'rpg_game_save_v2';

const saveGame = (playerData) => {
  try {
    const saveData = {
      version: 2,
      timestamp: Date.now(),
      player: playerData
    };
    
    localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
    return true;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    if (error.name === 'QuotaExceededError') {
      console.error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –û—á–∏—Å—Ç–∏—Ç–µ localStorage.');
    }
    return false;
  }
};

const loadGame = () => {
  try {
    const saveData = localStorage.getItem(SAVE_KEY);
    if (!saveData) return null;
    
    const parsed = JSON.parse(saveData);
    
    // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π (v1 -> v2)
    if (!parsed.version || parsed.version === 1) {
      console.warn('–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Å—Ç–∞—Ä–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è...');
      
      // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ä–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ –≤–µ—Ä—Å–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è
      const migratedPlayer = {
        ...parsed.player || parsed,
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        profession: parsed.player?.profession || null,
        professionLevel: parsed.player?.professionLevel || 0,
        professionExp: parsed.player?.professionExp || 0,
        professionMaxExp: parsed.player?.professionMaxExp || 100,
        resources: parsed.player?.resources || {},
        totalCrafts: parsed.player?.totalCrafts || 0,
        guildId: parsed.player?.guildId || null,
        guildRole: parsed.player?.guildRole || null,
        guildContribution: parsed.player?.guildContribution || 0,
        achievements: parsed.player?.achievements || [],
        unclaimedAchievements: parsed.player?.unclaimedAchievements || []
      };
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
      saveGame(migratedPlayer);
      return migratedPlayer;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏
    if (parsed.version !== 2) {
      console.warn('–ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è –≤–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      return null;
    }
    
    return parsed.player;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
    return null;
  }
};

const exportSave = () => {
  const saveData = localStorage.getItem(SAVE_KEY);
  if (!saveData) {
    console.error('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
    return false;
  }
  
  try {
    const blob = new Blob([saveData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rpg_save_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    return true;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
    return false;
  }
};

const importSave = (file, onSuccess, onError) => {
  const reader = new FileReader();
  
  reader.onload = (e) => {
    try {
      const saveData = JSON.parse(e.target.result);
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏
      if (!saveData.version || saveData.version !== 2) {
        onError('–ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è –≤–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        return;
      }
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
      if (!saveData.player || !saveData.player.name) {
        onError('–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ');
        return;
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
      localStorage.setItem(SAVE_KEY, e.target.result);
      onSuccess();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
      onError('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
    }
  };
  
  reader.onerror = () => {
    onError('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
  };
  
  reader.readAsText(file);
};

// --- –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI ---

const Button = ({ children, onClick, disabled, variant = 'primary', className = '' }) => {
  const baseStyle = "px-4 py-2 rounded-lg font-bold transition-all active:scale-95 flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20",
    success: "bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/20",
    danger: "bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-900/20",
    outline: "border-2 border-slate-600 text-slate-300 hover:bg-slate-800",
    secondary: "bg-slate-700 hover:bg-slate-600 text-white",
    purple: "bg-[#6366f1] hover:bg-[#4f46e5] text-white shadow-lg shadow-indigo-500/30",
    gold: "bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg shadow-yellow-900/20"
  };

  return (
    <button 
      onClick={onClick} 
      disabled={disabled} 
      className={`${baseStyle} ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed grayscale' : ''} ${className}`}
    >
      {children}
    </button>
  );
};

const Card = ({ children, title, icon: Icon, className = '' }) => (
  <div className={`bg-slate-800 rounded-xl border border-slate-700 shadow-xl overflow-hidden ${className}`}>
    {title && (
      <div className="bg-slate-900/50 p-4 border-b border-slate-700 flex items-center gap-2">
        {Icon && <Icon size={20} className="text-blue-400" />}
        <h3 className="font-bold text-slate-100">{title}</h3>
      </div>
    )}
    <div className="p-4">
      {children}
    </div>
  </div>
);

const ProgressBar = ({ value, max, color = 'bg-blue-500', label, icon: Icon, showLabel = true }) => {
  const percent = Math.min(100, Math.max(0, (value / max) * 100));
  return (
    <div className="w-full">
      {showLabel && (
        <div className="flex justify-between text-xs mb-1 text-slate-400 font-semibold">
          <span className="flex items-center gap-1">{Icon && <Icon size={12} />}{label}</span>
          <span>{Math.floor(value)} / {Math.floor(max)}</span>
        </div>
      )}
      <div className="h-3 bg-slate-900 rounded-full overflow-hidden border border-slate-700">
        <div 
          className={`h-full ${color} transition-all duration-300`} 
          style={{ width: `${percent}%` }}
        ></div>
      </div>
    </div>
  );
};

const NavItem = ({ icon: Icon, label, active, onClick, disabled, badge }) => (
  <button 
    onClick={disabled ? null : onClick} 
    className={`
      w-full flex items-center justify-between p-3 rounded-lg transition-colors mb-1 text-sm font-medium
      ${active ? 'bg-[#1e293b] text-white' : 'text-slate-400 hover:bg-[#1e293b] hover:text-slate-200'}
      ${disabled ? 'opacity-50 cursor-not-allowed' : ''}
    `}
  >
    <div className="flex items-center gap-3">
      <Icon size={18} className={active ? 'text-white' : ''} />
      <span>{label}</span>
    </div>
    {badge && (
      <span className="text-[10px] uppercase font-bold px-2 py-0.5 rounded-full bg-orange-700/80 text-orange-100 shadow-sm border border-orange-600/50">
        {badge}
      </span>
    )}
  </button>
);

const NavGroup = ({ title, children }) => (
  <div className="mb-6">
    <div className="px-3 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">
      {title}
    </div>
    <div className="space-y-0.5">
      {children}
    </div>
  </div>
);

// --- NOTIFICATION SYSTEM ---

const NotificationSystem = React.memo(({ notifications }) => {
  return (
    <div className="fixed top-4 right-4 z-50 space-y-2 pointer-events-none">
      {notifications.map(notification => {
        const typeStyles = {
          success: 'bg-green-900/90 border-green-600 text-green-100',
          info: 'bg-blue-900/90 border-blue-600 text-blue-100',
          warning: 'bg-yellow-900/90 border-yellow-600 text-yellow-100',
          error: 'bg-red-900/90 border-red-600 text-red-100',
          legendary: 'bg-orange-900/90 border-orange-500 text-orange-100'
        };

        const typeIcons = {
          success: CheckCircle,
          info: Sparkles,
          warning: Zap,
          error: X,
          legendary: Crown
        };

        const Icon = typeIcons[notification.type] || Sparkles;

        return (
          <div
            key={notification.id}
            className={`${typeStyles[notification.type]} border-2 rounded-lg px-4 py-3 shadow-xl backdrop-blur-sm pointer-events-auto animate-in fade-in slide-in-from-right-5 duration-300 min-w-[300px] max-w-[400px]`}
          >
            <div className="flex items-center gap-3">
              <Icon size={20} className="flex-shrink-0" />
              <p className="text-sm font-medium">{notification.message}</p>
            </div>
          </div>
        );
      })}
    </div>
  );
});

// --- TOOLTIP COMPONENT ---

const Tooltip = ({ children, content, position = 'top' }) => {
  const [isVisible, setIsVisible] = useState(false);
  
  const positionClasses = {
    top: 'bottom-full left-1/2 -translate-x-1/2 mb-2',
    bottom: 'top-full left-1/2 -translate-x-1/2 mt-2',
    left: 'right-full top-1/2 -translate-y-1/2 mr-2',
    right: 'left-full top-1/2 -translate-y-1/2 ml-2'
  };

  return (
    <div 
      className="relative inline-block"
      onMouseEnter={() => setIsVisible(true)}
      onMouseLeave={() => setIsVisible(false)}
    >
      {children}
      {isVisible && content && (
        <div className={`absolute z-50 bg-slate-900 border border-slate-700 rounded-lg p-3 shadow-xl text-sm whitespace-nowrap animate-in fade-in zoom-in-95 duration-200 ${positionClasses[position]}`}>
          {content}
        </div>
      )}
    </div>
  );
};

// --- RARITY COLOR CONSTANTS ---

const RARITY_COLORS = {
  common: 'text-slate-400 border-slate-600',
  uncommon: 'text-green-400 border-green-600',
  rare: 'text-blue-400 border-blue-600',
  epic: 'text-purple-400 border-purple-600',
  legendary: 'text-orange-400 border-orange-600'
};

const RARITY_BG = {
  common: 'bg-slate-800',
  uncommon: 'bg-green-900/20',
  rare: 'bg-blue-900/20',
  epic: 'bg-purple-900/20',
  legendary: 'bg-orange-900/20'
};

// --- HELPER COMPONENTS FOR PROFILE ---

const StatRow = ({ label, value, icon: Icon, color, sub }) => (
  <div className="flex justify-between items-center bg-slate-900/50 p-2.5 rounded-lg border border-slate-800">
    <div className="flex items-center gap-3">
      <div className={`p-1.5 rounded-md bg-slate-800 ${color}`}>
        <Icon size={16} />
      </div>
      <div>
        <div className="text-sm font-bold text-slate-200">{label}</div>
        {sub && <div className="text-[10px] text-slate-500">{sub}</div>}
      </div>
    </div>
    <div className="text-lg font-mono font-bold text-white">{value}</div>
  </div>
);

const StatBox = ({ label, value }) => (
  <div className="bg-slate-900 p-3 rounded-lg border border-slate-800 text-center">
    <div className="text-2xl font-bold text-white">{value}</div>
    <div className="text-xs text-slate-500 uppercase font-bold tracking-wider">{label}</div>
  </div>
);

const EquipSlot = ({ item, type, icon: Icon, placeholder }) => (
  <div className="relative group">
    <div className={`
      w-16 h-16 rounded-lg flex flex-col items-center justify-center border-2 transition-all
      ${placeholder 
        ? 'border-slate-800 bg-slate-900/50 opacity-50' 
        : item 
          ? 'border-blue-500/50 bg-blue-900/20 shadow-lg shadow-blue-900/20' 
          : 'border-slate-700 bg-slate-800 text-slate-500'
      }
    `}>
      {item ? (
        <>
          <Icon size={24} className={item.rarity === 'legendary' ? 'text-orange-400' : item.rarity === 'rare' ? 'text-blue-400' : 'text-slate-200'} />
        </>
      ) : (
        <Icon size={24} className="opacity-30" />
      )}
    </div>
    {!placeholder && (
      <div className="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-slate-400 uppercase tracking-wider whitespace-nowrap">
        {type}
      </div>
    )}
    {item && (
      <div className="absolute top-0 right-0 w-3 h-3 bg-green-500 rounded-full border border-slate-900"></div>
    )}
  </div>
);

// --- –ö–û–ú–ü–û–ù–ï–ù–¢ –°–û–ó–î–ê–ù–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ê ---

const CharacterCreation = ({ onComplete }) => {
  const [name, setName] = useState('');
  const [selectedClass, setSelectedClass] = useState(PLAYER_CLASSES[0]);
  const [selectedAvatar, setSelectedAvatar] = useState(AVATARS_DB[0]);

  const handleSubmit = () => {
    if (!name.trim()) return;
    onComplete({
      name,
      classId: selectedClass.id,
      className: selectedClass.name,
      avatarId: selectedAvatar.id,
      ...selectedClass.baseStats,
      maxHp: selectedClass.baseStats.hp,
      maxEnergy: selectedClass.baseStats.energy,
      level: 1,
      exp: 0,
      maxExp: 100,
      gold: 0,
      locationId: 1,
      inventory: [],
      equipment: { weapon: null, armor: null },
      activeQuests: [],
      completedQuests: [],
      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
      totalSteps: 0,
      totalKills: 0,
      questsCompletedCount: 0,
      collectedAvatars: [selectedAvatar.id],
      // –ù–û–í–´–ï –ü–û–õ–Ø: –ü—Ä–æ—Ñ–µ—Å—Å–∏—è
      profession: null,
      professionLevel: 0,
      professionExp: 0,
      professionMaxExp: 100,
      // –ù–û–í–´–ï –ü–û–õ–Ø: –†–µ—Å—É—Ä—Å—ã
      resources: {},
      totalCrafts: 0,
      // –ù–û–í–´–ï –ü–û–õ–Ø: –ì–∏–ª—å–¥–∏—è
      guildId: null,
      guildRole: null,
      guildContribution: 0,
      // –ù–û–í–´–ï –ü–û–õ–Ø: –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
      achievements: [],
      unclaimedAchievements: []
    });
  };

  return (
    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
      <div className="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8">
        <div className="space-y-6 animate-in slide-in-from-left-4 duration-500">
          <div className="text-center md:text-left">
            <h1 className="text-4xl font-bold text-blue-400 mb-2">–ù–æ–≤—ã–π –ì–µ—Ä–æ–π</h1>
            <p className="text-slate-400">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è.</p>
          </div>

          <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 space-y-4">
            <div>
              <label className="block text-sm font-bold text-slate-300 mb-2">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
              <input 
                type="text" 
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è..."
                className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>

            <div>
              <label className="block text-sm font-bold text-slate-300 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ê–≤–∞—Ç–∞—Ä</label>
              <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                {AVATARS_DB.slice(0, 5).map(av => (
                  <button
                    key={av.id}
                    onClick={() => setSelectedAvatar(av)}
                    className={`w-12 h-12 rounded-lg flex-shrink-0 flex items-center justify-center transition-all ${selectedAvatar.id === av.id ? 'ring-2 ring-white scale-110' : 'opacity-50 hover:opacity-100'} ${av.color}`}
                  >
                    <av.icon className="text-white" size={24} />
                  </button>
                ))}
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold text-slate-300 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ö–ª–∞—Å—Å</label>
              <div className="space-y-2">
                {PLAYER_CLASSES.map(cls => (
                  <button
                    key={cls.id}
                    onClick={() => setSelectedClass(cls)}
                    className={`w-full text-left p-3 rounded-lg border transition-all ${selectedClass.id === cls.id ? 'bg-blue-900/30 border-blue-500' : 'bg-slate-800 border-slate-700 hover:border-slate-500'}`}
                  >
                    <div className="font-bold text-slate-200">{cls.name}</div>
                    <div className="text-xs text-slate-400">{cls.desc}</div>
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        <div className="flex flex-col items-center justify-center animate-in slide-in-from-right-4 duration-500 delay-150">
           <Card className="w-full max-w-sm relative overflow-visible mt-8 md:mt-0">
             <div className="absolute -top-12 left-1/2 -translate-x-1/2">
                <div className={`w-24 h-24 rounded-full border-4 border-slate-800 shadow-xl flex items-center justify-center ${selectedAvatar.color}`}>
                  <selectedAvatar.icon size={48} className="text-white" />
                </div>
             </div>
             <div className="pt-14 text-center pb-6">
                <h2 className="text-2xl font-bold text-white">{name || '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π'}</h2>
                <div className="text-blue-400 text-sm uppercase tracking-widest font-bold mt-1">{selectedClass.name}</div>
                
                <div className="mt-6 grid grid-cols-2 gap-4 px-4">
                  <div className="bg-slate-900 p-2 rounded border border-slate-700">
                    <div className="text-xs text-slate-500 uppercase">–°–∏–ª–∞</div>
                    <div className="font-bold text-lg">{selectedClass.baseStats.str}</div>
                  </div>
                  <div className="bg-slate-900 p-2 rounded border border-slate-700">
                     <div className="text-xs text-slate-500 uppercase">–ó–∞—â–∏—Ç–∞</div>
                     <div className="font-bold text-lg">{selectedClass.baseStats.def}</div>
                  </div>
                  <div className="bg-slate-900 p-2 rounded border border-slate-700">
                     <div className="text-xs text-slate-500 uppercase">–ó–¥–æ—Ä–æ–≤—å–µ</div>
                     <div className="font-bold text-lg">{selectedClass.baseStats.hp}</div>
                  </div>
                  <div className="bg-slate-900 p-2 rounded border border-slate-700">
                     <div className="text-xs text-slate-500 uppercase">–≠–Ω–µ—Ä–≥–∏—è</div>
                     <div className="font-bold text-lg">{selectedClass.baseStats.energy}</div>
                  </div>
                </div>
             </div>
             <div className="p-4 border-t border-slate-700 bg-slate-900/50">
               <Button onClick={handleSubmit} disabled={!name.trim()} className="w-full py-3" variant="success">
                 –ù–∞—á–∞—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ <ChevronRight size={18} />
               </Button>
             </div>
           </Card>
        </div>

      </div>
    </div>
  );
};

// --- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---

export default function App() {
  const [gameStage, setGameStage] = useState('creation'); 
  const [player, setPlayer] = useState(null);
  const [activeTab, setActiveTab] = useState('home'); 
  const [collectionTab, setCollectionTab] = useState('avatars'); // Sub-tab for Collections
  const [achievementCategory, setAchievementCategory] = useState('all'); // Category filter for Achievements
  const [combatState, setCombatState] = useState(null);
  const [logs, setLogs] = useState([]);
  const [lastStepText, setLastStepText] = useState("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —à–∞–≥...");
  const [isSidebarOpen, setSidebarOpen] = useState(false);
  const [showLocationSelector, setShowLocationSelector] = useState(false);
  const [showLevelUp, setShowLevelUp] = useState(false);
  const [notifications, setNotifications] = useState([]);
  const [lastSaveTime, setLastSaveTime] = useState(null);
  const [isCrafting, setIsCrafting] = useState(false);
  
  // Fishing state
  const [fishingState, setFishingState] = useState(null); // { stage: 'waiting' | 'bite' | 'caught' | 'missed', timer, fish }
  const fishingTimerRef = useRef(null);

  const logsEndRef = useRef(null);

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
  useEffect(() => {
    const savedPlayer = loadGame();
    if (savedPlayer) {
      setPlayer(savedPlayer);
      setGameStage('playing');
      console.log('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
  }, []);

  // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞
  useEffect(() => {
    if (player && gameStage === 'playing') {
      saveGame(player);
      setLastSaveTime(Date.now());
    }
  }, [player, gameStage]);

  // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  useEffect(() => {
    if (!player || gameStage !== 'playing') return;
    
    const autoSaveInterval = setInterval(() => {
      saveGame(player);
      setLastSaveTime(Date.now());
      addNotification('–ò–≥—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success', 2000);
    }, 30000); // 30 —Å–µ–∫—É–Ω–¥
    
    return () => clearInterval(autoSaveInterval);
  }, [player, gameStage]);

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  useEffect(() => {
    const handleBeforeUnload = () => {
      if (player) {
        saveGame(player);
        setLastSaveTime(Date.now());
      }
    };
    
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [player]);

  useEffect(() => {
    logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [logs]);

  useEffect(() => {
    if (!player) return;
    const timer = setInterval(() => {
      setPlayer(p => {
        if (p.energy < p.maxEnergy && !combatState) {
          return { ...p, energy: p.energy + 1 };
        }
        return p;
      });
    }, 5000); 
    return () => clearInterval(timer);
  }, [combatState, player?.maxEnergy]);

  const addLog = (text, type = 'neutral') => {
    const colors = {
      neutral: 'text-slate-400',
      good: 'text-green-400',
      bad: 'text-red-400',
      rare: 'text-yellow-400 font-bold',
      combat: 'text-orange-400',
      quest: 'text-cyan-400 font-bold',
      epic: 'text-purple-400 font-bold'
    };
    setLogs(prev => [...prev.slice(-19), { text, type: colors[type], id: Date.now() }]);
    setLastStepText(text);
  };

  const addNotification = (message, type = 'info', duration = 3000) => {
    const id = Date.now() + Math.random(); // Ensure unique ID
    setNotifications(prev => [...prev, { id, message, type }]);
    
    setTimeout(() => {
      setNotifications(prev => prev.filter(n => n.id !== id));
    }, duration);
  };

  const levelUp = (currentExp, currentMaxExp, currentLvl, classId) => {
    if (currentExp >= currentMaxExp) {
      addLog(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è ${currentLvl + 1}!`, 'rare');
      addNotification(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è ${currentLvl + 1}!`, 'success', 4000);
      setShowLevelUp(true);
      setTimeout(() => setShowLevelUp(false), 3000);

      const pClass = PLAYER_CLASSES.find(c => c.id === classId) || PLAYER_CLASSES[0];
      const growth = pClass.growth;
      const nextMaxExp = Math.floor(currentMaxExp * 1.5);

      return {
        lvl: currentLvl + 1,
        exp: currentExp - currentMaxExp,
        maxExp: nextMaxExp,
        stats: { 
          str: growth.str, 
          def: growth.def, 
          hp: growth.hp, 
          energy: 2 
        } 
      };
    }
    return null;
  };

  const checkQuestProgress = (type, amount = 1) => {
    if (!player || !player.activeQuests) return;

    const updatedQuests = player.activeQuests.map(q => {
      if (q.type === type && !q.isCompleted) {
        const newProgress = Math.min(q.target, q.progress + amount);
        if (newProgress >= q.target && q.progress < q.target) {
          addLog(`–ö–≤–µ—Å—Ç "${q.name}" –≤—ã–ø–æ–ª–Ω–µ–Ω! –ó–∞–±–µ—Ä–∏—Ç–µ –Ω–∞–≥—Ä–∞–¥—É.`, 'quest');
          addNotification(`–ö–≤–µ—Å—Ç "${q.name}" –≤—ã–ø–æ–ª–Ω–µ–Ω!`, 'success', 4000);
          return { ...q, progress: newProgress, isCompleted: true };
        }
        return { ...q, progress: newProgress };
      }
      return q;
    });

    if (JSON.stringify(updatedQuests) !== JSON.stringify(player.activeQuests)) {
      setPlayer(p => ({ ...p, activeQuests: updatedQuests }));
    }
  };

  const startQuest = (questId) => {
    const quest = QUESTS_DB.find(q => q.id === questId);
    if (!quest) return;
    
    const newQuestState = {
      ...quest,
      progress: 0,
      isCompleted: false
    };

    setPlayer(p => ({
      ...p,
      activeQuests: [...(p.activeQuests || []), newQuestState]
    }));
    addLog(`–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∫–≤–µ—Å—Ç: ${quest.name}`, 'quest');
  };

  const claimQuestReward = (questId) => {
    const questState = player.activeQuests.find(q => q.id === questId);
    if (!questState || !questState.isCompleted) return;

    const newPlayer = {
      ...player,
      gold: player.gold + questState.gold,
      exp: player.exp + questState.exp,
      activeQuests: player.activeQuests.filter(q => q.id !== questId),
      completedQuests: [...(player.completedQuests || []), questId],
      questsCompletedCount: (player.questsCompletedCount || 0) + 1
    };

    // Add item reward if quest has one
    if (questState.itemReward) {
      const rewardItem = ITEMS_DB.find(item => item.id === questState.itemReward.id);
      if (rewardItem) {
        newPlayer.inventory = [...newPlayer.inventory, { ...rewardItem, uid: Date.now() }];
        addLog(`–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: ${questState.gold} –∑–æ–ª–æ—Ç–∞, ${questState.exp} –æ–ø—ã—Ç–∞ –∏ ${rewardItem.name}!`, 'quest');
        addNotification(`–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: ${questState.gold} –∑–æ–ª–æ—Ç–∞, ${questState.exp} –æ–ø—ã—Ç–∞ –∏ ${rewardItem.name}!`, 'success');
      }
    } else {
      addLog(`–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: ${questState.gold} –∑–æ–ª–æ—Ç–∞ –∏ ${questState.exp} –æ–ø—ã—Ç–∞!`, 'quest');
      addNotification(`–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: ${questState.gold} –∑–æ–ª–æ—Ç–∞ –∏ ${questState.exp} –æ–ø—ã—Ç–∞!`, 'success');
    }

    const lvlCheck = levelUp(newPlayer.exp, newPlayer.maxExp, newPlayer.level, newPlayer.classId);
    if (lvlCheck) {
       newPlayer.level = lvlCheck.lvl;
       newPlayer.exp = lvlCheck.exp;
       newPlayer.maxExp = lvlCheck.maxExp;
       newPlayer.str += lvlCheck.stats.str;
       newPlayer.def += lvlCheck.stats.def;
       newPlayer.maxHp += lvlCheck.stats.hp;
       newPlayer.hp = newPlayer.maxHp; 
       newPlayer.maxEnergy += lvlCheck.stats.energy;
       newPlayer.energy = newPlayer.maxEnergy; 
    }

    setPlayer(newPlayer);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–µ—Å—Ç–∞
    setTimeout(() => checkAchievements(), 100);
  };

  // --- –ú–ï–•–ê–ù–ò–ö–ê: –ö–û–õ–õ–ï–ö–¶–ò–ò ---

  const buyAvatarChest = () => {
    const COST = 500;
    if (player.gold < COST) {
      addLog("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Å—É–Ω–¥—É–∫–∞!", 'bad');
      return;
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç, –Ω–æ —Å —à–∞–Ω—Å–æ–º –≤—ã–ø–∞–¥–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–∞ (–¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞, –Ω–æ —É–ø—Ä–æ—Å—Ç–∏–º - –≤—Å–µ–≥–¥–∞ –Ω–æ–≤—ã–π –µ—Å–ª–∏ –µ—Å—Ç—å)
    const uncollected = AVATARS_DB.filter(a => !player.collectedAvatars.includes(a.id));
    
    let newAvatarId;
    let isDuplicate = false;

    if (uncollected.length > 0 && Math.random() > 0.3) {
       // 70% —à–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤–æ–≥–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
       const randomIndex = getRandomInt(0, uncollected.length - 1);
       newAvatarId = uncollected[randomIndex].id;
    } else {
       // 30% —à–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç (–∏–ª–∏ –ª—é–±–æ–≥–æ –µ—Å–ª–∏ –≤—Å–µ —Å–æ–±—Ä–∞–Ω—ã)
       const randomIndex = getRandomInt(0, AVATARS_DB.length - 1);
       newAvatarId = AVATARS_DB[randomIndex].id;
       if (player.collectedAvatars.includes(newAvatarId)) {
         isDuplicate = true;
       }
    }

    const rewardAvatar = AVATARS_DB.find(a => a.id === newAvatarId);

    if (isDuplicate) {
       setPlayer({ ...player, gold: player.gold - COST + 100 }); // –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –¥—É–±–ª–∏–∫–∞—Ç
       addLog(`–í—ã –æ—Ç–∫—Ä—ã–ª–∏ —Å—É–Ω–¥—É–∫... –≠—Ç–æ ${rewardAvatar.name}! –£ –≤–∞—Å –æ–Ω —É–∂–µ –µ—Å—Ç—å. +100 –∑–æ–ª–æ—Ç–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏.`, 'neutral');
    } else {
       setPlayer({ 
         ...player, 
         gold: player.gold - COST,
         collectedAvatars: [...player.collectedAvatars, newAvatarId]
       });
       addLog(`–°–£–ù–î–£–ö –û–¢–ö–†–´–¢! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –Ω–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä: ${rewardAvatar.name}!`, 'epic');
    }
  };

  const equipAvatar = (id) => {
    if (player.collectedAvatars.includes(id)) {
      setPlayer({ ...player, avatarId: id });
      addLog("–í—ã —Å–º–µ–Ω–∏–ª–∏ –∞–≤–∞—Ç–∞—Ä.", 'neutral');
    }
  };

  const equipRandomAvatar = () => {
    if (player.collectedAvatars.length > 0) {
      const randomId = player.collectedAvatars[getRandomInt(0, player.collectedAvatars.length - 1)];
      equipAvatar(randomId);
    }
  };

  // --- –ú–ï–•–ê–ù–ò–ö–ê: –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–°–£–†–°–ê–ú–ò ---

  const addResourceToInventory = (resourceId, amount) => {
    setPlayer(p => ({
      ...p,
      resources: {
        ...p.resources,
        [resourceId]: (p.resources[resourceId] || 0) + amount
      }
    }));
  };

  const removeResourceFromInventory = (resourceId, amount) => {
    setPlayer(p => {
      const newResources = { ...p.resources };
      newResources[resourceId] = Math.max(0, (newResources[resourceId] || 0) - amount);
      if (newResources[resourceId] === 0) {
        delete newResources[resourceId];
      }
      return { ...p, resources: newResources };
    });
  };

  const getResourceCount = (resourceId) => {
    return player.resources[resourceId] || 0;
  };

  const hasResources = (requirements) => {
    return requirements.every(req => 
      (player.resources[req.resourceId] || 0) >= req.amount
    );
  };

  // --- –ú–ï–•–ê–ù–ò–ö–ê: –ü–†–û–§–ï–°–°–ò–ò ---

  const selectProfession = (professionId) => {
    const profession = PROFESSIONS.find(p => p.id === professionId);
    if (!profession) return;

    if (player.level < profession.unlockLevel) {
      addLog(`–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å ${profession.unlockLevel} –¥–ª—è –≤—ã–±–æ—Ä–∞ —ç—Ç–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏.`, 'bad');
      return;
    }

    setPlayer(p => ({
      ...p,
      profession: professionId,
      professionLevel: 1,
      professionExp: 0,
      professionMaxExp: profession.baseExp
    }));
    addLog(`–í—ã —Å—Ç–∞–ª–∏ ${profession.name}!`, 'good');
  };

  const performProfessionAction = () => {
    if (!player.profession) {
      addLog('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é!', 'bad');
      return;
    }

    if (player.energy < 5) {
      addLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è 5).', 'bad');
      return;
    }

    const profession = PROFESSIONS.find(p => p.id === player.profession);
    if (!profession) return;

    const expGain = getRandomInt(15, 30);
    const goldGain = getRandomInt(10, 25) * player.professionLevel;
    
    let newPlayer = {
      ...player,
      energy: player.energy - 5,
      gold: player.gold + goldGain,
      professionExp: player.professionExp + expGain
    };

    // –®–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ—Å—É—Ä—Å
    if (Math.random() < 0.4) {
      const professionResources = {
        blacksmith: ['iron_ore', 'gold_ore'],
        alchemist: ['red_herb', 'blue_herb', 'water'],
        herbalist: ['red_herb', 'blue_herb', 'green_herb'],
        miner: ['iron_ore', 'gold_ore', 'crystal']
      };
      
      const possibleResources = professionResources[player.profession] || [];
      if (possibleResources.length > 0) {
        const resourceId = possibleResources[getRandomInt(0, possibleResources.length - 1)];
        newPlayer.resources = { ...newPlayer.resources };
        newPlayer.resources[resourceId] = (newPlayer.resources[resourceId] || 0) + 1;
        const resource = RESOURCES.find(r => r.id === resourceId);
        addLog(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${resource?.name || resourceId}!`, 'good');
      }
    }

    addLog(`–†–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! +${expGain} –æ–ø—ã—Ç–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏, +${goldGain} –∑–æ–ª–æ—Ç–∞.`, 'good');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
    if (newPlayer.professionExp >= newPlayer.professionMaxExp) {
      newPlayer.professionLevel += 1;
      newPlayer.professionExp = newPlayer.professionExp - newPlayer.professionMaxExp;
      newPlayer.professionMaxExp = Math.floor(newPlayer.professionMaxExp * profession.expGrowth);
      addLog(`–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –ø–æ–≤—ã—à–µ–Ω –¥–æ ${newPlayer.professionLevel}!`, 'rare');
    }

    setPlayer(newPlayer);
  };

  // --- –ú–ï–•–ê–ù–ò–ö–ê: –ö–†–ê–§–¢ ---

  const getAvailableRecipes = useMemo(() => {
    if (!player.profession) return [];
    return RECIPES.filter(r => 
      r.profession === player.profession && 
      r.requiredLevel <= player.professionLevel
    );
  }, [player.profession, player.professionLevel]);

  const canCraft = useCallback((recipe) => {
    return hasResources(recipe.ingredients);
  }, [player.resources]);

  const craftItem = (recipe) => {
    if (!canCraft(recipe)) {
      addLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞!', 'bad');
      addNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞!', 'error');
      return;
    }

    // Show crafting animation
    setIsCrafting(true);
    addNotification(`–°–æ–∑–¥–∞–Ω–∏–µ ${recipe.name}...`, 'info', 2000);

    // Simulate crafting time
    setTimeout(() => {
      // –£–¥–∞–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
      let newResources = { ...player.resources };
      recipe.ingredients.forEach(ing => {
        newResources[ing.resourceId] = (newResources[ing.resourceId] || 0) - ing.amount;
        if (newResources[ing.resourceId] <= 0) {
          delete newResources[ing.resourceId];
        }
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç
      const craftedItem = {
        ...recipe.result,
        uid: Date.now()
      };

      let newPlayer = {
        ...player,
        resources: newResources,
        inventory: [...player.inventory, craftedItem],
        professionExp: player.professionExp + recipe.expReward,
        totalCrafts: (player.totalCrafts || 0) + 1
      };

      addLog(`–í—ã —Å–æ–∑–¥–∞–ª–∏ ${recipe.result.name}!`, 'good');
      addNotification(`‚ú® –°–æ–∑–¥–∞–Ω –ø—Ä–µ–¥–º–µ—Ç: ${recipe.result.name}!`, 'success');

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
      const profession = PROFESSIONS.find(p => p.id === player.profession);
      if (profession && newPlayer.professionExp >= newPlayer.professionMaxExp) {
        newPlayer.professionLevel += 1;
        newPlayer.professionExp = newPlayer.professionExp - newPlayer.professionMaxExp;
        newPlayer.professionMaxExp = Math.floor(newPlayer.professionMaxExp * profession.expGrowth);
        addLog(`–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –ø–æ–≤—ã—à–µ–Ω –¥–æ ${newPlayer.professionLevel}!`, 'rare');
        addNotification(`üéâ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –ø–æ–≤—ã—à–µ–Ω –¥–æ ${newPlayer.professionLevel}!`, 'legendary');
      }

      setPlayer(newPlayer);
      setIsCrafting(false);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫—Ä–∞—Ñ—Ç–∞
      setTimeout(() => checkAchievements(), 100);
    }, 1000); // 1 second crafting animation
  };

  // --- –ú–ï–•–ê–ù–ò–ö–ê: –†–´–ë–ê–õ–ö–ê ---

  const startFishing = () => {
    if (player.energy < 5) {
      addLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è —Ä—ã–±–∞–ª–∫–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è 5).', 'bad');
      addNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏', 'error');
      return;
    }

    // –£–º–µ–Ω—å—à–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é
    setPlayer(p => ({ ...p, energy: p.energy - 5 }));

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–ª–µ–≤–∫–∏ (5-10 —Å–µ–∫—É–Ω–¥)
    const biteTime = getRandomInt(5000, 10000);
    
    setFishingState({
      stage: 'waiting',
      timer: biteTime,
      startTime: Date.now()
    });

    addLog('–í—ã –∑–∞–±—Ä–æ—Å–∏–ª–∏ —É–¥–æ—á–∫—É... –ñ–¥–∏—Ç–µ –ø–æ–∫–ª–µ–≤–∫–∏!', 'info');
    addNotification('üé£ –ñ–¥–∏—Ç–µ –ø–æ–∫–ª–µ–≤–∫–∏...', 'info', 3000);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –ø–æ–∫–ª–µ–≤–∫–∏
    fishingTimerRef.current = setTimeout(() => {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä—ã–±—É
      const caughtFish = determineFish();
      
      setFishingState({
        stage: 'bite',
        fish: caughtFish,
        reactionWindow: 2000, // 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Ä–µ–∞–∫—Ü–∏—é
        startTime: Date.now()
      });

      addLog('üêü –ü–û–ö–õ–ï–í–ö–ê! –ë—ã—Å—Ç—Ä–æ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–π–º–∞—Ç—å"!', 'rare');
      addNotification('üêü –ü–û–ö–õ–ï–í–ö–ê! –ù–∞–∂–º–∏—Ç–µ "–ü–æ–π–º–∞—Ç—å"!', 'warning', 2000);

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –Ω–µ —É—Å–ø–µ–ª–∏
      fishingTimerRef.current = setTimeout(() => {
        if (fishingState?.stage === 'bite') {
          setFishingState({
            stage: 'missed',
            fish: caughtFish
          });
          addLog('–†—ã–±–∞ —Å–æ—Ä–≤–∞–ª–∞—Å—å... –í—ã –Ω–µ —É—Å–ø–µ–ª–∏!', 'bad');
          addNotification('–†—ã–±–∞ —Å–æ—Ä–≤–∞–ª–∞—Å—å!', 'error');
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(() => setFishingState(null), 2000);
        }
      }, 2000);
    }, biteTime);
  };

  const catchFish = () => {
    if (!fishingState || fishingState.stage !== 'bite') return;

    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
    if (fishingTimerRef.current) {
      clearTimeout(fishingTimerRef.current);
    }

    const fish = fishingState.fish;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä—ã–±—É –≤ —Ä–µ—Å—É—Ä—Å—ã
    setPlayer(p => ({
      ...p,
      resources: {
        ...p.resources,
        [fish.id]: (p.resources[fish.id] || 0) + 1
      }
    }));

    setFishingState({
      stage: 'caught',
      fish: fish
    });

    const rarityEmoji = {
      common: 'üêü',
      uncommon: 'üê†',
      rare: 'üê°',
      epic: 'üê¨',
      legendary: 'üêâ'
    };

    addLog(`${rarityEmoji[fish.rarity]} –ü–æ–π–º–∞–Ω–∞ —Ä—ã–±–∞: ${fish.name}!`, fish.rarity === 'legendary' || fish.rarity === 'epic' ? 'epic' : 'good');
    addNotification(`${rarityEmoji[fish.rarity]} –ü–æ–π–º–∞–Ω–∞: ${fish.name}!`, fish.rarity === 'legendary' ? 'legendary' : fish.rarity === 'epic' ? 'warning' : 'success');

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => setFishingState(null), 3000);
  };

  const determineFish = () => {
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä—ã–± –ø–æ —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏
    const availableFish = FISH_DB.filter(fish => fish.locations.includes(player.locationId));
    
    if (availableFish.length === 0) {
      // Fallback –Ω–∞ –ª—é–±—É—é —Ä—ã–±—É
      return FISH_DB[getRandomInt(0, FISH_DB.length - 1)];
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
    const rarityChances = {
      common: 0.50,      // 50%
      uncommon: 0.30,    // 30%
      rare: 0.15,        // 15%
      epic: 0.04,        // 4%
      legendary: 0.01    // 1%
    };

    // –ë–æ–Ω—É—Å –æ—Ç —É—Ä–æ–≤–Ω—è –∏–≥—Ä–æ–∫–∞ (–∫–∞–∂–¥—ã–µ 5 —É—Ä–æ–≤–Ω–µ–π +1% –∫ —Ä–µ–¥–∫–∏–º)
    const levelBonus = Math.floor(player.level / 5) * 0.01;
    rarityChances.rare += levelBonus;
    rarityChances.epic += levelBonus / 2;
    rarityChances.legendary += levelBonus / 4;

    // –í—ã–±–∏—Ä–∞–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å
    const rarityRoll = Math.random();
    let selectedRarity = 'common';
    let cumulativeChance = 0;

    for (const [rarity, chance] of Object.entries(rarityChances)) {
      cumulativeChance += chance;
      if (rarityRoll <= cumulativeChance) {
        selectedRarity = rarity;
        break;
      }
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä—ã–± –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏
    const fishOfRarity = availableFish.filter(f => f.rarity === selectedRarity);
    
    if (fishOfRarity.length > 0) {
      return fishOfRarity[getRandomInt(0, fishOfRarity.length - 1)];
    }

    // Fallback –Ω–∞ –ª—é–±—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é —Ä—ã–±—É
    return availableFish[getRandomInt(0, availableFish.length - 1)];
  };

  const cancelFishing = () => {
    if (fishingTimerRef.current) {
      clearTimeout(fishingTimerRef.current);
    }
    setFishingState(null);
    addLog('–í—ã –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª–∏ —Ä—ã–±–∞–ª–∫—É.', 'neutral');
  };

  // --- –ú–ï–•–ê–ù–ò–ö–ê: –ì–ò–õ–¨–î–ò–ò ---

  const createGuild = (guildName) => {
    if (player.gold < 1000) {
      addLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–∏–ª—å–¥–∏–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è 1000).', 'bad');
      return;
    }

    if (player.guildId) {
      addLog('–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –≥–∏–ª—å–¥–∏–∏!', 'bad');
      return;
    }

    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –±—ã –≥–∏–ª—å–¥–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –∫ —Å–ª—É—á–∞–π–Ω–æ–π –≥–∏–ª—å–¥–∏–∏
    const randomGuild = GUILDS[getRandomInt(0, GUILDS.length - 1)];
    
    setPlayer(p => ({
      ...p,
      gold: p.gold - 1000,
      guildId: randomGuild.id,
      guildRole: 'leader',
      guildContribution: 0
    }));

    addLog(`–ì–∏–ª—å–¥–∏—è "${guildName}" —Å–æ–∑–¥–∞–Ω–∞! (–î–µ–º–æ: –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω—ã –∫ ${randomGuild.name})`, 'good');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥–∏–ª—å–¥–∏–∏
    setTimeout(() => checkAchievements(), 100);
  };

  const joinGuild = (guildId) => {
    if (player.guildId) {
      addLog('–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –≥–∏–ª—å–¥–∏–∏!', 'bad');
      return;
    }

    setPlayer(p => ({
      ...p,
      guildId: guildId,
      guildRole: 'member',
      guildContribution: 0
    }));

    const guild = GUILDS.find(g => g.id === guildId);
    addLog(`–í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –≥–∏–ª—å–¥–∏—é "${guild?.name}"!`, 'good');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –≥–∏–ª—å–¥–∏—é
    setTimeout(() => checkAchievements(), 100);
  };

  const leaveGuild = () => {
    setPlayer(p => ({
      ...p,
      guildId: null,
      guildRole: null,
      guildContribution: 0
    }));
    addLog('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥–∏–ª—å–¥–∏—é.', 'neutral');
  };

  const applyGuildBonuses = (baseGold, baseExp) => {
    if (!player.guildId) return { gold: baseGold, exp: baseExp };

    const guild = GUILDS.find(g => g.id === player.guildId);
    if (!guild) return { gold: baseGold, exp: baseExp };

    const gold = Math.floor(baseGold * (1 + guild.bonuses.goldBonus / 100));
    const exp = Math.floor(baseExp * (1 + guild.bonuses.expBonus / 100));

    return { gold, exp };
  };

  // --- –°–ò–°–¢–ï–ú–ê –î–û–°–¢–ò–ñ–ï–ù–ò–ô ---

  const calculateAchievementProgress = useCallback((achievement, playerData) => {
    const req = achievement.requirement;
    let current = 0;

    switch (req.type) {
      case 'steps':
        current = playerData.totalSteps || 0;
        break;
      case 'kills':
        current = playerData.totalKills || 0;
        break;
      case 'crafts':
        current = playerData.totalCrafts || 0;
        break;
      case 'quests_completed':
        current = playerData.questsCompletedCount || 0;
        break;
      case 'guild_joined':
        current = playerData.guildId ? 1 : 0;
        break;
      case 'guild_created':
        current = playerData.guildRole === 'leader' ? 1 : 0;
        break;
      case 'avatars_collected':
        current = playerData.collectedAvatars?.length || 0;
        break;
      case 'legendary_items':
        current = playerData.inventory?.filter(item => item.rarity === 'legendary').length || 0;
        break;
      case 'gold_accumulated':
        current = playerData.gold || 0;
        break;
      case 'locations_visited':
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –ø–æ—Å–µ—Ç–∏–ª –≤—Å–µ –ª–æ–∫–∞—Ü–∏–∏ –¥–æ —Ç–µ–∫—É—â–µ–π
        current = LOCATIONS.filter(loc => loc.minLvl <= playerData.level).length;
        break;
      default:
        current = 0;
    }

    const progress = Math.min(100, Math.floor((current / req.value) * 100));
    return progress;
  }, []);

  const checkAchievements = () => {
    if (!player) return;

    const newUnlocked = [];

    ACHIEVEMENTS.forEach(achievement => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
      if (player.achievements.includes(achievement.id)) return;

      const progress = calculateAchievementProgress(achievement, player);

      if (progress >= 100) {
        newUnlocked.push(achievement.id);
      }
    });

    if (newUnlocked.length > 0) {
      setPlayer(p => ({
        ...p,
        achievements: [...p.achievements, ...newUnlocked],
        unclaimedAchievements: [...(p.unclaimedAchievements || []), ...newUnlocked]
      }));

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö
      newUnlocked.forEach(achId => {
        const ach = ACHIEVEMENTS.find(a => a.id === achId);
        if (ach) {
          addNotification(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${ach.name}!`, 'legendary');
          addLog(`–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${ach.name}!`, 'epic');
        }
      });
    }
  };

  const claimAchievementReward = (achievementId) => {
    const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
    if (!achievement) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ
    if (!player.achievements.includes(achievementId)) {
      addLog('–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!', 'bad');
      return;
    }

    if (!player.unclaimedAchievements.includes(achievementId)) {
      addLog('–ù–∞–≥—Ä–∞–¥–∞ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–∞!', 'bad');
      return;
    }

    // –í—ã–¥–∞–µ–º –Ω–∞–≥—Ä–∞–¥—ã
    const { gold = 0, exp = 0 } = achievement.reward;

    setPlayer(p => {
      const newExp = p.exp + exp;
      const newGold = p.gold + gold;
      
      // –£–¥–∞–ª—è–µ–º –∏–∑ –Ω–µ–≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã—Ö
      const newUnclaimed = p.unclaimedAchievements.filter(id => id !== achievementId);

      return {
        ...p,
        gold: newGold,
        exp: newExp,
        unclaimedAchievements: newUnclaimed
      };
    });

    addLog(`–ü–æ–ª—É—á–µ–Ω–∞ –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ "${achievement.name}": ${gold} –∑–æ–ª–æ—Ç–∞, ${exp} –æ–ø—ã—Ç–∞!`, 'good');
    addNotification(`–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: ${gold} üí∞ ${exp} ‚ú®`, 'success');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø—ã—Ç–∞
    setTimeout(() => {
      if (player.exp + exp >= player.maxExp) {
        levelUp();
      }
    }, 100);
  };

  // --- –ú–ï–•–ê–ù–ò–ö–ê: –ü–£–¢–ï–®–ï–°–¢–í–ò–ï ---

  const handleStep = () => {
    if (player.energy <= 0) {
      addLog("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏. –û—Ç–¥–æ—Ö–Ω–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.", 'bad');
      return;
    }

    const newEnergy = player.energy - 1;
    let newPlayer = { 
        ...player, 
        energy: newEnergy,
        totalSteps: (player.totalSteps || 0) + 1 // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —à–∞–≥–æ–≤
    };
    
    checkQuestProgress('step', 1);

    const roll = Math.random();
    
    if (roll < 0.15) {
      const loc = LOCATIONS.find(l => l.id === player.locationId);
      
      // –ü–æ–ª—É—á–∞–µ–º –ø—É–ª –≤—Ä–∞–≥–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏
      const locationEnemyNames = LOCATION_ENEMY_POOLS[loc.id] || ['–ó–ª–∞—è –ö—Ä—ã—Å–∞'];
      const enemyPool = ENEMIES_DB.filter(e => locationEnemyNames.includes(e.name));
      
      // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—Ä–∞–≥–∞ –∏–∑ –ø—É–ª–∞
      const enemyTemplate = enemyPool[getRandomInt(0, enemyPool.length - 1)] || ENEMIES_DB[0];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—É–¥–µ—Ç –ª–∏ —ç—Ç–æ —Ä–µ–¥–∫–∏–π –≤—Ä–∞–≥ (10% —à–∞–Ω—Å)
      const isRare = Math.random() < 0.1;
      const rareMultiplier = isRare ? 1.5 : 1;
      
      const enemy = {
        ...enemyTemplate,
        hp: Math.floor(enemyTemplate.baseHp * loc.enemyPower),
        maxHp: Math.floor(enemyTemplate.baseHp * loc.enemyPower),
        dmg: Math.floor(enemyTemplate.baseDmg * loc.enemyPower),
        exp: Math.floor(enemyTemplate.exp * rareMultiplier),
        gold: Math.floor(enemyTemplate.gold * rareMultiplier),
        isRare: isRare
      };

      setCombatState({ enemy, log: [] });
      const enemyPrefix = isRare ? '–†–ï–î–ö–û–ì–û –≤—Ä–∞–≥–∞' : '–≤—Ä–∞–≥–∞';
      addLog(`–í—ã –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ ${enemyPrefix}: ${enemy.name}!`, 'bad');
      if (isRare) {
        addNotification(`–í—Å—Ç—Ä–µ—á–µ–Ω —Ä–µ–¥–∫–∏–π –≤—Ä–∞–≥: ${enemy.name}! (+50% –Ω–∞–≥—Ä–∞–¥)`, 'warning');
      }
    } else if (roll < 0.25) {
      // Weighted random item selection based on rarity
      const rarityWeights = {
        common: 0.50,      // 50% chance
        uncommon: 0.30,    // 30% chance
        rare: 0.15,        // 15% chance
        epic: 0.04,        // 4% chance
        legendary: 0.01    // 1% chance
      };
      
      // Filter items by type (exclude resources from random drops)
      const droppableItems = ITEMS_DB.filter(item => item.type !== 'resource');
      
      // Select item based on weighted rarity
      let selectedItem = null;
      const rarityRoll = Math.random();
      let cumulativeWeight = 0;
      
      for (const [rarity, weight] of Object.entries(rarityWeights)) {
        cumulativeWeight += weight;
        if (rarityRoll <= cumulativeWeight) {
          const itemsOfRarity = droppableItems.filter(item => item.rarity === rarity);
          if (itemsOfRarity.length > 0) {
            selectedItem = itemsOfRarity[getRandomInt(0, itemsOfRarity.length - 1)];
            break;
          }
        }
      }
      
      // Fallback to random item if no item selected
      if (!selectedItem) {
        selectedItem = droppableItems[getRandomInt(0, droppableItems.length - 1)];
      }
      
      newPlayer.inventory = [...newPlayer.inventory, { ...selectedItem, uid: Date.now() }];
      addLog(`–í—ã –Ω–∞—à–ª–∏ –ø—Ä–µ–¥–º–µ—Ç: ${selectedItem.name}!`, selectedItem.rarity === 'legendary' || selectedItem.rarity === 'epic' ? 'epic' : 'good');
      
      // Add notification based on rarity
      const notifType = selectedItem.rarity === 'legendary' ? 'legendary' : selectedItem.rarity === 'epic' ? 'warning' : 'success';
      addNotification(`–ù–∞–π–¥–µ–Ω –ø—Ä–µ–¥–º–µ—Ç: ${selectedItem.name}!`, notifType);
      
      checkQuestProgress('find', 1); 
    } else if (roll < 0.50) {
      // –ù–û–í–û–ï: –®–∞–Ω—Å –Ω–∞–π—Ç–∏ —Ä–µ—Å—É—Ä—Å (35% –æ—Ç —ç—Ç–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞)
      if (Math.random() < 0.7) {
        const loc = LOCATIONS.find(l => l.id === player.locationId);
        const locationResources = RESOURCES.filter(r => r.locations.includes(loc.id));
        
        if (locationResources.length > 0) {
          // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ—Å—É—Ä—Å —Å —É—á–µ—Ç–æ–º —Ä–µ–¥–∫–æ—Å—Ç–∏
          const rarityChances = { common: 0.7, uncommon: 0.2, rare: 0.08, epic: 0.02 };
          let selectedResource = null;
          
          for (let i = 0; i < 10; i++) { // –ü—ã—Ç–∞–µ–º—Å—è 10 —Ä–∞–∑ –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–µ—Å—É—Ä—Å
            const resource = locationResources[getRandomInt(0, locationResources.length - 1)];
            if (Math.random() < (rarityChances[resource.rarity] || 0.1)) {
              selectedResource = resource;
              break;
            }
          }
          
          if (selectedResource) {
            newPlayer.resources = { ...newPlayer.resources };
            newPlayer.resources[selectedResource.id] = (newPlayer.resources[selectedResource.id] || 0) + 1;
            addLog(`–í—ã –Ω–∞—à–ª–∏ —Ä–µ—Å—É—Ä—Å: ${selectedResource.name}!`, 'good');
            
            // Add notification for resource
            const notifType = selectedResource.rarity === 'epic' || selectedResource.rarity === 'rare' ? 'warning' : 'info';
            addNotification(`–ù–∞–π–¥–µ–Ω —Ä–µ—Å—É—Ä—Å: ${selectedResource.name}!`, notifType);
          }
        }
      } else {
        const goldFound = getRandomInt(2, 10 * player.level);
        newPlayer.gold += goldFound;
        addLog(`–í—ã –Ω–∞—à–ª–∏ ${goldFound} –∑–æ–ª–æ—Ç–∞.`, 'good');
        checkQuestProgress('earn_gold', goldFound);
      }
    } else {
      const flavors = [
        "–í—ã –∏–¥–µ—Ç–µ –ø–æ —Ç—Ä–æ–ø–∏–Ω–∫–µ –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–µ—Ç–µ—Å—å –≤–∏–¥–æ–º.",
        "–ö—Ä–∞—Å–∏–≤—ã–π –≤–∏–¥ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –≤–∞–º–∏.",
        "–í—ã –ø–Ω—É–ª–∏ –∫–∞–º–µ—à–µ–∫ –∏ –æ–Ω –ø–æ–∫–∞—Ç–∏–ª—Å—è.",
        "–ù–∏—á–µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≥—É–ª–∫–∞.",
        "–í—ã —É—Å–ª—ã—à–∞–ª–∏ —à–æ—Ä–æ—Ö –≤ –∫—É—Å—Ç–∞—Ö, –Ω–æ —ç—Ç–æ –±—ã–ª –≤–µ—Ç–µ—Ä."
      ];
      addLog(flavors[getRandomInt(0, flavors.length - 1)]);
    }

    newPlayer.exp += 1;
    const lvlCheck = levelUp(newPlayer.exp, newPlayer.maxExp, newPlayer.level, newPlayer.classId);
    
    if (lvlCheck) {
      newPlayer.level = lvlCheck.lvl;
      newPlayer.exp = lvlCheck.exp;
      newPlayer.maxExp = lvlCheck.maxExp;
      newPlayer.str += lvlCheck.stats.str;
      newPlayer.def += lvlCheck.stats.def;
      newPlayer.maxHp += lvlCheck.stats.hp;
      newPlayer.hp = newPlayer.maxHp; 
      newPlayer.maxEnergy += lvlCheck.stats.energy;
      newPlayer.energy = newPlayer.maxEnergy; 
    }

    setPlayer(newPlayer);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —à–∞–≥–∞
    setTimeout(() => checkAchievements(), 100);
  };

  const handleCombatTurn = (action) => {
    if (!combatState) return;
    
    const { enemy } = combatState;
    let newEnemyHp = enemy.hp;
    let newPlayerHp = player.hp;
    let combatLog = [];

    if (action === 'attack') {
      const weaponDmg = player.equipment.weapon ? player.equipment.weapon.val : 0;
      const totalDmg = Math.floor((player.str + weaponDmg) * (getRandomInt(80, 120) / 100));
      newEnemyHp -= totalDmg;
      combatLog.push(`–í—ã –Ω–∞–Ω–µ—Å–ª–∏ ${totalDmg} —É—Ä–æ–Ω–∞ ${enemy.name}.`);
    } else if (action === 'flee') {
       if (Math.random() > 0.5) {
         setCombatState(null);
         addLog("–í—ã —É—Å–ø–µ—à–Ω–æ —Å–±–µ–∂–∞–ª–∏!", 'neutral');
         return;
       } else {
         combatLog.push("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±–µ–∂–∞—Ç—å!");
       }
    }

    if (newEnemyHp <= 0) {
      let baseGoldReward = Math.floor(enemy.gold * getRandomInt(80, 120) / 100);
      let baseExpReward = enemy.exp;
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –±–æ–Ω—É—Å—ã –≥–∏–ª—å–¥–∏–∏
      const rewards = applyGuildBonuses(baseGoldReward, baseExpReward);
      
      let newPlayer = { 
        ...player, 
        gold: player.gold + rewards.gold,
        exp: player.exp + rewards.exp,
        totalKills: (player.totalKills || 0) + 1 // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —É–±–∏–π—Å—Ç–≤
      };

      checkQuestProgress('kill', 1);
      checkQuestProgress('earn_gold', rewards.gold);

      const lvlCheck = levelUp(newPlayer.exp, newPlayer.maxExp, newPlayer.level, newPlayer.classId);
      if (lvlCheck) {
        newPlayer.level = lvlCheck.lvl;
        newPlayer.exp = lvlCheck.exp;
        newPlayer.maxExp = lvlCheck.maxExp;
        newPlayer.str += lvlCheck.stats.str;
        newPlayer.def += lvlCheck.stats.def;
        newPlayer.maxHp += lvlCheck.stats.hp;
        newPlayer.hp = newPlayer.maxHp;
        newPlayer.maxEnergy += lvlCheck.stats.energy;
        newPlayer.energy = newPlayer.maxEnergy;
      }

      setPlayer(newPlayer);
      setCombatState(null);
      addLog(`–ü–æ–±–µ–¥–∞! –ü–æ–ª—É—á–µ–Ω–æ ${rewards.exp} XP –∏ ${rewards.gold} –∑–æ–ª–æ—Ç–∞.`, 'good');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–±–µ–¥—ã
      setTimeout(() => checkAchievements(), 100);
      return;
    }

    const armorDef = player.equipment.armor ? player.equipment.armor.val : 0;
    const totalDef = player.def + armorDef;
    const enemyDmg = Math.max(1, Math.floor(enemy.dmg * (getRandomInt(80, 120) / 100) - (totalDef * 0.5)));
    
    newPlayerHp -= enemyDmg;
    combatLog.push(`${enemy.name} –Ω–∞–Ω–µ—Å –≤–∞–º ${enemyDmg} —É—Ä–æ–Ω–∞.`);

    if (newPlayerHp <= 0) {
      newPlayerHp = 0;
      setCombatState(null);
      addLog(`–í—ã –ø–æ–≥–∏–±–ª–∏ –æ—Ç —Ä—É–∫ ${enemy.name}. –í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ –Ω–µ–º–Ω–æ–≥–æ –∑–æ–ª–æ—Ç–∞.`, 'bad');
      setPlayer({
        ...player,
        hp: Math.floor(player.maxHp * 0.5),
        energy: 0,
        gold: Math.floor(player.gold * 0.8)
      });
    } else {
      setPlayer(p => ({ ...p, hp: newPlayerHp }));
      setCombatState({ 
        ...combatState, 
        enemy: { ...enemy, hp: newEnemyHp },
        log: combatLog
      });
    }
  };

  const equipItem = (item) => {
    let newEquipment = { ...player.equipment };
    let newInventory = player.inventory.filter(i => i.uid !== item.uid);

    if (newEquipment[item.type]) {
      newInventory.push(newEquipment[item.type]);
    }

    newEquipment[item.type] = item;
    setPlayer({ ...player, equipment: newEquipment, inventory: newInventory });
    addLog(`–í—ã —ç–∫–∏–ø–∏—Ä–æ–≤–∞–ª–∏ ${item.name}.`, 'neutral');
  };

  const useItem = (item) => {
    if (item.type === 'consumable') {
      const healed = Math.min(player.maxHp - player.hp, item.val);
      setPlayer({
        ...player,
        hp: player.hp + healed,
        inventory: player.inventory.filter(i => i.uid !== item.uid)
      });
      addLog(`–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ ${item.name} –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ ${healed} HP.`, 'good');
    }
  };

  const sellItem = (item) => {
    const goldEarned = Math.floor(item.cost / 2);
    setPlayer({
      ...player,
      gold: player.gold + goldEarned,
      inventory: player.inventory.filter(i => i.uid !== item.uid)
    });
    addLog(`–í—ã –ø—Ä–æ–¥–∞–ª–∏ ${item.name} –∑–∞ ${goldEarned} –∑–æ–ª–æ—Ç–∞.`, 'neutral');
    checkQuestProgress('earn_gold', goldEarned);
  };

  if (gameStage === 'creation') {
    return <CharacterCreation onComplete={(data) => { setPlayer(data); setGameStage('playing'); }} />;
  }

  const PlayerAvatarIcon = AVATARS_DB.find(a => a.id === player.avatarId)?.icon || User;
  const PlayerAvatarColor = AVATARS_DB.find(a => a.id === player.avatarId)?.color || 'bg-blue-500';

  return (
    <div className="flex h-screen bg-slate-950 text-slate-200 font-sans overflow-hidden">
      
      {/* --- NOTIFICATION SYSTEM --- */}
      <NotificationSystem notifications={notifications} />
      
      {/* --- MOBILE BACKDROP --- */}
      {isSidebarOpen && (
        <div 
          className="fixed inset-0 bg-black/50 z-40 md:hidden"
          onClick={() => setSidebarOpen(false)}
        ></div>
      )}
      
      {/* --- SIDEBAR --- */}
      <aside className={`
        fixed inset-y-0 left-0 z-50 w-64 bg-[#0f172a] border-r border-slate-800 transform transition-transform duration-300
        md:relative md:translate-x-0 overflow-y-auto custom-scrollbar flex flex-col
        ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}
      `}>
         
        {/* Mobile Close Button */}
        <button 
          onClick={() => setSidebarOpen(false)}
          className="md:hidden absolute top-4 right-4 text-slate-400 hover:text-white transition-colors z-10"
        >
          <X size={24} />
        </button>
         
        {/* Profile Header Block */}
        <div className="flex flex-col items-center pt-8 pb-6">
           {/* Avatar */}
           <div className="relative group cursor-pointer" onClick={() => {setActiveTab('character'); setSidebarOpen(false)}}>
             <div className={`w-20 h-20 rounded-full flex items-center justify-center border-2 border-orange-500 shadow-[0_0_20px_rgba(147,51,234,0.3)] bg-[#0f172a] group-hover:shadow-[0_0_25px_rgba(249,115,22,0.4)] transition-all duration-300`}>
               <PlayerAvatarIcon size={36} className="text-purple-400 group-hover:text-orange-400 transition-colors" />
             </div>
             {/* Online Status Indicator */}
             <div className="absolute bottom-1 right-1 w-4 h-4 bg-green-500 border-2 border-[#0f172a] rounded-full"></div>
           </div>

           {/* Name & Stats */}
           <div className="mt-4 text-center">
             <div className="text-lg font-bold text-white tracking-wide">{player.name}</div>
             
             {/* Badges */}
             <div className="flex items-center justify-center gap-2 mt-1 flex-wrap">
               <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-purple-500/10 text-purple-400 border border-purple-500/20 uppercase tracking-wider">
                 {player.className}
               </span>
               <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-800 text-slate-400 border border-slate-700">
                 Lvl {player.level}
               </span>
               {player.guildId && (
                 <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20 uppercase tracking-wider">
                   <Users size={10} className="inline mr-1" />
                   Guild
                 </span>
               )}
               {player.profession && (
                 <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-orange-500/10 text-orange-400 border border-orange-500/20 uppercase tracking-wider">
                   <Hammer size={10} className="inline mr-1" />
                   {PROFESSIONS.find(p => p.id === player.profession)?.name || '–ü—Ä–æ—Ñ–µ—Å—Å–∏—è'}
                 </span>
               )}
             </div>
             
             {/* Mini Currency Display */}
             <div className="flex items-center justify-center gap-3 mt-3 bg-slate-900/50 px-3 py-1 rounded-lg border border-slate-800/50">
                <div className="flex items-center gap-1">
                  <Coins size={12} className="text-yellow-500" />
                  <span className="text-xs font-bold text-slate-300">{player.gold}</span>
                </div>
                <div className="w-px h-3 bg-slate-700"></div>
                <div className="flex items-center gap-1">
                  <Sparkles size={12} className="text-blue-400" />
                  <span className="text-xs font-bold text-slate-300">0</span>
                </div>
             </div>
           </div>
        </div>

        {/* –ú–µ–Ω—é –ù–∞–≤–∏–≥–∞—Ü–∏–∏ */}
        <nav className="p-4 flex-1">
          
          <NavGroup title="–ì–õ–ê–í–ù–û–ï">
            <NavItem 
              label="–î–æ–º–æ–π" 
              icon={LayoutDashboard} 
              active={activeTab === 'home'} 
              onClick={() => {setActiveTab('home'); setSidebarOpen(false)}} 
            />
            <NavItem 
              label="–ì–æ—Ä–æ–¥" 
              icon={MapIcon} 
              active={activeTab === 'city'} 
              onClick={() => {setActiveTab('city'); setSidebarOpen(false)}} 
            />
            <NavItem 
              label="–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å" 
              icon={Zap} 
              active={activeTab === 'inventory'} 
              onClick={() => {setActiveTab('inventory'); setSidebarOpen(false)}} 
            />
            <NavItem 
              label="–°—Ä–∞–∂–µ–Ω–∏—è" 
              icon={Flame} 
              active={activeTab === 'battles'} 
              onClick={() => {setActiveTab('battles'); setSidebarOpen(false)}} 
            />
            <NavItem 
              label="–ö–≤–µ—Å—Ç—ã" 
              icon={CheckCircle} 
              active={activeTab === 'quests'} 
              onClick={() => {setActiveTab('quests'); setSidebarOpen(false)}} 
              badge={player.activeQuests && player.activeQuests.some(q => q.isCompleted) ? '!' : null}
            />
            <NavItem 
              label="–†—ã–±–∞–ª–∫–∞" 
              icon={Gift} 
              active={activeTab === 'fishing'} 
              onClick={() => {setActiveTab('fishing'); setSidebarOpen(false)}} 
            />
          </NavGroup>

          <NavGroup title="–ü–ï–†–°–û–ù–ê–ñ">
            <NavItem 
              label="–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–∂" 
              icon={Shield} 
              active={activeTab === 'character'} 
              onClick={() => {setActiveTab('character'); setSidebarOpen(false)}} 
            />
            <NavItem 
              label="–ü—Ä–æ—Ñ–µ—Å—Å–∏—è" 
              icon={Briefcase} 
              active={activeTab === 'profession'} 
              onClick={() => {setActiveTab('profession'); setSidebarOpen(false)}} 
            />
            <NavItem 
              label="–ö—Ä–∞—Ñ—Ç" 
              icon={Sparkles} 
              active={activeTab === 'craft'} 
              onClick={() => {setActiveTab('craft'); setSidebarOpen(false)}} 
            />
            <NavItem 
              label="–ó–∞–¥–∞–Ω–∏—è" 
              icon={Scroll} 
              active={activeTab === 'tasks'} 
              onClick={() => {setActiveTab('tasks'); setSidebarOpen(false)}} 
            />
             <NavItem 
              label="–ö–æ–ª–ª–µ–∫—Ü–∏–∏" 
              icon={Folder} 
              active={activeTab === 'collections'} 
              onClick={() => {setActiveTab('collections'); setSidebarOpen(false)}} 
            />
            <NavItem 
              label="–ì–∏–ª—å–¥–∏–∏" 
              icon={Users} 
              active={activeTab === 'guilds'} 
              onClick={() => {setActiveTab('guilds'); setSidebarOpen(false)}} 
            />
            <NavItem 
              label="–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è" 
              icon={Trophy} 
              active={activeTab === 'achievements'} 
              onClick={() => {setActiveTab('achievements'); setSidebarOpen(false)}} 
              badge={player.unclaimedAchievements && player.unclaimedAchievements.length > 0 ? player.unclaimedAchievements.length : null}
            />
            <NavItem 
              label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" 
              icon={Settings} 
              active={activeTab === 'settings'} 
              onClick={() => {setActiveTab('settings'); setSidebarOpen(false)}} 
            />
          </NavGroup>

        </nav>
      </aside>

      {/* --- MAIN CONTENT --- */}
      <main className="flex-1 flex flex-col h-full relative bg-[#020617]">
        {/* Mobile Header */}
        <header className="md:hidden bg-slate-900 p-4 flex items-center justify-between border-b border-slate-800">
          <button onClick={() => setSidebarOpen(true)} className="text-slate-300">
            <Menu />
          </button>
          <span className="font-bold text-slate-100">SimpleMMO</span>
          <div className="w-6"></div> 
        </header>

        {/* Stats Bar */}
        <div className="bg-slate-900 border-b border-slate-800 p-2 md:p-4 grid grid-cols-3 gap-4 shadow-md z-10 text-xs md:text-sm">
          <ProgressBar value={player.hp} max={player.maxHp} color="bg-red-500" label="–ó–¥–æ—Ä–æ–≤—å–µ" icon={Heart} />
          <ProgressBar 
            value={player.energy} 
            max={player.maxEnergy} 
            color={player.energy < 5 ? 'bg-orange-500 animate-pulse' : 'bg-yellow-500'} 
            label="–≠–Ω–µ—Ä–≥–∏—è" 
            icon={Zap} 
          />
          <ProgressBar value={player.exp} max={player.maxExp} color="bg-green-500" label="–û–ø—ã—Ç" icon={Trophy} />
        </div>

        {/* Level Up Overlay */}
        {showLevelUp && (
          <div className="absolute inset-0 z-50 flex items-center justify-center pointer-events-none">
            <div className="bg-yellow-500 text-slate-900 font-bold px-8 py-4 rounded-xl shadow-2xl transform scale-125 animate-bounce">
              –ù–û–í–´–ô –£–†–û–í–ï–ù–¨!
            </div>
          </div>
        )}

        <div className="flex-1 overflow-y-auto relative">
          
          {/* --- BATTLE MODE --- */}
          {combatState ? (
            <div className="max-w-2xl mx-auto p-4 md:p-8 animate-in fade-in zoom-in duration-300">
              <Card title="–°—Ä–∞–∂–µ–Ω–∏–µ!" icon={Sword} className="border-red-900/50 bg-slate-900/90">
                <div className="flex justify-between items-center mb-8">
                  <div className="text-center">
                    <div className={`w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center ${PlayerAvatarColor}`}>
                       <PlayerAvatarIcon className="text-white" size={32} />
                    </div>
                    <div className="font-bold text-lg">{player.name}</div>
                    <div className="text-sm text-slate-400">HP: {player.hp}/{player.maxHp}</div>
                  </div>
                  <div className="text-2xl font-bold text-red-500">VS</div>
                  <div className="text-center">
                    <div className="w-16 h-16 rounded-full mx-auto mb-2 flex items-center justify-center bg-red-900/50 border border-red-500">
                       <Skull size={32} className="text-red-500" />
                    </div>
                    <div className="font-bold text-lg">{combatState.enemy.name}</div>
                    <div className="text-sm text-slate-400">HP: {combatState.enemy.hp}/{combatState.enemy.maxHp}</div>
                  </div>
                </div>

                <div className="mb-6 space-y-2 bg-slate-950 p-4 rounded-lg h-32 overflow-y-auto border border-slate-800">
                  {combatState.log.length === 0 && <div className="text-slate-600 text-center italic">–ë–∏—Ç–≤–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...</div>}
                  {combatState.log.map((l, i) => (
                    <div key={i} className="text-sm text-slate-300">{l}</div>
                  ))}
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <Button onClick={() => handleCombatTurn('attack')} variant="danger">
                    <Sword size={18} /> –ê—Ç–∞–∫–∞
                  </Button>
                  <Button onClick={() => handleCombatTurn('flee')} variant="secondary">
                    –ë–µ–∂–∞—Ç—å
                  </Button>
                </div>
              </Card>
            </div>
          ) : (
            <>
              {/* --- TAB: –î–û–ú–û–ô (–ü–£–¢–ï–®–ï–°–¢–í–ò–ï) --- */}
              {activeTab === 'home' && (
                <div className="flex flex-col h-full relative">
                  {/* Container for the visual scene */}
                  <div className="relative h-2/3 w-full overflow-hidden flex flex-col items-center justify-center group">
                    
                    {/* --- BACKGROUND LAYERS --- */}
                    <div className="absolute inset-0 bg-gradient-to-b from-slate-900 via-[#1a1d2d] to-[#2d3748] z-0"></div>
                    <div className="absolute top-10 left-10 w-1 h-1 bg-white rounded-full opacity-50 z-0"></div>
                    <div className="absolute top-20 left-1/4 w-0.5 h-0.5 bg-white rounded-full opacity-70 z-0"></div>
                    <div className="absolute top-14 right-1/3 w-1 h-1 bg-white rounded-full opacity-30 z-0"></div>
                    <div className="absolute top-8 right-10 w-1 h-1 bg-white rounded-full opacity-60 z-0"></div>
                    <div className="absolute bottom-20 left-[-10%] w-[50%] h-64 bg-[#1f2937] rounded-tr-[100%] opacity-80 z-0 transform skew-x-12"></div>
                    <div className="absolute bottom-20 right-[-10%] w-[60%] h-80 bg-[#1e2536] rounded-tl-[100%] opacity-80 z-0 transform -skew-x-12"></div>
                    <div className="absolute bottom-16 left-[20%] w-[60%] h-56 bg-[#252f44] rounded-t-[40%] z-0"></div>
                    <div className="absolute bottom-0 w-full h-32 bg-[#143314] z-0 opacity-40 rounded-t-[50%] scale-150 translate-y-10"></div>
                    <div className="absolute bottom-0 w-full h-16 bg-[#0f220f] z-0 border-t-4 border-[#1a441a]"></div>
                    <div className="absolute bottom-16 left-4 text-[#1a441a]">
                        <div className="w-0 h-0 border-l-[20px] border-l-transparent border-r-[20px] border-r-transparent border-b-[60px] border-b-[#0c1e0c]"></div>
                    </div>
                     <div className="absolute bottom-16 right-12 text-[#1a441a]">
                        <div className="w-0 h-0 border-l-[30px] border-l-transparent border-r-[30px] border-r-transparent border-b-[80px] border-b-[#0c1e0c]"></div>
                    </div>

                    {/* --- CONTENT OVERLAY --- */}
                    <div className="absolute top-4 right-4 flex gap-2 z-20">
                      <button className="bg-black/60 hover:bg-black/80 text-white text-xs px-3 py-1.5 rounded border border-white/10 flex items-center gap-1 backdrop-blur-sm transition-colors">
                        <Users size={14} /> –í–µ—á–µ—Ä–∏–Ω–∫–∞
                      </button>
                      <button className="bg-black/60 hover:bg-black/80 text-white text-xs px-3 py-1.5 rounded border border-white/10 flex items-center gap-1 backdrop-blur-sm transition-colors">
                        <FlaskConical size={14} /> –ó–µ–ª—å—è
                      </button>
                      <button className="bg-black/60 hover:bg-black/80 text-white text-xs px-3 py-1.5 rounded border border-white/10 flex items-center gap-1 backdrop-blur-sm transition-colors">
                        <Wind size={14} /> –°–ø—Ä–∏–Ω—Ç
                      </button>
                    </div>

                    <div className="relative z-10 w-full max-w-lg px-4 mb-8">
                       <div className="bg-black/80 text-center p-6 rounded-lg border border-slate-700/50 backdrop-blur-md shadow-2xl animate-in zoom-in-95 duration-200">
                         <h3 className="text-white font-bold mb-2 text-lg">–¢—ã –¥–µ–ª–∞–µ—à—å —à–∞–≥...</h3>
                         <p className="text-slate-300 text-sm leading-relaxed">
                           {lastStepText}
                         </p>
                       </div>
                    </div>

                    <div className="relative z-10">
                      <Button onClick={handleStep} variant="purple" className="px-10 py-4 text-xl font-bold rounded-lg transform transition-transform active:scale-95 flex items-center gap-3 shadow-[0_0_30px_rgba(99,102,241,0.4)] border border-indigo-400/30">
                         <Footprints size={28} /> –°–¥–µ–ª–∞–π —à–∞–≥
                      </Button>
                    </div>

                    <div className="absolute bottom-6 left-6 bg-black/60 px-4 py-1.5 rounded-full text-xs text-slate-300 border border-white/10 backdrop-blur-md flex items-center gap-2 z-10 cursor-pointer hover:bg-black/80 transition-colors group" onClick={() => setShowLocationSelector(!showLocationSelector)}>
                      <MapPin size={14} className="text-green-400" />
                      {LOCATIONS.find(l => l.id === player.locationId)?.name}
                      <ChevronRight size={14} className="text-slate-400 group-hover:text-white transition-colors" />
                    </div>
                    
                    {/* Location Selector Popup */}
                    {showLocationSelector && (
                      <div className="absolute bottom-20 left-6 bg-slate-900 border border-slate-700 rounded-lg p-4 z-20 w-80 shadow-2xl animate-in fade-in zoom-in duration-200">
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="text-white font-bold text-sm">–í—ã–±—Ä–∞—Ç—å –ª–æ–∫–∞—Ü–∏—é</h3>
                          <button onClick={() => setShowLocationSelector(false)} className="text-slate-400 hover:text-white transition-colors">
                            <X size={16} />
                          </button>
                        </div>
                        <div className="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                          {LOCATIONS.map(loc => {
                            const isUnlocked = player.level >= loc.minLvl;
                            const isCurrent = loc.id === player.locationId;
                            return (
                              <button
                                key={loc.id}
                                onClick={() => {
                                  if (isUnlocked && !isCurrent) {
                                    setPlayer(prev => ({ ...prev, locationId: loc.id }));
                                    addLog(`–í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å –≤: ${loc.name}`, 'info');
                                    setShowLocationSelector(false);
                                  }
                                }}
                                disabled={!isUnlocked || isCurrent}
                                className={`w-full text-left p-3 rounded-lg border transition-all ${
                                  isCurrent 
                                    ? 'bg-green-900/20 border-green-700 cursor-default' 
                                    : isUnlocked 
                                      ? 'bg-slate-800 border-slate-700 hover:bg-slate-700 hover:border-slate-600 cursor-pointer' 
                                      : 'bg-slate-900/50 border-slate-800 opacity-50 cursor-not-allowed'
                                }`}
                              >
                                <div className="flex items-center justify-between mb-1">
                                  <span className={`font-bold text-sm ${isCurrent ? 'text-green-400' : isUnlocked ? 'text-white' : 'text-slate-500'}`}>
                                    {loc.name}
                                    {isCurrent && <span className="ml-2 text-xs text-green-500">(—Ç–µ–∫—É—â–∞—è)</span>}
                                  </span>
                                  {!isUnlocked && (
                                    <Lock size={14} className="text-red-400" />
                                  )}
                                </div>
                                <p className={`text-xs ${isUnlocked ? 'text-slate-400' : 'text-slate-600'}`}>
                                  {loc.text}
                                </p>
                                <div className="flex items-center gap-3 mt-2 text-xs">
                                  <span className={isUnlocked ? 'text-slate-500' : 'text-red-400'}>
                                    –£—Ä–æ–≤–µ–Ω—å: {loc.minLvl}
                                  </span>
                                  <span className={isUnlocked ? 'text-amber-500' : 'text-slate-600'}>
                                    –°–ª–æ–∂–Ω–æ—Å—Ç—å: {loc.enemyPower}x
                                  </span>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      </div>
                    )}
                  </div>

                  {/* History Log Section */}
                  <div className="h-1/3 bg-[#0b0f19] p-4 border-t border-slate-800 overflow-y-auto custom-scrollbar">
                    <div className="text-xs font-bold text-[#475569] uppercase mb-3 tracking-widest pl-2 border-l-2 border-blue-900">–ò—Å—Ç–æ—Ä–∏—è</div>
                    <div className="space-y-1">
                       {logs.slice(-6).reverse().map(log => (
                         <div key={log.id} className={`text-sm py-1 px-2 rounded hover:bg-white/5 transition-colors ${log.type}`}>
                           <span className="text-slate-600 text-xs mr-3 font-mono">[{new Date(log.id).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}]</span>
                           {log.text}
                         </div>
                       ))}
                    </div>
                  </div>
                </div>
              )}

              {/* --- TAB: –ò–ù–í–ï–ù–¢–ê–†–¨ --- */}
              {activeTab === 'inventory' && (
                <div className="max-w-3xl mx-auto p-4 md:p-8">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-2xl font-bold">–†—é–∫–∑–∞–∫</h2>
                    <div className="flex items-center gap-2 text-yellow-500 font-mono bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">
                      <Coins size={16} /> {player.gold}
                    </div>
                  </div>

                  {/* –†–ï–°–£–†–°–´ */}
                  {Object.keys(player.resources || {}).length > 0 && (
                    <div className="mb-6">
                      <h3 className="text-lg font-bold mb-3 flex items-center gap-2">
                        <Box size={20} className="text-amber-500" />
                        –†–µ—Å—É—Ä—Å—ã
                      </h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                        {Object.entries(player.resources).map(([resourceId, count]) => {
                          const resource = RESOURCES.find(r => r.id === resourceId);
                          if (!resource) return null;
                          
                          const rarityClass = RARITY_COLORS[resource.rarity] || RARITY_COLORS.common;
                          const rarityBg = RARITY_BG[resource.rarity] || RARITY_BG.common;
                          
                          const tooltipContent = (
                            <div className="text-left">
                              <div className={`font-bold mb-1 ${rarityClass.split(' ')[0]}`}>{resource.name}</div>
                              <div className="text-xs text-slate-400">–†–µ–¥–∫–æ—Å—Ç—å: {resource.rarity}</div>
                              <div className="text-xs text-slate-500">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {count}</div>
                            </div>
                          );
                          
                          return (
                            <Tooltip key={resourceId} content={tooltipContent} position="top">
                              <div className={`${rarityBg} p-3 rounded-lg border-2 ${rarityClass.split(' ')[1]} flex items-center gap-2 hover:scale-105 transition-all duration-200`}>
                                <resource.icon size={20} className={rarityClass.split(' ')[0]} />
                                <div className="flex-1 min-w-0">
                                  <div className={`text-xs font-bold truncate ${rarityClass.split(' ')[0]}`}>{resource.name}</div>
                                  <div className="text-xs opacity-70">x{count}</div>
                                </div>
                              </div>
                            </Tooltip>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {/* –ü–†–ï–î–ú–ï–¢–´ */}
                  <h3 className="text-lg font-bold mb-3 flex items-center gap-2">
                    <Backpack size={20} className="text-blue-500" />
                    –ü—Ä–µ–¥–º–µ—Ç—ã
                  </h3>
                  {player.inventory.length === 0 ? (
                    <div className="text-center py-20 bg-slate-900 rounded-xl border border-slate-800 border-dashed text-slate-500">
                      –†—é–∫–∑–∞–∫ –ø—É—Å—Ç. –ò–¥–∏—Ç–µ –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç—ã!
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      {player.inventory.map((item) => {
                        const rarityClass = RARITY_COLORS[item.rarity] || RARITY_COLORS.common;
                        const rarityBg = RARITY_BG[item.rarity] || RARITY_BG.common;
                        const glowEffect = item.rarity === 'legendary' ? 'shadow-[0_0_15px_rgba(251,146,60,0.5)]' : item.rarity === 'epic' ? 'shadow-[0_0_10px_rgba(168,85,247,0.3)]' : '';
                        
                        const tooltipContent = (
                          <div className="text-left">
                            <div className={`font-bold mb-1 ${rarityClass.split(' ')[0]}`}>{item.name}</div>
                            <div className="text-xs text-slate-400 mb-2">
                              {item.type === 'weapon' && `–£—Ä–æ–Ω: +${item.val}`}
                              {item.type === 'armor' && `–ó–∞—â–∏—Ç–∞: +${item.val}`}
                              {item.type === 'consumable' && `–õ–µ—á–∏—Ç: +${item.val} HP`}
                            </div>
                            {item.effect && (
                              <div className="text-xs text-purple-400 mb-2 border-t border-slate-700 pt-2">
                                <span className="text-slate-500">–≠—Ñ—Ñ–µ–∫—Ç:</span> {item.effect}
                              </div>
                            )}
                            <div className="text-xs text-slate-500">
                              –†–µ–¥–∫–æ—Å—Ç—å: {item.rarity}
                            </div>
                            <div className="text-xs text-slate-500">
                              –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: {Math.floor(item.cost/2)} –∑–æ–ª–æ—Ç–∞
                            </div>
                          </div>
                        );
                        
                        return (
                          <Tooltip key={item.uid} content={tooltipContent} position="top">
                            <div className={`${rarityBg} p-3 rounded-lg border-2 ${rarityClass.split(' ')[1]} ${glowEffect} flex items-center justify-between group hover:scale-105 transition-all duration-200`}>
                              <div className="flex items-center gap-3">
                                <div className={`w-10 h-10 rounded flex items-center justify-center ${rarityBg} border ${rarityClass.split(' ')[1]}`}>
                                  {item.type === 'weapon' ? <Sword size={20} className={rarityClass.split(' ')[0]}/> : item.type === 'armor' ? <Shield size={20} className={rarityClass.split(' ')[0]}/> : <Heart size={20} className={rarityClass.split(' ')[0]}/>}
                                </div>
                                <div>
                                  <div className={`font-bold text-sm ${rarityClass.split(' ')[0]}`}>{item.name}</div>
                                  <div className="text-xs text-slate-500">
                                    {item.type === 'weapon' && `–£—Ä–æ–Ω: +${item.val}`}
                                    {item.type === 'armor' && `–ó–∞—â–∏—Ç–∞: +${item.val}`}
                                    {item.type === 'consumable' && `–õ–µ—á–∏—Ç: +${item.val}`}
                                  </div>
                                </div>
                              </div>
                              <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                {item.type !== 'consumable' && (
                                  <button onClick={() => equipItem(item)} className="p-2 bg-blue-600 rounded text-white hover:bg-blue-500 text-xs active:scale-95 transition-all">–ù–∞–¥–µ—Ç—å</button>
                                )}
                                {item.type === 'consumable' && (
                                  <button onClick={() => useItem(item)} className="p-2 bg-green-600 rounded text-white hover:bg-green-500 text-xs active:scale-95 transition-all">–ò—Å–ø.</button>
                                )}
                                <button onClick={() => sellItem(item)} className="p-2 bg-slate-700 rounded text-slate-300 hover:bg-red-900 hover:text-white text-xs active:scale-95 transition-all">–ü—Ä–æ–¥–∞—Ç—å</button>
                              </div>
                            </div>
                          </Tooltip>
                        );
                      })}
                    </div>
                  )}
                </div>
              )}

              {/* --- TAB: –°–†–ê–ñ–ï–ù–ò–Ø (–ê–†–ï–ù–ê) --- */}
              {activeTab === 'battles' && (
                <div className="max-w-3xl mx-auto p-4 md:p-8 space-y-6">
                   <div className="flex items-center justify-between mb-6">
                    <div>
                       <h2 className="text-2xl font-bold">–ê—Ä–µ–Ω–∞</h2>
                       <p className="text-slate-400 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –¥–ª—è —Å—Ä–∞–∂–µ–Ω–∏—è.</p>
                    </div>
                    <div className="bg-slate-900 px-4 py-2 rounded-lg border border-slate-800 text-sm">
                       <span className="text-slate-500 mr-2">–í–∞—à–∞ —Å–∏–ª–∞:</span>
                       <span className="text-red-400 font-bold">{player.str + (player.equipment.weapon?.val || 0)}</span>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 gap-4">
                    {ENEMIES_DB.map((enemy, index) => {
                       const playerDmg = player.str + (player.equipment.weapon?.val || 0);
                       const playerDef = player.def + (player.equipment.armor?.val || 0);
                       const enemyDmg = Math.max(1, enemy.baseDmg - (playerDef * 0.5));
                       const roundsToKillEnemy = Math.ceil(enemy.baseHp / playerDmg);
                       const roundsToDie = Math.ceil(player.hp / enemyDmg);
                       
                       let difficulty = '–õ–µ–≥–∫–æ';
                       let diffColor = 'text-green-500';
                       
                       if (roundsToKillEnemy > roundsToDie) {
                          difficulty = '–°–º–µ—Ä—Ç–µ–ª—å–Ω–æ';
                          diffColor = 'text-red-600';
                       } else if (roundsToKillEnemy > roundsToDie * 0.6) {
                          difficulty = '–°–ª–æ–∂–Ω–æ';
                          diffColor = 'text-orange-500';
                       } else if (roundsToKillEnemy > roundsToDie * 0.3) {
                          difficulty = '–ù–æ—Ä–º–∞–ª—å–Ω–æ';
                          diffColor = 'text-yellow-500';
                       }

                       return (
                        <div key={index} className="bg-slate-900 p-4 rounded-xl border border-slate-800 flex items-center justify-between hover:border-slate-600 transition-all">
                          <div className="flex items-center gap-4">
                             <div className="w-14 h-14 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 shadow-inner">
                               <Skull size={28} className={diffColor} />
                             </div>
                             <div>
                               <h4 className="font-bold text-slate-200 text-lg">{enemy.name}</h4>
                               <div className="flex gap-4 text-xs text-slate-500 mt-1">
                                 <span className="flex items-center gap-1"><Heart size={10} /> {enemy.baseHp} HP</span>
                                 <span className="flex items-center gap-1"><Sword size={10} /> {enemy.baseDmg} ATK</span>
                               </div>
                             </div>
                          </div>
                          
                          <div className="text-right flex flex-col items-end gap-2">
                             <div className={`text-xs font-bold uppercase tracking-wider ${diffColor}`}>
                               {difficulty}
                             </div>
                             <Button 
                               onClick={() => {
                                 setCombatState({ 
                                   enemy: { 
                                     ...enemy, 
                                     hp: enemy.baseHp, 
                                     maxHp: enemy.baseHp, 
                                     dmg: enemy.baseDmg 
                                   }, 
                                   log: [] 
                                 });
                               }} 
                               variant="danger" 
                               className="py-1.5 px-4 text-xs"
                             >
                               –ê—Ç–∞–∫–æ–≤–∞—Ç—å
                             </Button>
                             <div className="text-[10px] text-slate-600 flex gap-2">
                               <span className="text-yellow-500/70">+{enemy.gold} G</span>
                               <span className="text-blue-500/70">+{enemy.exp} XP</span>
                             </div>
                          </div>
                        </div>
                       );
                    })}
                  </div>
                </div>
              )}

              {/* --- TAB: –ö–í–ï–°–¢–´ (–ù–û–í–û–ï) --- */}
              {activeTab === 'quests' && (
                <div className="max-w-3xl mx-auto p-4 md:p-8 space-y-6">
                  <div className="flex items-center justify-between">
                    <div>
                       <h2 className="text-2xl font-bold">–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</h2>
                       <p className="text-slate-400 text-sm">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –∑–æ–ª–æ—Ç–æ –∏ –æ–ø—ã—Ç.</p>
                    </div>
                  </div>

                  {/* –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã */}
                  <div className="space-y-4">
                     <h3 className="text-lg font-bold text-slate-200 border-b border-slate-800 pb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
                     {player.activeQuests && player.activeQuests.length > 0 ? (
                       player.activeQuests.map(quest => (
                         <div key={quest.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <div className="flex justify-between items-start mb-2">
                               <div>
                                 <h4 className="font-bold text-white flex items-center gap-2">
                                   {quest.name}
                                   {quest.isCompleted && <span className="text-green-500 bg-green-900/20 text-xs px-2 py-0.5 rounded border border-green-500/30">–í–´–ü–û–õ–ù–ï–ù–û</span>}
                                 </h4>
                                 <p className="text-slate-400 text-sm mt-1">{quest.desc}</p>
                               </div>
                               {quest.isCompleted ? (
                                  <Button onClick={() => claimQuestReward(quest.id)} variant="gold" className="text-xs">
                                    <Gift size={14} /> –ó–∞–±—Ä–∞—Ç—å {quest.gold} <Coins size={10} />
                                  </Button>
                               ) : (
                                 <div className="text-right text-xs text-slate-500">
                                   <div>–ù–∞–≥—Ä–∞–¥–∞:</div>
                                   <div className="text-yellow-500">{quest.gold} Gold</div>
                                   <div className="text-blue-400">{quest.exp} EXP</div>
                                 </div>
                               )}
                            </div>
                            <div className="mt-4">
                              <div className="flex justify-between text-xs mb-1 text-slate-400 font-semibold">
                                <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                <span>{quest.progress} / {quest.target}</span>
                              </div>
                              <div className="h-2 bg-slate-950 rounded-full overflow-hidden">
                                <div 
                                  className={`h-full transition-all duration-500 ${quest.isCompleted ? 'bg-green-500' : 'bg-blue-500'}`} 
                                  style={{ width: `${(quest.progress / quest.target) * 100}%` }}
                                ></div>
                              </div>
                            </div>
                         </div>
                       ))
                     ) : (
                       <div className="text-center py-8 bg-slate-900/50 rounded-lg text-slate-500 text-sm">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>
                     )}
                  </div>

                  {/* –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–≤–µ—Å—Ç—ã */}
                  <div className="space-y-4 mt-8">
                     <h3 className="text-lg font-bold text-slate-200 border-b border-slate-800 pb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {QUESTS_DB
                          .filter(q => 
                             !player.activeQuests.find(aq => aq.id === q.id) && 
                             !player.completedQuests.includes(q.id) &&
                             player.level >= (q.minLvl || 1)
                          )
                          .map(quest => (
                            <div key={quest.id} className="bg-slate-900 p-4 rounded-xl border border-slate-800 flex flex-col justify-between">
                               <div>
                                 <h4 className="font-bold text-slate-200">{quest.name}</h4>
                                 <p className="text-slate-500 text-xs mt-1 mb-3">{quest.desc}</p>
                                 <div className="flex gap-3 text-xs mb-4">
                                   <span className="flex items-center gap-1 text-yellow-500"><Coins size={12}/> {quest.gold}</span>
                                   <span className="flex items-center gap-1 text-blue-500"><Sparkles size={12}/> {quest.exp}</span>
                                 </div>
                               </div>
                               <Button onClick={() => startQuest(quest.id)} variant="outline" className="w-full text-xs">
                                 –ü—Ä–∏–Ω—è—Ç—å
                               </Button>
                            </div>
                        ))}
                        {QUESTS_DB.filter(q => !player.completedQuests.includes(q.id) && !player.activeQuests.find(aq => aq.id === q.id) && player.level < q.minLvl).length > 0 && (
                          <div className="col-span-full text-center text-slate-600 text-xs py-2">
                             –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è —Å—Ç–∞–Ω—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ.
                          </div>
                        )}
                        {QUESTS_DB.filter(q => !player.completedQuests.includes(q.id) && !player.activeQuests.find(aq => aq.id === q.id) && player.level >= (q.minLvl || 1)).length === 0 && (
                          <div className="col-span-full text-center py-8 text-slate-500">
                            –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!
                          </div>
                        )}
                     </div>
                  </div>
                </div>
              )}

              {/* --- TAB: –í–ê–® –ü–ï–†–°–û–ù–ê–ñ (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) --- */}
              {activeTab === 'character' && (
                <div className="max-w-4xl mx-auto space-y-6 p-4 md:p-8 animate-in fade-in zoom-in duration-300">
                  
                  {/* 1. HERO HEADER */}
                  <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-700 shadow-xl relative overflow-hidden">
                      <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                      
                      <div className="relative z-10 flex flex-col md:flex-row items-center md:items-start gap-8">
                          <div className="flex flex-col items-center">
                              <div className={`w-32 h-32 rounded-2xl flex items-center justify-center border-4 border-slate-600 shadow-2xl bg-slate-800 ${PlayerAvatarColor} relative`}>
                                  <PlayerAvatarIcon size={64} className="text-white drop-shadow-lg" />
                                  <div className="absolute -bottom-3 bg-slate-900 text-xs px-3 py-1 rounded-full border border-slate-600 font-bold">
                                      Lvl {player.level}
                                  </div>
                              </div>
                              <div className="flex gap-1 mt-4">
                                  {player.level >= 5 && <Trophy size={16} className="text-yellow-500" title="–£—Ä–æ–≤–µ–Ω—å 5+" />}
                                  {player.totalKills >= 10 && <Skull size={16} className="text-red-500" title="–£–±–∏–π—Ü–∞" />}
                                  {player.totalSteps >= 100 && <Footprints size={16} className="text-green-500" title="–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫" />}
                                  {player.questsCompletedCount >= 5 && <CheckCircle size={16} className="text-blue-400" title="–ì–µ—Ä–æ–π –∑–∞–¥–∞–Ω–∏–π" />}
                              </div>
                          </div>

                          <div className="flex-1 text-center md:text-left space-y-4 w-full">
                              <div>
                                  <h2 className="text-3xl font-black text-white tracking-tight">{player.name}</h2>
                                  <div className="text-blue-400 font-medium text-sm uppercase tracking-widest">{player.className}</div>
                              </div>

                              <div className="space-y-1">
                                  <div className="flex justify-between text-xs font-bold text-slate-400">
                                      <span>XP Progress</span>
                                      <span>{Math.floor((player.exp / player.maxExp) * 100)}%</span>
                                  </div>
                                  <div className="h-4 bg-slate-950 rounded-full overflow-hidden border border-slate-700/50">
                                      <div className="h-full bg-gradient-to-r from-blue-600 to-cyan-400" style={{ width: `${(player.exp / player.maxExp) * 100}%` }}></div>
                                  </div>
                                  <div className="text-right text-[10px] text-slate-500">{player.exp} / {player.maxExp} XP</div>
                              </div>

                              <div className="grid grid-cols-3 gap-4 mt-4">
                                  <div className="bg-slate-950/50 p-2 rounded-lg border border-slate-700 flex flex-col items-center">
                                      <Heart className="text-red-500 mb-1" size={20} />
                                      <span className="font-bold text-lg">{player.hp}</span>
                                      <span className="text-[10px] text-slate-500 uppercase">HP</span>
                                  </div>
                                  <div className="bg-slate-950/50 p-2 rounded-lg border border-slate-700 flex flex-col items-center">
                                      <Zap className="text-yellow-500 mb-1" size={20} />
                                      <span className="font-bold text-lg">{player.energy}</span>
                                      <span className="text-[10px] text-slate-500 uppercase">Energy</span>
                                  </div>
                                  <div className="bg-slate-950/50 p-2 rounded-lg border border-slate-700 flex flex-col items-center">
                                      <Coins className="text-yellow-400 mb-1" size={20} />
                                      <span className="font-bold text-lg">{player.gold}</span>
                                      <span className="text-[10px] text-slate-500 uppercase">Gold</span>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>

                  {/* 2. STATS & EQUIPMENT GRID */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <Card title="–ë–æ–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã" icon={Dna}>
                          <div className="space-y-3">
                              <StatRow label="–°–∏–ª–∞ –∞—Ç–∞–∫–∏" value={player.str + (player.equipment.weapon?.val || 0)} icon={Sword} color="text-red-400" sub={`–ë–∞–∑–∞: ${player.str}`} />
                              <StatRow label="–ó–∞—â–∏—Ç–∞" value={player.def + (player.equipment.armor?.val || 0)} icon={Shield} color="text-blue-400" sub={`–ë–∞–∑–∞: ${player.def}`} />
                              <div className="h-px bg-slate-800 my-2"></div>
                              <div className="grid grid-cols-2 gap-2">
                                  <div className="bg-slate-900 p-2 rounded border border-slate-800 text-center">
                                      <div className="text-xs text-slate-500 mb-1">–®–∞–Ω—Å –∫—Ä–∏—Ç–∞</div>
                                      <div className="text-yellow-500 font-mono font-bold">{(player.str * 0.5).toFixed(1)}%</div>
                                  </div>
                                  <div className="bg-slate-900 p-2 rounded border border-slate-800 text-center">
                                      <div className="text-xs text-slate-500 mb-1">–£–∫–ª–æ–Ω–µ–Ω–∏–µ</div>
                                      <div className="text-green-500 font-mono font-bold">{(player.def * 0.2 + player.level * 0.1).toFixed(1)}%</div>
                                  </div>
                              </div>
                          </div>
                      </Card>

                      <Card title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" icon={Scroll}>
                           <div className="grid grid-cols-2 gap-4 h-full content-start">
                              <StatBox label="–®–∞–≥–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ" value={player.totalSteps || 0} />
                              <StatBox label="–í—Ä–∞–≥–æ–≤ —É–±–∏—Ç–æ" value={player.totalKills || 0} />
                              <StatBox label="–ö–≤–µ—Å—Ç–æ–≤" value={player.questsCompletedCount || 0} />
                              <StatBox label="–ü—Ä–µ–¥–º–µ—Ç–æ–≤" value={player.inventory.length} />
                           </div>
                      </Card>
                  </div>

                  {/* 3. EQUIPMENT VISUALIZER */}
                  <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                      <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Backpack size={20} className="text-blue-400"/> –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h3>
                      <div className="flex flex-wrap justify-center gap-4">
                          <EquipSlot item={player.equipment.weapon} type="weapon" icon={Sword} />
                          <EquipSlot item={player.equipment.armor} type="armor" icon={Shield} />
                          <EquipSlot type="helmet" icon={Crown} placeholder />
                          <EquipSlot type="boots" icon={Footprints} placeholder />
                          <EquipSlot type="ring" icon={Target} placeholder />
                      </div>
                  </div>
                </div>
              )}

              {/* --- TAB: –ö–û–õ–õ–ï–ö–¶–ò–ò (–ù–û–í–û–ï) --- */}
              {activeTab === 'collections' && (
                <div className="max-w-5xl mx-auto p-4 md:p-8 space-y-6">
                  
                  {/* Top Stats Bar */}
                  <div className="flex justify-between items-center bg-slate-900 p-4 rounded-xl border border-slate-800">
                     <div className="flex items-center gap-3">
                       <div className="bg-slate-800 p-2 rounded-lg">
                         <Coins className="text-yellow-500" />
                       </div>
                       <div>
                         <div className="text-xs text-slate-500 uppercase font-bold">–ò—Ç–æ–≥–æ (–ó–æ–ª–æ—Ç–æ)</div>
                         <div className="text-xl font-bold text-white">{player.gold}</div>
                       </div>
                     </div>
                     <div className="text-right">
                       <div className="text-xs text-slate-500 uppercase font-bold">–°–æ–±—Ä–∞–Ω–æ</div>
                       <div className="text-xl font-bold text-white">
                         {player.collectedAvatars.length} <span className="text-slate-500 text-sm">/ {AVATARS_DB.length}</span>
                       </div>
                     </div>
                  </div>

                  {/* Progress Bar (Chest Progress style) */}
                  <div className="bg-slate-900 p-6 rounded-xl border border-slate-800">
                     <div className="flex justify-between text-sm mb-2 font-bold text-slate-300">
                        <span className="flex items-center gap-2"><Box size={16} className="text-yellow-600"/> –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                        <span>{Math.round((player.collectedAvatars.length / AVATARS_DB.length) * 100)}%</span>
                     </div>
                     <div className="h-4 bg-slate-950 rounded-full overflow-hidden border border-slate-800">
                        <div className="h-full bg-emerald-500 transition-all duration-500" style={{ width: `${(player.collectedAvatars.length / AVATARS_DB.length) * 100}%` }}></div>
                     </div>
                     <div className="mt-4 flex gap-4">
                        <Button onClick={buyAvatarChest} variant="gold" className="text-sm">
                           <Box size={16} /> –ö—É–ø–∏—Ç—å —Å—É–Ω–¥—É–∫ (500 G)
                        </Button>
                        <Button onClick={equipRandomAvatar} variant="outline" className="text-sm">
                           <User size={16} /> –ù–∞–¥–µ—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π
                        </Button>
                     </div>
                  </div>

                  {/* Navigation Tabs (Visual mostly) */}
                  <div className="flex gap-2 overflow-x-auto pb-2 border-b border-slate-800">
                     {['–ê–≤–∞—Ç–∞—Ä—ã', '–ü—Ä–µ–¥–º–µ—Ç—ã', '–°–ø—Ä–∞–π—Ç—ã', '–§–æ–Ω—ã', '–ö–∞—Ä—Ç—ã', 'NPC', '–°–æ–±—ã—Ç–∏—è'].map(tab => (
                       <button 
                         key={tab}
                         onClick={() => setCollectionTab(tab === '–ê–≤–∞—Ç–∞—Ä—ã' ? 'avatars' : 'other')}
                         className={`px-4 py-2 rounded-t-lg text-sm font-bold whitespace-nowrap transition-colors ${
                           (tab === '–ê–≤–∞—Ç–∞—Ä—ã' && collectionTab === 'avatars') || (collectionTab === 'other' && tab !== '–ê–≤–∞—Ç–∞—Ä—ã')
                             ? 'bg-slate-800 text-white border-b-2 border-emerald-500' 
                             : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800/50'
                         }`}
                       >
                         {tab}
                       </button>
                     ))}
                  </div>

                  {/* Content Grid */}
                  {collectionTab === 'avatars' ? (
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                      {AVATARS_DB.map(avatar => {
                        const isCollected = player.collectedAvatars.includes(avatar.id);
                        const isEquipped = player.avatarId === avatar.id;

                        return (
                          <div 
                            key={avatar.id} 
                            className={`
                              relative group rounded-xl p-4 flex flex-col items-center justify-between border-2 transition-all cursor-pointer h-40
                              ${isEquipped 
                                ? 'bg-slate-800 border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.3)]' 
                                : isCollected 
                                  ? 'bg-slate-900 border-slate-700 hover:border-slate-500' 
                                  : 'bg-slate-950 border-slate-800 opacity-50 grayscale'
                              }
                            `}
                            onClick={() => equipAvatar(avatar.id)}
                          >
                             <div className="absolute top-2 right-2 text-slate-600">
                               {isCollected ? <Unlock size={14} /> : <Lock size={14} />}
                             </div>

                             <div className={`w-16 h-16 rounded-lg flex items-center justify-center ${avatar.color} mb-2 shadow-lg`}>
                               <avatar.icon size={32} className="text-white" />
                             </div>
                             
                             <div className="text-center w-full">
                               <div className="font-bold text-xs text-white truncate">{avatar.name}</div>
                               <div className={`text-[10px] uppercase font-bold mt-1 
                                 ${avatar.rarity === 'legendary' ? 'text-orange-500' 
                                 : avatar.rarity === 'epic' ? 'text-purple-500'
                                 : avatar.rarity === 'rare' ? 'text-blue-400'
                                 : avatar.rarity === 'uncommon' ? 'text-green-400'
                                 : 'text-slate-500'}
                               `}>
                                 {avatar.rarity}
                               </div>
                             </div>

                             {isEquipped && (
                               <div className="absolute inset-0 border-2 border-emerald-500 rounded-xl pointer-events-none">
                                  <div className="absolute bottom-2 right-2 bg-emerald-500 text-slate-900 text-[10px] px-2 py-0.5 rounded font-bold">
                                    –í–´–ë–†–ê–ù–û
                                  </div>
                               </div>
                             )}
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="text-center py-20 bg-slate-900 rounded-xl border border-slate-800 border-dashed text-slate-500">
                      <div className="mb-4 flex justify-center"><Folder size={48} className="text-slate-700" /></div>
                      –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ–∫–∞ –ø—É—Å—Ç. –ò—Å—Å–ª–µ–¥—É–π—Ç–µ –º–∏—Ä, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –Ω–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã!
                    </div>
                  )}

                </div>
              )}

              {/* --- TAB: –ì–û–†–û–î (–ú–ê–ì–ê–ó–ò–ù) --- */}
              {activeTab === 'city' && (
                <div className="max-w-3xl mx-auto p-4 md:p-8">
                   <div className="flex items-center justify-between mb-4">
                    <h2 className="text-2xl font-bold">–ì–æ—Ä–æ–¥—Å–∫–æ–π —Ä—ã–Ω–æ–∫</h2>
                    <div className="flex items-center gap-2 text-yellow-500 font-mono bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">
                      <Coins size={16} /> {player.gold}
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {ITEMS_DB.map(item => {
                      const rarityClass = RARITY_COLORS[item.rarity] || RARITY_COLORS.common;
                      const rarityBg = RARITY_BG[item.rarity] || RARITY_BG.common;
                      
                      const tooltipContent = (
                        <div className="text-left max-w-xs">
                          <div className={`font-bold mb-1 ${rarityClass.split(' ')[0]}`}>{item.name}</div>
                          <div className="text-xs text-slate-400 mb-2">
                            {item.type === 'weapon' && `–£—Ä–æ–Ω: +${item.val}`}
                            {item.type === 'armor' && `–ó–∞—â–∏—Ç–∞: +${item.val}`}
                            {item.type === 'consumable' && `–≠—Ñ—Ñ–µ–∫—Ç: ${item.val}`}
                            {item.type === 'resource' && `–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞`}
                          </div>
                          {item.effect && (
                            <div className="text-xs text-purple-400 mb-2 border-t border-slate-700 pt-2">
                              <span className="text-slate-500">–≠—Ñ—Ñ–µ–∫—Ç:</span> {item.effect}
                            </div>
                          )}
                          <div className="text-xs text-slate-500">
                            –†–µ–¥–∫–æ—Å—Ç—å: {item.rarity}
                          </div>
                        </div>
                      );
                      
                      return (
                        <Tooltip key={item.id} content={tooltipContent} position="top">
                          <div className={`${rarityBg} p-4 rounded-xl border-2 ${rarityClass.split(' ')[1]} flex flex-col justify-between hover:scale-105 transition-all duration-200`}>
                            <div>
                              <div className="flex justify-between items-start mb-2">
                                <h4 className={`font-bold ${rarityClass.split(' ')[0]}`}>{item.name}</h4>
                                <span className={`text-xs px-2 py-0.5 rounded ${rarityClass.split(' ')[1]} ${rarityBg}`}>
                                  {item.type}
                                </span>
                              </div>
                              <p className="text-xs text-slate-400 mb-2">
                                {item.type === 'weapon' && `–£—Ä–æ–Ω: ${item.val}`}
                                {item.type === 'armor' && `–ó–∞—â–∏—Ç–∞: ${item.val}`}
                                {item.type === 'consumable' && `–≠—Ñ—Ñ–µ–∫—Ç: ${item.val}`}
                                {item.type === 'resource' && `–ú–∞—Ç–µ—Ä–∏–∞–ª`}
                              </p>
                              {item.effect && (
                                <p className="text-xs text-purple-400 mb-2">
                                  {item.effect}
                                </p>
                              )}
                            </div>
                            <Button 
                              variant="outline" 
                              disabled={player.gold < item.cost}
                              onClick={() => {
                                if(player.gold >= item.cost) {
                                  setPlayer({
                                    ...player,
                                    gold: player.gold - item.cost,
                                    inventory: [...player.inventory, {...item, uid: Date.now()}]
                                  });
                                  addLog(`–í—ã –∫—É–ø–∏–ª–∏ ${item.name}`, 'neutral');
                                  addNotification(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}`, 'success');
                                }
                              }}
                              className="w-full text-xs"
                            >
                              –ö—É–ø–∏—Ç—å ({item.cost} <Coins size={10} />)
                            </Button>
                          </div>
                        </Tooltip>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* --- TAB: –ü–†–û–§–ï–°–°–ò–Ø --- */}
              {activeTab === 'profession' && (
                <div className="max-w-3xl mx-auto p-4 md:p-8">
                  <h2 className="text-2xl font-bold mb-6">–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏</h2>

                  {!player.profession ? (
                    // –í—ã–±–æ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
                    <div>
                      <p className="text-slate-400 mb-6">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º –∏ —Ä–µ—Ü–µ–ø—Ç–∞–º –∫—Ä–∞—Ñ—Ç–∞.</p>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {PROFESSIONS.map(prof => {
                          const isLocked = player.level < prof.unlockLevel;
                          const ProfIcon = prof.icon;
                          
                          return (
                            <div key={prof.id} className={`p-6 rounded-xl border ${isLocked ? 'bg-slate-900/50 border-slate-800 opacity-50' : 'bg-slate-900 border-slate-700 hover:border-slate-600'} transition-all`}>
                              <div className="flex items-start gap-4 mb-4">
                                <div className={`w-14 h-14 rounded-lg ${prof.color} flex items-center justify-center`}>
                                  <ProfIcon size={28} className="text-white" />
                                </div>
                                <div className="flex-1">
                                  <h3 className="font-bold text-lg flex items-center gap-2">
                                    {prof.name}
                                    {isLocked && <Lock size={16} className="text-slate-600" />}
                                  </h3>
                                  <p className="text-xs text-slate-400">{prof.description}</p>
                                </div>
                              </div>
                              {isLocked ? (
                                <div className="text-xs text-slate-500 text-center py-2">
                                  –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å {prof.unlockLevel}
                                </div>
                              ) : (
                                <Button onClick={() => selectProfession(prof.id)} className="w-full">
                                  –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é
                                </Button>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ) : (
                    // –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
                    <div>
                      {(() => {
                        const prof = PROFESSIONS.find(p => p.id === player.profession);
                        if (!prof) return null;
                        const ProfIcon = prof.icon;
                        const progress = (player.professionExp / player.professionMaxExp) * 100;
                        
                        return (
                          <div className="space-y-6">
                            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ */}
                            <div className="bg-slate-900 p-6 rounded-xl border border-slate-700">
                              <div className="flex items-center gap-4 mb-4">
                                <div className={`w-16 h-16 rounded-lg ${prof.color} flex items-center justify-center`}>
                                  <ProfIcon size={32} className="text-white" />
                                </div>
                                <div className="flex-1">
                                  <h3 className="text-xl font-bold">{prof.name}</h3>
                                  <p className="text-sm text-slate-400">–£—Ä–æ–≤–µ–Ω—å {player.professionLevel}</p>
                                </div>
                              </div>
                              
                              {/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */}
                              <div className="mb-2">
                                <div className="flex justify-between text-xs text-slate-400 mb-1">
                                  <span>–û–ø—ã—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</span>
                                  <span>{player.professionExp} / {player.professionMaxExp}</span>
                                </div>
                                <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
                                  <div className="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all" style={{ width: `${progress}%` }}></div>
                                </div>
                              </div>

                              {/* –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è */}
                              <Button 
                                onClick={performProfessionAction} 
                                disabled={player.energy < 5}
                                className="w-full mt-4"
                                variant={player.energy < 5 ? 'outline' : 'primary'}
                              >
                                {player.energy < 5 ? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏' : `–†–∞–±–æ—Ç–∞—Ç—å (5 —ç–Ω–µ—Ä–≥–∏–∏)`}
                              </Button>
                            </div>

                            {/* –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã */}
                            <div>
                              <h3 className="text-lg font-bold mb-3">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã</h3>
                              <div className="grid grid-cols-1 gap-3">
                                {getAvailableRecipes().map(recipe => (
                                  <div key={recipe.id} className="bg-slate-900 p-4 rounded-lg border border-slate-700">
                                    <div className="font-bold mb-2">{recipe.name}</div>
                                    <div className="text-xs text-slate-400 mb-2">
                                      –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å: {recipe.requiredLevel}
                                    </div>
                                    <div className="text-xs text-slate-500">
                                      –°–º–æ—Ç—Ä–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ö—Ä–∞—Ñ—Ç" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
                                    </div>
                                  </div>
                                ))}
                                {getAvailableRecipes().length === 0 && (
                                  <div className="text-center py-8 text-slate-500">
                                    –ü–æ–≤—ã—à–∞–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  )}
                </div>
              )}

              {/* --- TAB: –ö–†–ê–§–¢ --- */}
              {activeTab === 'craft' && (
                <div className="max-w-3xl mx-auto p-4 md:p-8">
                  <h2 className="text-2xl font-bold mb-6">–ö—Ä–∞—Ñ—Ç</h2>

                  {!player.profession ? (
                    <div className="text-center py-20 bg-slate-900 rounded-xl border border-slate-800 border-dashed text-slate-500">
                      <Hammer size={48} className="mx-auto mb-4 text-slate-700" />
                      <p>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü—Ä–æ—Ñ–µ—Å—Å–∏—è"</p>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {getAvailableRecipes().map(recipe => {
                        const canCraftThis = canCraft(recipe);
                        const rarityClass = RARITY_COLORS[recipe.result.rarity] || RARITY_COLORS.common;
                        const rarityBg = RARITY_BG[recipe.result.rarity] || RARITY_BG.common;
                        
                        const tooltipContent = (
                          <div className="text-left max-w-xs">
                            <div className={`font-bold mb-1 ${rarityClass.split(' ')[0]}`}>{recipe.name}</div>
                            <div className="text-xs text-slate-400 mb-2">
                              {recipe.result.type === 'weapon' && `–£—Ä–æ–Ω: ${recipe.result.val}`}
                              {recipe.result.type === 'armor' && `–ó–∞—â–∏—Ç–∞: ${recipe.result.val}`}
                              {recipe.result.type === 'consumable' && `–≠—Ñ—Ñ–µ–∫—Ç: ${recipe.result.val}`}
                            </div>
                            <div className="text-xs text-slate-500 mb-1">
                              –†–µ–¥–∫–æ—Å—Ç—å: {recipe.result.rarity}
                            </div>
                            <div className="text-xs text-slate-500">
                              –û–ø—ã—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏: +{recipe.expReward}
                            </div>
                          </div>
                        );
                        
                        return (
                          <Tooltip key={recipe.id} content={tooltipContent} position="right">
                            <div className={`${rarityBg} p-4 rounded-xl border-2 ${rarityClass.split(' ')[1]} hover:scale-[1.02] transition-all duration-200`}>
                              <div className="flex items-start justify-between mb-3">
                                <div>
                                  <h3 className={`font-bold text-lg ${rarityClass.split(' ')[0]}`}>{recipe.name}</h3>
                                  <p className="text-xs text-slate-400">
                                    {recipe.result.type === 'weapon' && `–£—Ä–æ–Ω: ${recipe.result.val}`}
                                    {recipe.result.type === 'armor' && `–ó–∞—â–∏—Ç–∞: ${recipe.result.val}`}
                                    {recipe.result.type === 'consumable' && `–≠—Ñ—Ñ–µ–∫—Ç: ${recipe.result.val}`}
                                  </p>
                                </div>
                                <span className={`text-xs px-2 py-1 rounded ${rarityClass.split(' ')[1]} ${rarityBg}`}>
                                  {recipe.result.rarity}
                                </span>
                              </div>

                              {/* –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã */}
                              <div className="mb-3">
                                <div className="text-xs text-slate-500 mb-2">–¢—Ä–µ–±—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã:</div>
                                <div className="flex flex-wrap gap-2">
                                  {recipe.ingredients.map(ing => {
                                    const resource = RESOURCES.find(r => r.id === ing.resourceId);
                                    const hasEnough = getResourceCount(ing.resourceId) >= ing.amount;
                                    
                                    return (
                                      <div key={ing.resourceId} className={`text-xs px-2 py-1 rounded ${hasEnough ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`}>
                                        {resource?.name || ing.resourceId}: {getResourceCount(ing.resourceId)}/{ing.amount}
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>

                              <Button 
                                onClick={() => craftItem(recipe)} 
                                disabled={!canCraftThis || isCrafting}
                                className="w-full"
                                variant={canCraftThis && !isCrafting ? 'primary' : 'outline'}
                              >
                                {isCrafting ? '‚öíÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ...' : canCraftThis ? '–°–æ–∑–¥–∞—Ç—å' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤'}
                              </Button>
                            </div>
                          </Tooltip>
                        );
                      })}

                      {getAvailableRecipes().length === 0 && (
                        <div className="text-center py-20 bg-slate-900 rounded-xl border border-slate-800 border-dashed text-slate-500">
                          <p>–ü–æ–≤—ã—à–∞–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã</p>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* --- TAB: –ì–ò–õ–¨–î–ò–ò --- */}
              {activeTab === 'guilds' && (
                <div className="max-w-3xl mx-auto p-4 md:p-8">
                  <h2 className="text-2xl font-bold mb-6">–ì–∏–ª—å–¥–∏–∏</h2>

                  {!player.guildId ? (
                    // –°–ø–∏—Å–æ–∫ –≥–∏–ª—å–¥–∏–π
                    <div>
                      <div className="mb-6 p-4 bg-slate-900 rounded-xl border border-slate-700">
                        <h3 className="font-bold mb-2">–°–æ–∑–¥–∞—Ç—å –≥–∏–ª—å–¥–∏—é</h3>
                        <p className="text-sm text-slate-400 mb-3">–°—Ç–æ–∏–º–æ—Å—Ç—å: 1000 –∑–æ–ª–æ—Ç–∞</p>
                        <Button 
                          onClick={() => {
                            const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–∏–ª—å–¥–∏–∏:');
                            if (name) createGuild(name);
                          }}
                          disabled={player.gold < 1000}
                        >
                          –°–æ–∑–¥–∞—Ç—å –≥–∏–ª—å–¥–∏—é
                        </Button>
                      </div>

                      <h3 className="text-lg font-bold mb-3">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–∏–ª—å–¥–∏–∏</h3>
                      <div className="grid grid-cols-1 gap-4">
                        {GUILDS.map(guild => (
                          <div key={guild.id} className="bg-slate-900 p-4 rounded-xl border border-slate-700 hover:border-slate-600 transition-all">
                            <div className="flex items-start justify-between mb-3">
                              <div>
                                <h4 className="font-bold text-lg">{guild.name}</h4>
                                <p className="text-xs text-slate-400">–£—Ä–æ–≤–µ–Ω—å {guild.level} ‚Ä¢ {guild.memberCount} —á–ª–µ–Ω–æ–≤</p>
                              </div>
                              <Button onClick={() => joinGuild(guild.id)} variant="outline" className="text-xs">
                                –í—Å—Ç—É–ø–∏—Ç—å
                              </Button>
                            </div>
                            <div className="flex gap-4 text-xs text-slate-500">
                              <span className="flex items-center gap-1">
                                <Sparkles size={12} className="text-blue-400" />
                                +{guild.bonuses.expBonus}% –æ–ø—ã—Ç–∞
                              </span>
                              <span className="flex items-center gap-1">
                                <Coins size={12} className="text-yellow-400" />
                                +{guild.bonuses.goldBonus}% –∑–æ–ª–æ—Ç–∞
                              </span>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : (
                    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–∏–ª—å–¥–∏–∏
                    <div>
                      {(() => {
                        const guild = GUILDS.find(g => g.id === player.guildId);
                        if (!guild) return null;

                        return (
                          <div className="space-y-6">
                            <div className="bg-slate-900 p-6 rounded-xl border border-slate-700">
                              <div className="flex items-start justify-between mb-4">
                                <div>
                                  <h3 className="text-xl font-bold">{guild.name}</h3>
                                  <p className="text-sm text-slate-400">
                                    –£—Ä–æ–≤–µ–Ω—å {guild.level} ‚Ä¢ {guild.memberCount} —á–ª–µ–Ω–æ–≤
                                  </p>
                                  <p className="text-xs text-slate-500 mt-1">
                                    –í–∞—à–∞ —Ä–æ–ª—å: {player.guildRole === 'leader' ? '–õ–∏–¥–µ—Ä' : '–ß–ª–µ–Ω'}
                                  </p>
                                </div>
                                <Button onClick={leaveGuild} variant="outline" className="text-xs">
                                  –ü–æ–∫–∏–Ω—É—Ç—å
                                </Button>
                              </div>

                              <div className="grid grid-cols-2 gap-4 mt-4">
                                <div className="bg-slate-800 p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">–ë–æ–Ω—É—Å –æ–ø—ã—Ç–∞</div>
                                  <div className="text-lg font-bold text-blue-400">+{guild.bonuses.expBonus}%</div>
                                </div>
                                <div className="bg-slate-800 p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">–ë–æ–Ω—É—Å –∑–æ–ª–æ—Ç–∞</div>
                                  <div className="text-lg font-bold text-yellow-400">+{guild.bonuses.goldBonus}%</div>
                                </div>
                              </div>
                            </div>

                            <div className="bg-slate-900 p-6 rounded-xl border border-slate-700">
                              <h4 className="font-bold mb-3">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≥–∏–ª—å–¥–∏–∏</h4>
                              <ul className="space-y-2 text-sm text-slate-400">
                                <li className="flex items-center gap-2">
                                  <CheckCircle size={16} className="text-green-500" />
                                  –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è
                                </li>
                                <li className="flex items-center gap-2">
                                  <CheckCircle size={16} className="text-green-500" />
                                  –î–æ—Å—Ç—É–ø –∫ –≥–∏–ª—å–¥–µ–π—Å–∫–∏–º –∫–≤–µ—Å—Ç–∞–º (—Å–∫–æ—Ä–æ)
                                </li>
                                <li className="flex items-center gap-2">
                                  <CheckCircle size={16} className="text-green-500" />
                                  –û–±—â–∏–π —á–∞—Ç –∏ —Ç–æ—Ä–≥–æ–≤–ª—è (—Å–∫–æ—Ä–æ)
                                </li>
                              </ul>
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  )}
                </div>
              )}

              {/* --- TAB: –†–´–ë–ê–õ–ö–ê --- */}
              {activeTab === 'fishing' && (
                <div className="max-w-3xl mx-auto p-4 md:p-8">
                  <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                    üé£ –†—ã–±–∞–ª–∫–∞
                  </h2>

                  {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–æ–∫–∞—Ü–∏–∏ */}
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-6">
                    <h3 className="font-bold mb-2">–¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è</h3>
                    <p className="text-sm text-slate-400">
                      {LOCATIONS.find(l => l.id === player.locationId)?.name}
                    </p>
                    <p className="text-xs text-slate-500 mt-1">
                      {LOCATIONS.find(l => l.id === player.locationId)?.text}
                    </p>
                  </div>

                  {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä—ã–±–∞–ª–∫–∏ */}
                  <div className="grid grid-cols-2 gap-4 mb-6">
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-700">
                      <div className="text-xs text-slate-500 mb-1">–í—Å–µ–≥–æ –ø–æ–π–º–∞–Ω–æ</div>
                      <div className="text-2xl font-bold text-blue-400">
                        {Object.keys(player.resources || {})
                          .filter(key => FISH_DB.find(f => f.id === key))
                          .reduce((sum, key) => sum + (player.resources[key] || 0), 0)}
                      </div>
                    </div>
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-700">
                      <div className="text-xs text-slate-500 mb-1">–°–∞–º–∞—è —Ä–µ–¥–∫–∞—è</div>
                      <div className="text-lg font-bold text-purple-400">
                        {(() => {
                          const caughtFish = Object.keys(player.resources || {})
                            .filter(key => FISH_DB.find(f => f.id === key))
                            .map(key => FISH_DB.find(f => f.id === key))
                            .filter(f => f);
                          
                          const rarityOrder = { legendary: 5, epic: 4, rare: 3, uncommon: 2, common: 1 };
                          const rarest = caughtFish.sort((a, b) => 
                            (rarityOrder[b.rarity] || 0) - (rarityOrder[a.rarity] || 0)
                          )[0];
                          
                          return rarest ? rarest.name : '–ù–µ—Ç';
                        })()}
                      </div>
                    </div>
                  </div>

                  {/* –ú–∏–Ω–∏-–∏–≥—Ä–∞ —Ä—ã–±–∞–ª–∫–∏ */}
                  {fishingState ? (
                    <div className="mb-6 bg-gradient-to-br from-blue-900/30 to-cyan-900/30 p-6 rounded-xl border-2 border-blue-500/50 animate-in fade-in zoom-in duration-300">
                      {fishingState.stage === 'waiting' && (
                        <div className="text-center">
                          <div className="text-6xl mb-4 animate-bounce">üé£</div>
                          <h3 className="text-xl font-bold mb-2">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–∫–ª–µ–≤–∫–∏...</h3>
                          <p className="text-sm text-slate-400 mb-4">–ë—É–¥—å—Ç–µ –≥–æ—Ç–æ–≤—ã –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É!</p>
                          <div className="flex justify-center gap-2 mb-4">
                            <div className="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                            <div className="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style={{ animationDelay: '0.2s' }}></div>
                            <div className="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style={{ animationDelay: '0.4s' }}></div>
                          </div>
                          <Button onClick={cancelFishing} variant="outline" className="text-sm">
                            –û—Ç–º–µ–Ω–∏—Ç—å
                          </Button>
                        </div>
                      )}

                      {fishingState.stage === 'bite' && (
                        <div className="text-center">
                          <div className="text-6xl mb-4 animate-bounce">üêü</div>
                          <h3 className="text-2xl font-bold mb-2 text-yellow-400 animate-pulse">–ü–û–ö–õ–ï–í–ö–ê!</h3>
                          <p className="text-sm text-slate-300 mb-4">–ë—ã—Å—Ç—Ä–æ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!</p>
                          <Button onClick={catchFish} variant="success" className="text-lg py-4 px-8 animate-pulse">
                            ‚ö° –ü–û–ô–ú–ê–¢–¨! ‚ö°
                          </Button>
                        </div>
                      )}

                      {fishingState.stage === 'caught' && fishingState.fish && (
                        <div className="text-center">
                          <div className="text-6xl mb-4">{fishingState.fish.icon}</div>
                          <h3 className="text-2xl font-bold mb-2 text-green-400">–ü–æ–π–º–∞–Ω–æ!</h3>
                          <p className={`text-lg font-bold mb-2 ${RARITY_COLORS[fishingState.fish.rarity].split(' ')[0]}`}>
                            {fishingState.fish.name}
                          </p>
                          <p className="text-sm text-slate-400">
                            –¶–µ–Ω–∞: {fishingState.fish.sellPrice} –∑–æ–ª–æ—Ç–∞
                          </p>
                        </div>
                      )}

                      {fishingState.stage === 'missed' && fishingState.fish && (
                        <div className="text-center">
                          <div className="text-6xl mb-4">üí®</div>
                          <h3 className="text-2xl font-bold mb-2 text-red-400">–£–ø—É—â–µ–Ω–æ!</h3>
                          <p className="text-sm text-slate-400">
                            –†—ã–±–∞ —Å–æ—Ä–≤–∞–ª–∞—Å—å... –≠—Ç–æ –±—ã–ª–∞ {fishingState.fish.name}
                          </p>
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="mb-6">
                      <Button 
                        onClick={startFishing}
                        disabled={player.energy < 5}
                        className="w-full py-4 text-lg"
                        variant="primary"
                      >
                        üé£ –ù–∞—á–∞—Ç—å —Ä—ã–±–∞–ª–∫—É (5 —ç–Ω–µ—Ä–≥–∏–∏)
                      </Button>
                      {player.energy < 5 && (
                        <p className="text-xs text-red-400 mt-2 text-center">
                          –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏
                        </p>
                      )}
                    </div>
                  )}

                  {/* –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä—ã–± –≤ –ª–æ–∫–∞—Ü–∏–∏ */}
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-6">
                    <h3 className="font-bold mb-3">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä—ã–±—ã –≤ —ç—Ç–æ–π –ª–æ–∫–∞—Ü–∏–∏</h3>
                    <div className="grid grid-cols-1 gap-2">
                      {FISH_DB
                        .filter(fish => fish.locations.includes(player.locationId))
                        .map(fish => {
                          const rarityClass = RARITY_COLORS[fish.rarity] || RARITY_COLORS.common;
                          const rarityBg = RARITY_BG[fish.rarity] || RARITY_BG.common;
                          const count = player.resources[fish.id] || 0;
                          
                          return (
                            <div 
                              key={fish.id} 
                              className={`${rarityBg} p-3 rounded-lg border ${rarityClass.split(' ')[1]} flex items-center justify-between`}
                            >
                              <div className="flex items-center gap-3">
                                <span className="text-2xl">{fish.icon}</span>
                                <div>
                                  <div className={`font-bold ${rarityClass.split(' ')[0]}`}>
                                    {fish.name}
                                  </div>
                                  <div className="text-xs text-slate-400">
                                    –¶–µ–Ω–∞: {fish.sellPrice} –∑–æ–ª–æ—Ç–∞
                                  </div>
                                </div>
                              </div>
                              {count > 0 && (
                                <div className="text-sm font-bold text-green-400">
                                  x{count}
                                </div>
                              )}
                            </div>
                          );
                        })}
                    </div>
                  </div>

                  {/* –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Ä—ã–±—ã */}
                  {Object.keys(player.resources || {})
                    .filter(key => FISH_DB.find(f => f.id === key))
                    .length > 0 && (
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-700">
                      <h3 className="font-bold mb-3">–í–∞—à–∞ —Ä—ã–±–∞</h3>
                      <div className="space-y-2">
                        {Object.keys(player.resources || {})
                          .filter(key => FISH_DB.find(f => f.id === key))
                          .map(fishId => {
                            const fish = FISH_DB.find(f => f.id === fishId);
                            if (!fish) return null;
                            
                            const count = player.resources[fishId] || 0;
                            const totalValue = fish.sellPrice * count;
                            const rarityClass = RARITY_COLORS[fish.rarity] || RARITY_COLORS.common;
                            const rarityBg = RARITY_BG[fish.rarity] || RARITY_BG.common;
                            
                            return (
                              <div 
                                key={fishId}
                                className={`${rarityBg} p-3 rounded-lg border ${rarityClass.split(' ')[1]} flex items-center justify-between`}
                              >
                                <div className="flex items-center gap-3">
                                  <span className="text-2xl">{fish.icon}</span>
                                  <div>
                                    <div className={`font-bold ${rarityClass.split(' ')[0]}`}>
                                      {fish.name} x{count}
                                    </div>
                                    <div className="text-xs text-slate-400">
                                      –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {totalValue} –∑–æ–ª–æ—Ç–∞
                                    </div>
                                  </div>
                                </div>
                                <Button
                                  onClick={() => {
                                    // –ü—Ä–æ–¥–∞—Ç—å –≤—Å—é —Ä—ã–±—É —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
                                    setPlayer(prev => {
                                      const newResources = { ...prev.resources };
                                      delete newResources[fishId];
                                      return {
                                        ...prev,
                                        gold: prev.gold + totalValue,
                                        resources: newResources
                                      };
                                    });
                                    addLog(`–í—ã –ø—Ä–æ–¥–∞–ª–∏ ${count}x ${fish.name} –∑–∞ ${totalValue} –∑–æ–ª–æ—Ç–∞!`, 'good');
                                    addNotification(`–ü—Ä–æ–¥–∞–Ω–æ: ${count}x ${fish.name} –∑–∞ ${totalValue} –∑–æ–ª–æ—Ç–∞`, 'success');
                                  }}
                                  variant="gold"
                                  className="text-xs"
                                >
                                  –ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ
                                </Button>
                              </div>
                            );
                          })}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* --- TAB: –î–û–°–¢–ò–ñ–ï–ù–ò–Ø --- */}
              {activeTab === 'achievements' && (
                <div className="max-w-4xl mx-auto p-4 md:p-8">
                  <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                    <Trophy className="text-yellow-400" />
                    –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                  </h2>

                  {/* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π */}
                  <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                    {['all', 'exploration', 'combat', 'crafting', 'quests', 'social', 'collection'].map(cat => (
                      <button
                        key={cat}
                        onClick={() => setAchievementCategory(cat)}
                        className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${
                          achievementCategory === cat
                            ? 'bg-blue-600 text-white'
                            : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                        }`}
                      >
                        {cat === 'all' && '–í—Å–µ'}
                        {cat === 'exploration' && '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'}
                        {cat === 'combat' && '–ë–æ–∏'}
                        {cat === 'crafting' && '–ö—Ä–∞—Ñ—Ç'}
                        {cat === 'quests' && '–ö–≤–µ—Å—Ç—ã'}
                        {cat === 'social' && '–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ'}
                        {cat === 'collection' && '–ö–æ–ª–ª–µ–∫—Ü–∏–∏'}
                      </button>
                    ))}
                  </div>

                  {/* –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {ACHIEVEMENTS
                      .filter(ach => achievementCategory === 'all' || ach.category === achievementCategory)
                      .map(achievement => {
                        const isUnlocked = player.achievements.includes(achievement.id);
                        const isClaimed = isUnlocked && !player.unclaimedAchievements.includes(achievement.id);
                        const progress = calculateAchievementProgress(achievement, player);
                        const AchIcon = achievement.icon;

                        return (
                          <div
                            key={achievement.id}
                            className={`p-4 rounded-xl border-2 transition-all duration-300 ${
                              isUnlocked
                                ? 'bg-gradient-to-br from-yellow-900/20 to-orange-900/20 border-yellow-600/50 hover:border-yellow-500'
                                : 'bg-slate-900 border-slate-700 hover:border-slate-600'
                            }`}
                          >
                            <div className="flex items-start gap-3">
                              <div className={`w-12 h-12 rounded-lg flex items-center justify-center ${
                                isUnlocked ? 'bg-yellow-600' : 'bg-slate-800'
                              }`}>
                                <AchIcon size={24} className={isUnlocked ? 'text-white' : 'text-slate-600'} />
                              </div>
                              <div className="flex-1">
                                <div className="flex items-start justify-between mb-1">
                                  <h3 className={`font-bold ${isUnlocked ? 'text-yellow-400' : 'text-slate-300'}`}>
                                    {achievement.name}
                                  </h3>
                                  {isUnlocked && (
                                    <CheckCircle size={20} className={isClaimed ? 'text-green-500' : 'text-yellow-400'} />
                                  )}
                                </div>
                                <p className="text-xs text-slate-400 mb-2">{achievement.description}</p>
                                
                                {/* –ü—Ä–æ–≥—Ä–µ—Å—Å */}
                                {!isUnlocked && (
                                  <div className="mb-2">
                                    <div className="flex justify-between text-xs text-slate-500 mb-1">
                                      <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                      <span>{progress}%</span>
                                    </div>
                                    <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                      <div 
                                        className="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500"
                                        style={{ width: `${progress}%` }}
                                      ></div>
                                    </div>
                                  </div>
                                )}

                                {/* –ù–∞–≥—Ä–∞–¥—ã */}
                                <div className="flex items-center gap-3 text-xs">
                                  {achievement.reward.gold > 0 && (
                                    <span className="flex items-center gap-1 text-yellow-400">
                                      <Coins size={12} />
                                      {achievement.reward.gold}
                                    </span>
                                  )}
                                  {achievement.reward.exp > 0 && (
                                    <span className="flex items-center gap-1 text-blue-400">
                                      <Sparkles size={12} />
                                      {achievement.reward.exp}
                                    </span>
                                  )}
                                </div>

                                {/* –ö–Ω–æ–ø–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã */}
                                {isUnlocked && !isClaimed && (
                                  <Button
                                    onClick={() => claimAchievementReward(achievement.id)}
                                    className="w-full mt-2 text-xs"
                                    variant="primary"
                                  >
                                    –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É
                                  </Button>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                  </div>

                  {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                  <div className="mt-8 p-6 bg-slate-900 rounded-xl border border-slate-700">
                    <h3 className="font-bold mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="text-center">
                        <div className="text-2xl font-bold text-yellow-400">{player.achievements.length}</div>
                        <div className="text-xs text-slate-500">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
                      </div>
                      <div className="text-center">
                        <div className="text-2xl font-bold text-slate-400">{ACHIEVEMENTS.length}</div>
                        <div className="text-xs text-slate-500">–í—Å–µ–≥–æ</div>
                      </div>
                      <div className="text-center">
                        <div className="text-2xl font-bold text-blue-400">
                          {Math.round((player.achievements.length / ACHIEVEMENTS.length) * 100)}%
                        </div>
                        <div className="text-xs text-slate-500">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                      </div>
                      <div className="text-center">
                        <div className="text-2xl font-bold text-green-400">{player.unclaimedAchievements.length}</div>
                        <div className="text-xs text-slate-500">–ù–µ –ø–æ–ª—É—á–µ–Ω–æ</div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* --- –ó–ê–ì–õ–£–®–ö–ò –î–õ–Ø –ù–û–í–´–• –†–ê–ó–î–ï–õ–û–í --- */}
              {activeTab === 'settings' && (
                <div className="max-w-4xl mx-auto p-4 md:p-8 animate-in fade-in zoom-in duration-300">
                  <Card title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" icon={Settings}>
                    <div className="space-y-6">
                      {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ */}
                      <div className="p-4 bg-slate-900 rounded-lg border border-slate-700">
                        <h3 className="font-bold mb-3 flex items-center gap-2">
                          <Save size={18} className="text-blue-400" />
                          –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã
                        </h3>
                        <div className="space-y-3">
                          <div className="flex justify-between items-center text-sm">
                            <span className="text-slate-400">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:</span>
                            <span className="text-slate-200 font-medium">
                              {lastSaveTime 
                                ? new Date(lastSaveTime).toLocaleString('ru-RU', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit'
                                  })
                                : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
                            </span>
                          </div>
                          <div className="flex justify-between items-center text-sm">
                            <span className="text-slate-400">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:</span>
                            <span className="text-green-400 font-medium">–í–∫–ª—é—á–µ–Ω–æ (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)</span>
                          </div>
                          <Button
                            onClick={() => {
                              if (saveGame(player)) {
                                setLastSaveTime(Date.now());
                                addNotification('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é', 'success');
                              } else {
                                addNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                              }
                            }}
                            variant="primary"
                            className="w-full"
                          >
                            <Save size={18} />
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é
                          </Button>
                        </div>
                      </div>

                      {/* –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç */}
                      <div className="p-4 bg-slate-900 rounded-lg border border-slate-700">
                        <h3 className="font-bold mb-3 flex items-center gap-2">
                          <Download size={18} className="text-purple-400" />
                          –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
                        </h3>
                        <div className="space-y-3">
                          <p className="text-sm text-slate-400 mb-3">
                            –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.
                          </p>
                          <Button
                            onClick={() => {
                              if (exportSave()) {
                                addNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ', 'success');
                              } else {
                                addNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                              }
                            }}
                            variant="purple"
                            className="w-full"
                          >
                            <Download size={18} />
                            –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                          </Button>
                          
                          <div className="relative">
                            <input
                              type="file"
                              accept=".json"
                              onChange={(e) => {
                                const file = e.target.files[0];
                                if (file) {
                                  importSave(
                                    file,
                                    () => {
                                      addNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...', 'success');
                                      setTimeout(() => window.location.reload(), 1500);
                                    },
                                    (error) => {
                                      addNotification(error, 'error');
                                    }
                                  );
                                }
                                e.target.value = ''; // Reset input
                              }}
                              className="hidden"
                              id="import-save-input"
                            />
                            <Button
                              onClick={() => document.getElementById('import-save-input').click()}
                              variant="secondary"
                              className="w-full"
                            >
                              <Upload size={18} />
                              –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                            </Button>
                          </div>
                        </div>
                      </div>

                      {/* –°–±—Ä–æ—Å –∏–≥—Ä—ã */}
                      <div className="p-4 bg-slate-900 rounded-lg border border-red-900/50">
                        <h3 className="font-bold mb-3 flex items-center gap-2 text-red-400">
                          <RotateCcw size={18} />
                          –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞
                        </h3>
                        <div className="space-y-3">
                          <p className="text-sm text-slate-400 mb-3">
                            –°–±—Ä–æ—Å –∏–≥—Ä—ã —É–¥–∞–ª–∏—Ç –≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!
                          </p>
                          <Button
                            onClick={() => {
                              if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ!')) {
                                localStorage.removeItem(SAVE_KEY);
                                addNotification('–ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...', 'info');
                                setTimeout(() => window.location.reload(), 1500);
                              }
                            }}
                            variant="danger"
                            className="w-full"
                          >
                            <RotateCcw size={18} />
                            –°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É
                          </Button>
                        </div>
                      </div>

                      {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏ */}
                      <div className="p-4 bg-slate-900 rounded-lg border border-slate-700">
                        <h3 className="font-bold mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between">
                            <span className="text-slate-400">–í–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:</span>
                            <span className="text-slate-200 font-mono">v2</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">–ü–µ—Ä—Å–æ–Ω–∞–∂:</span>
                            <span className="text-slate-200">{player.name}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">–£—Ä–æ–≤–µ–Ω—å:</span>
                            <span className="text-slate-200">{player.level}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">–ö–ª–∞—Å—Å:</span>
                            <span className="text-slate-200">{player.className}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </Card>
                </div>
              )}

              {['tasks'].includes(activeTab) && (
                <div className="flex flex-col items-center justify-center h-full text-slate-500 mt-20">
                  <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-4">
                     <Hammer size={40} />
                  </div>
                  <h2 className="text-2xl font-bold text-slate-300">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h2>
                  <p>–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö.</p>
                </div>
              )}

            </>
          )}
        </div>
      </main>
    </div>
  );
}